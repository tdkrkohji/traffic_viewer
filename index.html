<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>運行中列車</title>
<style>
  :root {
    --bg:#f7f8fa;
    --fg:#222;
    --table-bg:#fff;
    --table-border:#e6e9ec;
    --th-bg:#fbfdff;
    --notif-bg:#fff3f3;
    --notif-border:#f2c0c0;
    --tokkyu:#d32f2f;
    --kyuko:#388e3c;
    --kaisoku:#1976d2;
    --kukan:#fff176;
    --kakutei:#e0e0e0;
  }

  body.dark {
    --bg:#1e1e1e;
    --fg:#ddd;
    --table-bg:#2a2a2a;
    --table-border:#3a3a3a;
    --th-bg:#333;
    --notif-bg:#2b2b2b;
    --notif-border:#555;
    --kakutei:#555;
  }

  body {
    font-family: "Segoe UI", system-ui, -apple-system, "Helvetica Neue", Arial;
    margin: 0;
    background: var(--bg);
    color: var(--fg);
    font-size: 15px;
    line-height: 1.5;
    transition: background 0.3s, color 0.3s;
  }

  header {
    padding: 16px 12px;
    text-align: center;
    position: relative;
  }

  h1 { margin: 0; font-size: 20px; }

  #themeToggle {
    position: absolute;
    right: 15px;
    top: 15px;
    border: none;
    background: none;
    font-size: 20px;
    cursor: pointer;
    color: var(--fg);
  }

  #meta {
    display: flex;
    gap: 12px;
    justify-content: center;
    align-items: center;
    margin-top: 8px;
    font-size: 13px;
  }

  main { padding: 10px 8px 140px; }

  h2 { margin: 18px 0 8px; font-size: 17px; text-align: center; }

  .table-container { overflow-x: auto; }

  table {
    width: 95%;
    max-width: 1000px;
    margin: 10px auto 24px;
    border-collapse: collapse;
    background: var(--table-bg);
    box-shadow: 0 1px 3px rgba(0,0,0,0.04);
    min-width: 600px;
  }

  th, td {
    padding: 8px 10px;
    border: 1px solid var(--table-border);
    text-align: center;
    font-size: 14px;
    white-space: nowrap;
  }

  th {
    background: var(--th-bg);
    position: sticky;
    top: 0;
    cursor: pointer;
    user-select: none;
  }

  tr:hover td { background: rgba(0,0,0,0.05); }

  .tokkyu { color:#fff; background:var(--tokkyu); }
  .kyuko { color:#fff; background:var(--kyuko); }
  .kaisoku { color:#fff; background:var(--kaisoku); }
  .kukan { color:#000; background:var(--kukan); }
  .kakutei { color:#000; background:var(--kakutei); }

  #notification {
    position: fixed;
    left: 8px; right: 8px; bottom: 8px;
    background: var(--notif-bg);
    border: 1px solid var(--notif-border);
    padding: 10px;
    border-radius: 8px;
    box-shadow: 0 4px 16px rgba(0,0,0,0.06);
    max-height: 180px;
    overflow: auto;
    transition: background 0.3s, color 0.3s;
    font-size: 14px;
  }

  #notification h3 {
    margin: 0 0 8px;
    text-align: center;
    font-size: 15px;
  }

  #notification ul {
    margin: 0;
    padding: 0;
    list-style: none;
  }

  #notification li {
    padding: 4px 6px;
    border-radius: 4px;
    margin-bottom: 4px;
  }

  .notif-delay { background:#ffdfe0; color:#900; }
  .notif-exchange { background:#fff6d6; color:#8a5b00; }

  body.dark .notif-delay { background:#662828; color:#ffbebe; }
  body.dark .notif-exchange { background:#554400; color:#ffeaaa; }

  @media (max-width: 600px) {
    h1 { font-size: 18px; }
    h2 { font-size: 15px; }
    body { font-size: 14px; }
    th, td { font-size: 13px; padding: 6px 8px; }
    #notification { font-size: 13px; padding: 8px; }
  }
</style>
</head>
<body>
<header>
  <h1>運行中列車</h1>
  <button id="themeToggle" title="テーマ切替">🌙</button>
  <div id="meta">
    <div id="updateTime">データ更新中...</div>
    <div id="localTime">現在時刻: --:--:--</div>
  </div>
</header>

<main>
  <h2>京王線・相模原線</h2>
  <div class="table-container">
    <table id="keioTable">
      <thead>
        <tr>
          <th>上下</th><th>列車番号</th><th>行先</th><th>種別</th><th>両数</th>
          <th>現在位置</th><th>番線</th><th>遅れ</th><th>備考</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <h2>井の頭線</h2>
  <div class="table-container">
    <table id="inokTable">
      <thead>
        <tr>
          <th>上下</th><th>列車番号</th><th>行先</th><th>種別</th><th>両数</th>
          <th>現在位置</th><th>番線</th><th>遅れ</th><th>備考</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</main>

<div id="notification">
  <h3>通知</h3>
  <ul id="notifList"></ul>
</div>

<script>
// ====== ダークモード切替 ======
const themeToggle=document.getElementById("themeToggle");
const body=document.body;
if(localStorage.getItem("theme")==="dark"){body.classList.add("dark");themeToggle.textContent="☀️";}
themeToggle.addEventListener("click",()=>{
  const dark=body.classList.toggle("dark");
  themeToggle.textContent=dark?"☀️":"🌙";
  localStorage.setItem("theme",dark?"dark":"light");
});

// ====== 駅データ ======
const idMap={
  001:"京王線新宿",002:"笹塚",003:"代田橋",004:"明大前",005:"下高井戸",006:"桜上水",007:"上北沢",
  008:"八幡山",009:"芦花公園",010:"千歳烏山",011:"仙川",012:"つつじヶ丘",013:"柴崎",014:"国領",
  015:"布田",016:"調布",017:"西調布",018:"飛田給",019:"武蔵野台",020:"多磨霊園",021:"東府中",
  022:"府中",023:"分倍河原",024:"中河原",025:"聖蹟桜ヶ丘",026:"百草園",027:"高幡不動",
  028:"南平",029:"平山城址公園",030:"長沼",031:"北野",032:"京王八王子",044:"京王多摩川",
  045:"京王稲田堤",046:"京王よみうりランド",047:"稲城",048:"若葉台",049:"京王永山",
  050:"京王多摩センター",051:"京王堀之内",052:"南大沢",053:"多摩境",054:"橋本",
  081:"渋谷",082:"神泉",083:"駒場東大前",084:"池ノ上",085:"下北沢",086:"新代田",087:"東松原",
  088:"明大前",089:"永福町",090:"西永福",091:"浜田山",092:"高井戸",093:"富士見ヶ丘",
  094:"久我山",095:"三鷹台",096:"井の頭公園",097:"吉祥寺",
  // 都営新宿線
  101:"新宿三丁目",102:"曙橋",103:"市ヶ谷",104:"九段下",105:"神保町",106:"小川町",
  107:"岩本町",108:"馬喰横山",109:"浜町",110:"森下",111:"菊川",112:"住吉",113:"西大島",
  114:"大島",115:"東大島",116:"船堀",117:"一之江",118:"瑞江",119:"篠崎",120:"本八幡",
  // 方面案内など
  300:"京王線新宿・都営新宿線方面",301:"都営新宿線方面",302:"京王線新宿方面",303:"調布方面",
  304:"高幡不動方面",305:"八幡山方面",306:"笹塚方面",400:"京王八王子方面",401:"高尾山口方面",
  402:"橋本方面",403:"府中・府中競馬正門前方面",501:"明大前・永福町方面",502:"吉祥寺方面"
};

const syMap={
  1:{name:"特急",class:"tokkyu"},2:{name:"急行",class:"kyuko"},
  3:{name:"快速",class:"kaisoku"},5:{name:"区間急行",class:"kukan"},
  6:{name:"各停",class:"kakutei"},9:{name:"ライナー",class:"tokkyu"},
  11:{name:"ライナー",class:"tokkyu"}
};

// ====== ローカル時間更新 ======
function updateLocalTime(){
  const n=new Date();
  const h=String(n.getHours()).padStart(2,"0");
  const m=String(n.getMinutes()).padStart(2,"0");
  const s=String(n.getSeconds()).padStart(2,"0");
  document.getElementById("localTime").textContent=`現在時刻: ${h}:${m}:${s}`;
}
setInterval(updateLocalTime,1000);updateLocalTime();

// ====== データ取得 ======
async function fetchData(){
  try{
    const res=await fetch("https://i.opentidkeio.jp/data/traffic_info.json?cache="+Date.now());
    const data=await res.json();

    const t=data.up?.[0]?.dt?.[0];
    if(t) document.getElementById("updateTime").textContent=`データ最終更新: ${t.yy}/${t.mt}/${t.dy} ${t.hh}:${t.mm}:${t.ss}`;

    const keioBody=document.querySelector("#keioTable tbody");
    const inokBody=document.querySelector("#inokTable tbody");
    keioBody.innerHTML=""; inokBody.innerHTML="";
    const notifList=document.getElementById("notifList");
    notifList.innerHTML="";

    const notifications=[];
    const trainIds=new Map();

    function process(section,tbody){
      section.forEach(st=>{
        st.ps.forEach(p=>{
          const id=st.id;
          const trNo=p.tr.trim();
          const sy=syMap[p.sy]||{name:"不明",class:""};
          const ikCode=parseInt(p.ik_tr);
          const ik=idMap[p.ik_tr.padStart(3,"0")]||"不明";
          const pos=
            id.startsWith("E")?idMap[id.slice(1)]+"駅構内":
            id.startsWith("U")?idMap[(+id.slice(1)+1).toString().padStart(3,"0")]+"〜"+idMap[id.slice(1)]+"間 上り":
            id.startsWith("D")?idMap[id.slice(1)]+"〜"+idMap[(+id.slice(1)-1).toString().padStart(3,"0")]+"間 下り":
            "不明";
          const updown=parseInt(id.slice(1))%2===0?"上り":"下り";
          const delay=parseInt(p.dl)||0;
          const delayText=delay===0?"平常":delay+"分遅れ";
          let remarksList=[];

          if(sy.name==="特急"&&p.sr==="8") remarksList.push("特急（8両編成）");
          if(trainIds.has(trNo)){
            remarksList.push("車両交換予定");
            notifications.push({type:"exchange",text:`${trNo}：車両交換予定`});
          } else trainIds.set(trNo,true);
          if(delay>=15) notifications.push({type:"delay",text:`${trNo}：${delay}分遅れ`});
          if(ikCode>=101&&ikCode<=120) remarksList.push("都営新宿線直通");

          const row=`<tr>
            <td>${updown}</td><td>${trNo}</td>
            <td>${ik}</td><td class="${sy.class}">${sy.name}</td>
            <td>${p.sr}</td><td>${pos}</td><td>${p.bs}</td>
            <td>${delayText}</td><td>${remarksList.join("・")}</td></tr>`;
          tbody.insertAdjacentHTML("beforeend",row);
        });
      });
    }

    if(data.TS) process(data.TS,keioBody);
    if(data.TB) process(data.TB,inokBody);

    notifications.forEach(n=>{
      const li=document.createElement("li");
      li.textContent=n.text;
      li.classList.add(n.type==="delay"?"notif-delay":"notif-exchange");
      notifList.appendChild(li);
    });

  }catch(e){
    document.getElementById("updateTime").textContent="更新失敗："+e.message;
  }
}

fetchData();
setInterval(fetchData,30000);
</script>
</body>
</html>
