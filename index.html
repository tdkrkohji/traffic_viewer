<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>é‹è¡Œä¸­åˆ—è»Š</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  body {
    font-family: "Segoe UI", sans-serif;
    text-align: center;
    background: #f8f8f8;
    color: #222;
    margin: 0;
    padding-bottom: 80px;
  }
  body.dark {
    background: #1f1f1f;
    color: #eee;
  }

  h1 {
    margin: 20px 0;
  }

  .tab-buttons, .sub-buttons {
    display: flex;
    justify-content: center;
    margin: 10px 0;
    flex-wrap: wrap;
  }

  button {
    margin: 4px;
    padding: 6px 14px;
    border: 1px solid #bbb;
    background: #f0f0f0;
    cursor: pointer;
    border-radius: 4px;
  }
  body.dark button {
    background: #333;
    color: #fff;
    border-color: #555;
  }
  button.active {
    background: #1976d2;
    color: #fff;
    border-color: #1976d2;
  }

  table {
    border-collapse: collapse;
    margin: 15px auto;
    width: 95%;
    max-width: 1100px;
    font-size: 14px;
    background: #fff;
  }
  body.dark table {
    background: #2a2a2a;
  }
  th, td {
    border: 1px solid #ccc;
    padding: 6px 8px;
    text-align: center;
  }
  th {
    background: #e0e0e0;
    cursor: pointer;
  }
  body.dark th {
    background: #333;
  }

  .tokkyu { background: #d32f2f; color: #fff; }
  .kyuko { background: #388e3c; color: #fff; }
  .kaisoku { background: #1976d2; color: #fff; }
  .kukan { background: #fff176; color: #000; }
  .kakutei { background: #e0e0e0; color: #000; }

  #updateTime, #localTime {
    font-size: 13px;
    color: #666;
    margin: 4px 0;
  }

  #noticeBox {
    margin: 15px auto;
    padding: 10px;
    width: 90%;
    max-width: 800px;
    background: #ffefef;
    border: 1px solid #d32f2f;
    border-radius: 6px;
    text-align: left;
    font-size: 14px;
  }
  body.dark #noticeBox {
    background: #3a1f1f;
    border-color: #ff5555;
    color: #fff0f0;
  }

  @media (max-width: 768px) {
    table { font-size: 12px; }
    button { padding: 5px 10px; font-size: 13px; }
  }
</style>
</head>
<body>
<h1>é‹è¡Œä¸­åˆ—è»Š</h1>
<p id="updateTime">ãƒ‡ãƒ¼ã‚¿æ›´æ–°ä¸­...</p>
<p id="localTime">ç¾åœ¨æ™‚åˆ»: --:--:--</p>

<div class="tab-buttons">
  <button id="keioTab" class="active">äº¬ç‹ç·šãƒ»ç›¸æ¨¡åŸç·š</button>
  <button id="inokTab">äº•ã®é ­ç·š</button>
</div>

<div class="sub-buttons">
  <button id="upBtn" class="active">ä¸Šã‚Š</button>
  <button id="downBtn">ä¸‹ã‚Š</button>
</div>

<div id="noticeBox">é€šçŸ¥ï¼šè©²å½“ã™ã‚‹åˆ—è»Šã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</div>

<label for="intervalSelect">æ›´æ–°é–“éš”ï¼š</label>
<select id="intervalSelect">
  <option value="10000">10ç§’</option>
  <option value="30000" selected>30ç§’</option>
  <option value="60000">1åˆ†</option>
  <option value="120000">2åˆ†</option>
</select>
<button id="modeToggle">ğŸŒ™ ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰</button>

<table id="mainTable">
  <thead>
    <tr>
      <th data-key="num">åˆ—è»Šç•ªå·</th>
      <th data-key="type">ç¨®åˆ¥</th>
      <th data-key="dir">ä¸Šä¸‹</th>
      <th data-key="pos">ç¾åœ¨ä½ç½®</th>
      <th data-key="dest">è¡Œå…ˆ</th>
      <th data-key="cars">ä¸¡æ•°</th>
      <th data-key="track">ç•ªç·š</th>
      <th data-key="delay">é…ã‚Œ</th>
      <th data-key="note">å‚™è€ƒ</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
const idMap = {
  1:"äº¬ç‹ç·šæ–°å®¿",2:"ç¬¹å¡š",3:"ä»£ç”°æ©‹",4:"æ˜å¤§å‰",5:"ä¸‹é«˜äº•æˆ¸",6:"æ¡œä¸Šæ°´",7:"ä¸ŠåŒ—æ²¢",8:"å…«å¹¡å±±",9:"èŠ¦èŠ±å…¬åœ’",10:"åƒæ­³çƒå±±",11:"ä»™å·",12:"ã¤ã¤ã˜ãƒ¶ä¸˜",13:"æŸ´å´",14:"å›½é ˜",15:"å¸ƒç”°",16:"èª¿å¸ƒ",17:"è¥¿èª¿å¸ƒ",18:"é£›ç”°çµ¦",19:"æ­¦è”µé‡å°",20:"å¤šç£¨éœŠåœ’",21:"æ±åºœä¸­",22:"åºœä¸­",23:"åˆ†å€æ²³åŸ",24:"ä¸­æ²³åŸ",25:"è–è¹Ÿæ¡œãƒ¶ä¸˜",26:"ç™¾è‰åœ’",27:"é«˜å¹¡ä¸å‹•",28:"å—å¹³",29:"å¹³å±±åŸå€å…¬åœ’",30:"é•·æ²¼",31:"åŒ—é‡",32:"äº¬ç‹å…«ç‹å­",44:"äº¬ç‹å¤šæ‘©å·",45:"äº¬ç‹ç¨²ç”°å ¤",46:"äº¬ç‹ã‚ˆã¿ã†ã‚Šãƒ©ãƒ³ãƒ‰",47:"ç¨²åŸ",48:"è‹¥è‘‰å°",49:"äº¬ç‹æ°¸å±±",50:"äº¬ç‹å¤šæ‘©ã‚»ãƒ³ã‚¿ãƒ¼",51:"äº¬ç‹å €ä¹‹å†…",52:"å—å¤§æ²¢",53:"å¤šæ‘©å¢ƒ",54:"æ©‹æœ¬",
  81:"æ¸‹è°·",82:"ç¥æ³‰",83:"é§’å ´æ±å¤§å‰",84:"æ± ãƒä¸Š",85:"ä¸‹åŒ—æ²¢",86:"æ–°ä»£ç”°",87:"æ±æ¾åŸ",88:"æ˜å¤§å‰",89:"æ°¸ç¦ç”º",90:"è¥¿æ°¸ç¦",91:"æµœç”°å±±",92:"é«˜äº•æˆ¸",93:"å¯Œå£«è¦‹ãƒ¶ä¸˜",94:"ä¹…æˆ‘å±±",95:"ä¸‰é·¹å°",96:"äº•ã®é ­å…¬åœ’",97:"å‰ç¥¥å¯º",
  101:"æ–°å®¿ä¸‰ä¸ç›®",102:"æ›™æ©‹",103:"å¸‚ãƒ¶è°·",104:"ä¹æ®µä¸‹",105:"ç¥ä¿ç”º",106:"å°å·ç”º",107:"å²©æœ¬ç”º",108:"é¦¬å–°æ¨ªå±±",109:"æµœç”º",110:"æ£®ä¸‹",111:"èŠå·",112:"ä½å‰",113:"è¥¿å¤§å³¶",114:"å¤§å³¶",115:"æ±å¤§å³¶",116:"èˆ¹å €",117:"ä¸€ä¹‹æ±Ÿ",118:"ç‘æ±Ÿ",119:"ç¯ å´",120:"æœ¬å…«å¹¡",
  300:"äº¬ç‹ç·šæ–°å®¿ãƒ»éƒ½å–¶æ–°å®¿ç·šæ–¹é¢",301:"éƒ½å–¶æ–°å®¿ç·šæ–¹é¢",302:"äº¬ç‹ç·šæ–°å®¿æ–¹é¢",303:"èª¿å¸ƒæ–¹é¢",304:"é«˜å¹¡ä¸å‹•æ–¹é¢",305:"å…«å¹¡å±±æ–¹é¢",306:"ç¬¹å¡šæ–¹é¢",400:"äº¬ç‹å…«ç‹å­æ–¹é¢",401:"é«˜å°¾å±±å£æ–¹é¢",402:"æ©‹æœ¬æ–¹é¢",403:"åºœä¸­ãƒ»åºœä¸­ç«¶é¦¬æ­£é–€å‰æ–¹é¢",501:"æ˜å¤§å‰ãƒ»æ°¸ç¦ç”ºæ–¹é¢",502:"å‰ç¥¥å¯ºæ–¹é¢"
};

const syMap = {
  1:{name:"ç‰¹æ€¥",class:"tokkyu"},
  2:{name:"æ€¥è¡Œ",class:"kyuko"},
  3:{name:"å¿«é€Ÿ",class:"kaisoku"},
  5:{name:"åŒºé–“æ€¥è¡Œ",class:"kukan"},
  6:{name:"å„åœ",class:"kakutei"},
  9:{name:"ãƒ©ã‚¤ãƒŠãƒ¼",class:"tokkyu"},
  11:{name:"ãƒ©ã‚¤ãƒŠãƒ¼",class:"tokkyu"}
};

let currentLine = "keio", currentDir = "up", refreshTimer;

function updateLocalTime(){
  const now = new Date();
  document.getElementById("localTime").textContent =
    `ç¾åœ¨æ™‚åˆ»: ${now.getHours().toString().padStart(2,"0")}:${now.getMinutes().toString().padStart(2,"0")}:${now.getSeconds().toString().padStart(2,"0")}`;
}

async function fetchData(){
  try{
    const res = await fetch("https://i.opentidkeio.jp/data/traffic_info.json?cache="+Date.now());
    const data = await res.json();
    const t = data.up?.[0]?.dt?.[0];
    if(t){
      document.getElementById("updateTime").textContent = 
      `ãƒ‡ãƒ¼ã‚¿æœ€çµ‚æ›´æ–°: ${t.yy}/${t.mt}/${t.dy} ${t.hh}:${t.mm}:${t.ss}`;
    }

    const tableBody = document.querySelector("#mainTable tbody");
    tableBody.innerHTML = "";

    const trains = [];
    const sections = currentLine==="keio"?data.TS:data.TB;
    if(!sections) return;

    sections.forEach(sec=>{
      sec.ps.forEach(p=>{
        const id=sec.id;
        const trNo=p.tr.trim();
        const dir=parseInt(id.slice(1))%2===0?"ä¸Šã‚Š":"ä¸‹ã‚Š";
        if((currentDir==="up" && dir!=="ä¸Šã‚Š")||(currentDir==="down"&&dir!=="ä¸‹ã‚Š"))return;
        const sy=syMap[p.sy]||{name:"ä¸æ˜",class:""};
        const pos=id.startsWith("E")?idMap[id.slice(1)]+"é§…æ§‹å†…":
          id.startsWith("U")?idMap[(+id.slice(1)+1).toString().padStart(3,"0")*1]+"ã€œ"+idMap[id.slice(1)]+"é–“ ä¸Šã‚Š":
          id.startsWith("D")?idMap[id.slice(1)]+"ã€œ"+idMap[(+id.slice(1)-1).toString().padStart(3,"0")*1]+"é–“ ä¸‹ã‚Š":"ä¸æ˜";
        const dest=idMap[p.ik_tr.padStart(3,"0")*1]||"ä¸æ˜";
        const delay=p.dl==="00"?"å¹³å¸¸":p.dl+"åˆ†é…ã‚Œ";
        let note="";
        if(dest>=101&&dest<=120) note+="éƒ½å–¶æ–°å®¿ç·šç›´é€š ";
        if(sy.name==="ç‰¹æ€¥"&&p.sr==="8") note+="ç‰¹æ€¥ï¼ˆ8ä¸¡ç·¨æˆï¼‰";
        trains.push({num:trNo,type:sy.name,typeClass:sy.class,dir,pos,dest,cars:p.sr,track:p.bs,delay,note});
      });
    });

    const nums=trains.map(t=>t.num);
    nums.forEach(n=>{
      if(nums.filter(x=>x===n).length>1)
        trains.filter(t=>t.num===n).forEach(t=>t.note+=" è»Šä¸¡äº¤æ›äºˆå®š");
    });

    const notices=trains.filter(t=>t.delay!=="å¹³å¸¸"&&parseInt(t.delay)||0>=15)
      .map(t=>`[${t.num}] ${t.delay}`);
    const exchanges=trains.filter(t=>t.note.includes("è»Šä¸¡äº¤æ›äºˆå®š"))
      .map(t=>`[${t.num}] è»Šä¸¡äº¤æ›äºˆå®š`);
    const allNotices=[...notices,...exchanges];
    document.getElementById("noticeBox").textContent=allNotices.length?
      "é€šçŸ¥ï¼š" + allNotices.join(" ï¼ "):"é€šçŸ¥ï¼šè©²å½“ã™ã‚‹åˆ—è»Šã¯ã‚ã‚Šã¾ã›ã‚“ã€‚";

    trains.forEach(tr=>{
      const row=document.createElement("tr");
      row.innerHTML=`
        <td>${tr.num}</td>
        <td class="${tr.typeClass}">${tr.type}</td>
        <td>${tr.dir}</td>
        <td>${tr.pos}</td>
        <td>${tr.dest}</td>
        <td>${tr.cars}</td>
        <td>${tr.track}</td>
        <td>${tr.delay}</td>
        <td>${tr.note}</td>`;
      tableBody.appendChild(row);
    });
  }catch(e){
    document.getElementById("updateTime").textContent="æ›´æ–°å¤±æ•—ï¼š"+e.message;
  }
}

document.querySelectorAll("th").forEach(th=>{
  th.addEventListener("click",()=>{
    const key=th.dataset.key;
    const tbody=document.querySelector("#mainTable tbody");
    const rows=Array.from(tbody.rows);
    const asc=!th.classList.contains("asc");
    document.querySelectorAll("th").forEach(h=>h.classList.remove("asc","desc"));
    th.classList.add(asc?"asc":"desc");
    rows.sort((a,b)=>{
      const A=a.cells[th.cellIndex].textContent.trim();
      const B=b.cells[th.cellIndex].textContent.trim();
      return asc?A.localeCompare(B,"ja"):-A.localeCompare(B,"ja");
    });
    rows.forEach(r=>tbody.appendChild(r));
  });
});

function switchTab(tab){
  document.getElementById("keioTab").classList.remove("active");
  document.getElementById("inokTab").classList.remove("active");
  tab.classList.add("active");
  currentLine=tab.id==="keioTab"?"keio":"inok";
  fetchData();
}
function switchDir(btn){
  document.getElementById("upBtn").classList.remove("active");
  document.getElementById("downBtn").classList.remove("active");
  btn.classList.add("active");
  currentDir=btn.id==="upBtn"?"up":"down";
  fetchData();
}
document.getElementById("keioTab").onclick=()=>switchTab(keioTab);
document.getElementById("inokTab").onclick=()=>switchTab(inokTab);
document.getElementById("upBtn").onclick=()=>switchDir(upBtn);
document.getElementById("downBtn").onclick=()=>switchDir(downBtn);

document.getElementById("intervalSelect").addEventListener("change",e=>{
  clearInterval(refreshTimer);
  refreshTimer=setInterval(fetchData,e.target.value);
});

document.getElementById("modeToggle").addEventListener("click",()=>{
  document.body.classList.toggle("dark");
});

setInterval(updateLocalTime,1000);
updateLocalTime();
fetchData();
refreshTimer=setInterval(fetchData,30000);
</script>
</body>
</html>
