<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>é‹è¡Œä¸­åˆ—è»Š</title>
<style>
  :root {
    --bg:#f7f8fa;
    --fg:#222;
    --table-bg:#fff;
    --table-border:#e6e9ec;
    --th-bg:#fbfdff;
    --notif-bg:#fff3f3;
    --notif-border:#f2c0c0;
    --tokkyu:#d32f2f;
    --kyuko:#388e3c;
    --kaisoku:#1976d2;
    --kukan:#fff176;
    --kakutei:#e0e0e0;
  }

  body.dark {
    --bg:#1e1e1e;
    --fg:#ddd;
    --table-bg:#2a2a2a;
    --table-border:#3a3a3a;
    --th-bg:#333;
    --notif-bg:#2b2b2b;
    --notif-border:#555;
    --kakutei:#555;
  }

  body {
    font-family: "Segoe UI", system-ui, -apple-system, "Helvetica Neue", Arial;
    margin: 0;
    background: var(--bg);
    color: var(--fg);
    font-size: 15px;
    line-height: 1.5;
    transition: background 0.3s, color 0.3s;
  }

  header {
    padding: 16px 12px;
    text-align: center;
    position: relative;
  }

  h1 { margin: 0; font-size: 20px; }

  #themeToggle {
    position: absolute;
    right: 15px;
    top: 15px;
    border: none;
    background: none;
    font-size: 20px;
    cursor: pointer;
    color: var(--fg);
  }

  #meta {
    display: flex;
    gap: 12px;
    justify-content: center;
    align-items: center;
    margin-top: 8px;
    font-size: 13px;
  }

  main { padding: 10px 8px 140px; }

  h2 { margin: 18px 0 8px; font-size: 17px; text-align: center; }

  .table-container { overflow-x: auto; }

  table {
    width: 95%;
    max-width: 1000px;
    margin: 10px auto 24px;
    border-collapse: collapse;
    background: var(--table-bg);
    box-shadow: 0 1px 3px rgba(0,0,0,0.04);
    min-width: 600px;
  }

  th, td {
    padding: 8px 10px;
    border: 1px solid var(--table-border);
    text-align: center;
    font-size: 14px;
    white-space: nowrap;
  }

  th {
    background: var(--th-bg);
    position: sticky;
    top: 0;
    cursor: pointer;
    user-select: none;
  }

  tr:hover td { background: rgba(0,0,0,0.05); }

  .tokkyu { color:#fff; background:var(--tokkyu); }
  .kyuko { color:#fff; background:var(--kyuko); }
  .kaisoku { color:#fff; background:var(--kaisoku); }
  .kukan { color:#000; background:var(--kukan); }
  .kakutei { color:#000; background:var(--kakutei); }

  #notification {
    position: fixed;
    left: 8px; right: 8px; bottom: 8px;
    background: var(--notif-bg);
    border: 1px solid var(--notif-border);
    padding: 10px;
    border-radius: 8px;
    box-shadow: 0 4px 16px rgba(0,0,0,0.06);
    max-height: 180px;
    overflow: auto;
    transition: background 0.3s, color 0.3s;
    font-size: 14px;
  }

  #notification h3 {
    margin: 0 0 8px;
    text-align: center;
    font-size: 15px;
  }

  #notification ul {
    margin: 0;
    padding: 0;
    list-style: none;
  }

  #notification li {
    padding: 4px 6px;
    border-radius: 4px;
    margin-bottom: 4px;
  }

  .notif-delay { background:#ffdfe0; color:#900; }
  .notif-exchange { background:#fff6d6; color:#8a5b00; }

  body.dark .notif-delay { background:#662828; color:#ffbebe; }
  body.dark .notif-exchange { background:#554400; color:#ffeaaa; }

  @media (max-width: 600px) {
    h1 { font-size: 18px; }
    h2 { font-size: 15px; }
    body { font-size: 14px; }
    th, td { font-size: 13px; padding: 6px 8px; }
    #notification { font-size: 13px; padding: 8px; }
  }
</style>
</head>
<body>
<header>
  <h1>é‹è¡Œä¸­åˆ—è»Š</h1>
  <button id="themeToggle" title="ãƒ†ãƒ¼ãƒåˆ‡æ›¿">ğŸŒ™</button>
  <div id="meta">
    <div id="updateTime">ãƒ‡ãƒ¼ã‚¿æ›´æ–°ä¸­...</div>
    <div id="localTime">ç¾åœ¨æ™‚åˆ»: --:--:--</div>
  </div>
</header>

<main>
  <h2>äº¬ç‹ç·šãƒ»ç›¸æ¨¡åŸç·š</h2>
  <div class="table-container">
    <table id="keioTable">
      <thead>
        <tr>
          <th>ä¸Šä¸‹</th><th>åˆ—è»Šç•ªå·</th><th>è¡Œå…ˆ</th><th>ç¨®åˆ¥</th><th>ä¸¡æ•°</th>
          <th>ç¾åœ¨ä½ç½®</th><th>ç•ªç·š</th><th>é…ã‚Œ</th><th>å‚™è€ƒ</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <h2>äº•ã®é ­ç·š</h2>
  <div class="table-container">
    <table id="inokTable">
      <thead>
        <tr>
          <th>ä¸Šä¸‹</th><th>åˆ—è»Šç•ªå·</th><th>è¡Œå…ˆ</th><th>ç¨®åˆ¥</th><th>ä¸¡æ•°</th>
          <th>ç¾åœ¨ä½ç½®</th><th>ç•ªç·š</th><th>é…ã‚Œ</th><th>å‚™è€ƒ</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</main>

<div id="notification">
  <h3>é€šçŸ¥</h3>
  <ul id="notifList"></ul>
</div>

<script>
// ====== ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ ======
const themeToggle=document.getElementById("themeToggle");
const body=document.body;
if(localStorage.getItem("theme")==="dark"){body.classList.add("dark");themeToggle.textContent="â˜€ï¸";}
themeToggle.addEventListener("click",()=>{
  const dark=body.classList.toggle("dark");
  themeToggle.textContent=dark?"â˜€ï¸":"ğŸŒ™";
  localStorage.setItem("theme",dark?"dark":"light");
});

// ====== é§…ãƒ‡ãƒ¼ã‚¿ ======
const idMap={
  001:"äº¬ç‹ç·šæ–°å®¿",002:"ç¬¹å¡š",003:"ä»£ç”°æ©‹",004:"æ˜å¤§å‰",005:"ä¸‹é«˜äº•æˆ¸",006:"æ¡œä¸Šæ°´",007:"ä¸ŠåŒ—æ²¢",
  008:"å…«å¹¡å±±",009:"èŠ¦èŠ±å…¬åœ’",010:"åƒæ­³çƒå±±",011:"ä»™å·",012:"ã¤ã¤ã˜ãƒ¶ä¸˜",013:"æŸ´å´",014:"å›½é ˜",
  015:"å¸ƒç”°",016:"èª¿å¸ƒ",017:"è¥¿èª¿å¸ƒ",018:"é£›ç”°çµ¦",019:"æ­¦è”µé‡å°",020:"å¤šç£¨éœŠåœ’",021:"æ±åºœä¸­",
  022:"åºœä¸­",023:"åˆ†å€æ²³åŸ",024:"ä¸­æ²³åŸ",025:"è–è¹Ÿæ¡œãƒ¶ä¸˜",026:"ç™¾è‰åœ’",027:"é«˜å¹¡ä¸å‹•",
  028:"å—å¹³",029:"å¹³å±±åŸå€å…¬åœ’",030:"é•·æ²¼",031:"åŒ—é‡",032:"äº¬ç‹å…«ç‹å­",044:"äº¬ç‹å¤šæ‘©å·",
  045:"äº¬ç‹ç¨²ç”°å ¤",046:"äº¬ç‹ã‚ˆã¿ã†ã‚Šãƒ©ãƒ³ãƒ‰",047:"ç¨²åŸ",048:"è‹¥è‘‰å°",049:"äº¬ç‹æ°¸å±±",
  050:"äº¬ç‹å¤šæ‘©ã‚»ãƒ³ã‚¿ãƒ¼",051:"äº¬ç‹å €ä¹‹å†…",052:"å—å¤§æ²¢",053:"å¤šæ‘©å¢ƒ",054:"æ©‹æœ¬",
  081:"æ¸‹è°·",082:"ç¥æ³‰",083:"é§’å ´æ±å¤§å‰",084:"æ± ãƒä¸Š",085:"ä¸‹åŒ—æ²¢",086:"æ–°ä»£ç”°",087:"æ±æ¾åŸ",
  088:"æ˜å¤§å‰",089:"æ°¸ç¦ç”º",090:"è¥¿æ°¸ç¦",091:"æµœç”°å±±",092:"é«˜äº•æˆ¸",093:"å¯Œå£«è¦‹ãƒ¶ä¸˜",
  094:"ä¹…æˆ‘å±±",095:"ä¸‰é·¹å°",096:"äº•ã®é ­å…¬åœ’",097:"å‰ç¥¥å¯º",
  // éƒ½å–¶æ–°å®¿ç·š
  101:"æ–°å®¿ä¸‰ä¸ç›®",102:"æ›™æ©‹",103:"å¸‚ãƒ¶è°·",104:"ä¹æ®µä¸‹",105:"ç¥ä¿ç”º",106:"å°å·ç”º",
  107:"å²©æœ¬ç”º",108:"é¦¬å–°æ¨ªå±±",109:"æµœç”º",110:"æ£®ä¸‹",111:"èŠå·",112:"ä½å‰",113:"è¥¿å¤§å³¶",
  114:"å¤§å³¶",115:"æ±å¤§å³¶",116:"èˆ¹å €",117:"ä¸€ä¹‹æ±Ÿ",118:"ç‘æ±Ÿ",119:"ç¯ å´",120:"æœ¬å…«å¹¡",
  // æ–¹é¢æ¡ˆå†…ãªã©
  300:"äº¬ç‹ç·šæ–°å®¿ãƒ»éƒ½å–¶æ–°å®¿ç·šæ–¹é¢",301:"éƒ½å–¶æ–°å®¿ç·šæ–¹é¢",302:"äº¬ç‹ç·šæ–°å®¿æ–¹é¢",303:"èª¿å¸ƒæ–¹é¢",
  304:"é«˜å¹¡ä¸å‹•æ–¹é¢",305:"å…«å¹¡å±±æ–¹é¢",306:"ç¬¹å¡šæ–¹é¢",400:"äº¬ç‹å…«ç‹å­æ–¹é¢",401:"é«˜å°¾å±±å£æ–¹é¢",
  402:"æ©‹æœ¬æ–¹é¢",403:"åºœä¸­ãƒ»åºœä¸­ç«¶é¦¬æ­£é–€å‰æ–¹é¢",501:"æ˜å¤§å‰ãƒ»æ°¸ç¦ç”ºæ–¹é¢",502:"å‰ç¥¥å¯ºæ–¹é¢"
};

const syMap={
  1:{name:"ç‰¹æ€¥",class:"tokkyu"},2:{name:"æ€¥è¡Œ",class:"kyuko"},
  3:{name:"å¿«é€Ÿ",class:"kaisoku"},5:{name:"åŒºé–“æ€¥è¡Œ",class:"kukan"},
  6:{name:"å„åœ",class:"kakutei"},9:{name:"ãƒ©ã‚¤ãƒŠãƒ¼",class:"tokkyu"},
  11:{name:"ãƒ©ã‚¤ãƒŠãƒ¼",class:"tokkyu"}
};

// ====== ãƒ­ãƒ¼ã‚«ãƒ«æ™‚é–“æ›´æ–° ======
function updateLocalTime(){
  const n=new Date();
  const h=String(n.getHours()).padStart(2,"0");
  const m=String(n.getMinutes()).padStart(2,"0");
  const s=String(n.getSeconds()).padStart(2,"0");
  document.getElementById("localTime").textContent=`ç¾åœ¨æ™‚åˆ»: ${h}:${m}:${s}`;
}
setInterval(updateLocalTime,1000);updateLocalTime();

// ====== ãƒ‡ãƒ¼ã‚¿å–å¾— ======
async function fetchData(){
  try{
    const res=await fetch("https://i.opentidkeio.jp/data/traffic_info.json?cache="+Date.now());
    const data=await res.json();

    const t=data.up?.[0]?.dt?.[0];
    if(t) document.getElementById("updateTime").textContent=`ãƒ‡ãƒ¼ã‚¿æœ€çµ‚æ›´æ–°: ${t.yy}/${t.mt}/${t.dy} ${t.hh}:${t.mm}:${t.ss}`;

    const keioBody=document.querySelector("#keioTable tbody");
    const inokBody=document.querySelector("#inokTable tbody");
    keioBody.innerHTML=""; inokBody.innerHTML="";
    const notifList=document.getElementById("notifList");
    notifList.innerHTML="";

    const notifications=[];
    const trainIds=new Map();

    function process(section,tbody){
      section.forEach(st=>{
        st.ps.forEach(p=>{
          const id=st.id;
          const trNo=p.tr.trim();
          const sy=syMap[p.sy]||{name:"ä¸æ˜",class:""};
          const ikCode=parseInt(p.ik_tr);
          const ik=idMap[p.ik_tr.padStart(3,"0")]||"ä¸æ˜";
          const pos=
            id.startsWith("E")?idMap[id.slice(1)]+"é§…æ§‹å†…":
            id.startsWith("U")?idMap[(+id.slice(1)+1).toString().padStart(3,"0")]+"ã€œ"+idMap[id.slice(1)]+"é–“ ä¸Šã‚Š":
            id.startsWith("D")?idMap[id.slice(1)]+"ã€œ"+idMap[(+id.slice(1)-1).toString().padStart(3,"0")]+"é–“ ä¸‹ã‚Š":
            "ä¸æ˜";
          const updown=parseInt(id.slice(1))%2===0?"ä¸Šã‚Š":"ä¸‹ã‚Š";
          const delay=parseInt(p.dl)||0;
          const delayText=delay===0?"å¹³å¸¸":delay+"åˆ†é…ã‚Œ";
          let remarksList=[];

          if(sy.name==="ç‰¹æ€¥"&&p.sr==="8") remarksList.push("ç‰¹æ€¥ï¼ˆ8ä¸¡ç·¨æˆï¼‰");
          if(trainIds.has(trNo)){
            remarksList.push("è»Šä¸¡äº¤æ›äºˆå®š");
            notifications.push({type:"exchange",text:`${trNo}ï¼šè»Šä¸¡äº¤æ›äºˆå®š`});
          } else trainIds.set(trNo,true);
          if(delay>=15) notifications.push({type:"delay",text:`${trNo}ï¼š${delay}åˆ†é…ã‚Œ`});
          if(ikCode>=101&&ikCode<=120) remarksList.push("éƒ½å–¶æ–°å®¿ç·šç›´é€š");

          const row=`<tr>
            <td>${updown}</td><td>${trNo}</td>
            <td>${ik}</td><td class="${sy.class}">${sy.name}</td>
            <td>${p.sr}</td><td>${pos}</td><td>${p.bs}</td>
            <td>${delayText}</td><td>${remarksList.join("ãƒ»")}</td></tr>`;
          tbody.insertAdjacentHTML("beforeend",row);
        });
      });
    }

    if(data.TS) process(data.TS,keioBody);
    if(data.TB) process(data.TB,inokBody);

    notifications.forEach(n=>{
      const li=document.createElement("li");
      li.textContent=n.text;
      li.classList.add(n.type==="delay"?"notif-delay":"notif-exchange");
      notifList.appendChild(li);
    });

  }catch(e){
    document.getElementById("updateTime").textContent="æ›´æ–°å¤±æ•—ï¼š"+e.message;
  }
}

fetchData();
setInterval(fetchData,30000);
</script>
</body>
</html>
