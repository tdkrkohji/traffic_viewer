<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>äº¬ç‹ç·šãƒ»äº•ã®é ­ç·š åœ¨ç·šçŠ¶æ³</title>
<style>
  :root{
    --tokkyu:#d32f2f; /* èµ¤ */
    --kyuko:#388e3c;  /* ç·‘ */
    --kaisoku:#1976d2;/* é’ */
    --kukan:#fff176;  /* é»„ */
    --kakutei:#e0e0e0;/* ç° */
    --accent:#1976d2;
  }
  body{font-family:Segoe UI,system-ui,-apple-system,"Helvetica Neue",Arial;margin:0;background:#f7f8fa;color:#222}
  header{padding:18px 12px;text-align:center}
  h1{margin:0;font-size:20px}
  #meta{display:flex;gap:12px;justify-content:center;align-items:center;margin-top:8px}
  #updateTime,#localTime{color:#555;font-size:13px}
  main{padding:10px 8px 140px}
  h2{margin:18px 0 8px;font-size:16px}
  .tab-buttons{display:flex;justify-content:center;border-bottom:2px solid #e3e6ea;margin:0 auto 10px;max-width:1000px}
  .tab-buttons button{flex:1;border:0;background:none;padding:10px 8px;font-size:15px;cursor:pointer;border-bottom:3px solid transparent;transition:.15s}
  .tab-buttons button:hover{background:#f3f5f7}
  .tab-buttons button.active{border-bottom:3px solid var(--accent);color:var(--accent);font-weight:600}
  table{width:95%;max-width:1000px;margin:10px auto 24px;border-collapse:collapse;background:#fff;box-shadow:0 1px 3px rgba(0,0,0,0.04)}
  th,td{padding:8px 10px;border:1px solid #e6e9ec;text-align:center;font-size:14px}
  th{background:#fbfdff;position:sticky;top:0}
  tr:hover td{background:#fbfbfb}
  .tokkyu{color:#fff;background:var(--tokkyu)}
  .kyuko{color:#fff;background:var(--kyuko)}
  .kaisoku{color:#fff;background:var(--kaisoku)}
  .kukan{color:#000;background:var(--kukan)}
  .kakutei{color:#000;background:var(--kakutei)}
  /* notification bottom */
  #notification{position:fixed;left:8px;right:8px;bottom:8px;background:#fff3f3;border:1px solid #f2c0c0;padding:10px;border-radius:8px;box-shadow:0 4px 16px rgba(0,0,0,0.06);max-height:160px;overflow:auto}
  #notification h3{margin:0 0 8px;color:#b71c1c;text-align:center}
  #notification ul{margin:0;padding:0;list-style:none}
  #notification li{padding:4px 6px;border-radius:4px;margin-bottom:4px}
  .notif-delay{background:#ffdfe0;color:#900}
  .notif-exchange{background:#fff6d6;color:#8a5b00}
  @media (max-width:520px){
    th,td{font-size:12px;padding:6px}
    .tab-buttons button{font-size:14px;padding:9px}
    #notification{left:6px;right:6px;bottom:6px}
  }
</style>
</head>
<body>
<header>
  <h1>äº¬ç‹ç·šãƒ»äº•ã®é ­ç·š åœ¨ç·šçŠ¶æ³</h1>
  <div id="meta">
    <div id="updateTime">ãƒ‡ãƒ¼ã‚¿æ›´æ–°ä¸­...</div>
    <div id="localTime">ç¾åœ¨æ™‚åˆ»: --:--:--</div>
  </div>
</header>

<main>
  <section>
    <h2>äº¬ç‹ç·šãƒ»ç›¸æ¨¡åŸç·š</h2>
    <div class="tab-buttons" id="filterKeio">
      <button data-filter="all" class="active">å…¨ã¦</button>
      <button data-filter="ä¸Šã‚Š">ä¸Šã‚Š</button>
      <button data-filter="ä¸‹ã‚Š">ä¸‹ã‚Š</button>
    </div>
    <table id="keioTable"><thead><tr><th>ä¸Šä¸‹</th><th>åˆ—è»Šç•ªå·</th><th>è¡Œå…ˆ</th><th>ç¨®åˆ¥</th><th>ä¸¡æ•°</th><th>ç¾åœ¨ä½ç½®</th><th>ç•ªç·š</th><th>é…ã‚Œ</th><th>å‚™è€ƒ</th></tr></thead><tbody></tbody></table>
  </section>

  <section>
    <h2>äº•ã®é ­ç·š</h2>
    <div class="tab-buttons" id="filterInok">
      <button data-filter="all" class="active">å…¨ã¦</button>
      <button data-filter="ä¸Šã‚Š">ä¸Šã‚Š</button>
      <button data-filter="ä¸‹ã‚Š">ä¸‹ã‚Š</button>
    </div>
    <table id="inokTable"><thead><tr><th>ä¸Šä¸‹</th><th>åˆ—è»Šç•ªå·</th><th>è¡Œå…ˆ</th><th>ç¨®åˆ¥</th><th>ä¸¡æ•°</th><th>ç¾åœ¨ä½ç½®</th><th>ç•ªç·š</th><th>é…ã‚Œ</th><th>å‚™è€ƒ</th></tr></thead><tbody></tbody></table>
  </section>
</main>

<div id="notification" aria-live="polite">
  <h3>ğŸš¨ é‹è¡Œé€šçŸ¥</h3>
  <ul id="notifyList"><li>èª­ã¿è¾¼ã¿ä¸­...</li></ul>
</div>

<script>
const idMap={1:"äº¬ç‹ç·šæ–°å®¿",2:"ç¬¹å¡š",3:"ä»£ç”°æ©‹",4:"æ˜å¤§å‰",5:"ä¸‹é«˜äº•æˆ¸",6:"æ¡œä¸Šæ°´",7:"ä¸ŠåŒ—æ²¢",8:"å…«å¹¡å±±",9:"èŠ¦èŠ±å…¬åœ’",10:"åƒæ­³çƒå±±",11:"ä»™å·",12:"ã¤ã¤ã˜ãƒ¶ä¸˜",13:"æŸ´å´",14:"å›½é ˜",15:"å¸ƒç”°",16:"èª¿å¸ƒ",17:"è¥¿èª¿å¸ƒ",18:"é£›ç”°çµ¦",19:"æ­¦è”µé‡å°",20:"å¤šç£¨éœŠåœ’",21:"æ±åºœä¸­",22:"åºœä¸­",23:"åˆ†å€æ²³åŸ",24:"ä¸­æ²³åŸ",25:"è–è¹Ÿæ¡œãƒ¶ä¸˜",26:"ç™¾è‰åœ’",27:"é«˜å¹¡ä¸å‹•",28:"å—å¹³",29:"å¹³å±±åŸå€å…¬åœ’",30:"é•·æ²¼",31:"åŒ—é‡",32:"äº¬ç‹å…«ç‹å­",44:"äº¬ç‹å¤šæ‘©å·",45:"äº¬ç‹ç¨²ç”°å ¤",46:"äº¬ç‹ã‚ˆã¿ã†ã‚Šãƒ©ãƒ³ãƒ‰",47:"ç¨²åŸ",48:"è‹¥è‘‰å°",49:"äº¬ç‹æ°¸å±±",50:"äº¬ç‹å¤šæ‘©ã‚»ãƒ³ã‚¿ãƒ¼",51:"äº¬ç‹å €ä¹‹å†…",52:"å—å¤§æ²¢",53:"å¤šæ‘©å¢ƒ",54:"æ©‹æœ¬",81:"æ¸‹è°·",82:"ç¥æ³‰",83:"é§’å ´æ±å¤§å‰",84:"æ± ãƒä¸Š",85:"ä¸‹åŒ—æ²¢",86:"æ–°ä»£ç”°",87:"æ±æ¾åŸ",88:"æ˜å¤§å‰",89:"æ°¸ç¦ç”º",90:"è¥¿æ°¸ç¦",91:"æµœç”°å±±",92:"é«˜äº•æˆ¸",93:"å¯Œå£«è¦‹ãƒ¶ä¸˜",94:"ä¹…æˆ‘å±±",95:"ä¸‰é·¹å°",96:"äº•ã®é ­å…¬åœ’",97:"å‰ç¥¥å¯º"};
const syMap={1:{name:"ç‰¹æ€¥",class:"tokkyu"},2:{name:"æ€¥è¡Œ",class:"kyuko"},3:{name:"å¿«é€Ÿ",class:"kaisoku"},5:{name:"åŒºé–“æ€¥è¡Œ",class:"kukan"},6:{name:"å„åœ",class:"kakutei"},9:{name:"ãƒ©ã‚¤ãƒŠãƒ¼",class:"tokkyu"},11:{name:"ãƒ©ã‚¤ãƒŠãƒ¼",class:"tokkyu"}};

const updateTimeEl=document.getElementById("updateTime");
const localTimeEl=document.getElementById("localTime");
const keioTableBody=document.querySelector("#keioTable tbody");
const inokTableBody=document.querySelector("#inokTable tbody");
const notifyList=document.getElementById("notifyList");

function nowTime(){return new Date().toLocaleTimeString("ja-JP",{hour12:false});}
function updateLocalTime(){localTimeEl.textContent=`ç¾åœ¨æ™‚åˆ»: ${nowTime()}`;}
setInterval(updateLocalTime,1000);

function notifExpiry(){
  const now=new Date();
  const tomorrow=new Date(now.getFullYear(),now.getMonth(),now.getDate()+1,1,15,0);
  return tomorrow.getTime();
}
function loadNotif(){
  try{
    const d=JSON.parse(localStorage.getItem("keio_notif")||"{}");
    if(d.expires && d.expires>Date.now())return d;
  }catch{}
  return {expires:0,list:[]};
}
function saveNotif(obj){localStorage.setItem("keio_notif",JSON.stringify(obj));}
function renderNotif(obj){
  notifyList.innerHTML="";
  if(!obj.list||!obj.list.length){notifyList.innerHTML="<li>å¹³å¸¸é‹è»¢</li>";return;}
  obj.list.forEach(i=>{
    const li=document.createElement("li");
    li.textContent=i.text+(i.time?` [${i.time}]`:"");
    li.className=i.type==="delay"?"notif-delay":"notif-exchange";
    notifyList.appendChild(li);
  });
}
function getPosLabel(id){
  const n=parseInt(id.slice(1));
  if(id.startsWith("E"))return`${idMap[n]}é§…æ§‹å†…`;
  if(id.startsWith("U"))return`${idMap[n+1]||"ä¸æ˜"}ã€œ${idMap[n]||"ä¸æ˜"}é–“ ä¸Šã‚Š`;
  if(id.startsWith("D"))return`${idMap[n]||"ä¸æ˜"}ã€œ${idMap[n-1]||"ä¸æ˜"}é–“ ä¸‹ã‚Š`;
  return"ä¸æ˜";
}
async function fetchData(){
  try{
    const res=await fetch("https://i.opentidkeio.jp/data/traffic_info.json?cache="+Date.now());
    const data=await res.json();
    const t=data.up?.[0]?.dt?.[0];
    if(t){
      const hh=String(parseInt(t.hh)%24).padStart(2,"0");
      updateTimeEl.textContent=`ãƒ‡ãƒ¼ã‚¿æœ€çµ‚æ›´æ–°: ${t.yy}/${t.mt}/${t.dy} ${hh}:${t.mm}:${t.ss}`;
    }
    const all=[];
    function collect(section,line){
      section.forEach(st=>{
        st.ps.forEach(p=>{
          const id=st.id,tr=(p.tr||"").trim();
          const sy=syMap[p.sy]?syMap[p.sy].name:"ä¸æ˜";
          const syClass=syMap[p.sy]?syMap[p.sy].class:"";
          const ik=idMap[(p.ik_tr||"").padStart(3,"0")]||"ä¸æ˜";
          const pos=getPosLabel(id);
          const updown=parseInt(id.slice(1))%2===0?"ä¸Šã‚Š":"ä¸‹ã‚Š";
          const delay=parseInt(p.dl)||0;
          all.push({id,line,tr,sy,syClass,ik,pos,updown,sr:p.sr||"",bs:p.bs||"",delay,delayLabel:p.dl==="00"?"å¹³å¸¸":p.dl+"åˆ†é…ã‚Œ",remarks:""});
        });
      });
    }
    if(data.TS)collect(data.TS,"keio");
    if(data.TB)collect(data.TB,"inok");

    // å‚™è€ƒ
    const count={};
    all.forEach(x=>count[x.tr]=(count[x.tr]||0)+1);
    all.forEach(x=>{
      if(x.sy==="ç‰¹æ€¥"&&x.sr==="8")x.remarks="ç‰¹æ€¥ï¼ˆ8ä¸¡ç·¨æˆï¼‰";
      if(count[x.tr]>1)x.remarks+=(x.remarks?"ï¼":"")+"è»Šä¸¡äº¤æ›äºˆå®š";
    });

    // é€šçŸ¥
    let notif=loadNotif();
    if(!notif.expires||notif.expires<Date.now())notif={expires:notifExpiry(),list:[]};
    function push(type,text){
      if(!notif.list.find(i=>i.text===text))notif.list.push({type,text,time:nowTime()});
    }
    all.forEach(x=>{
      if(x.delay>=15)push("delay",`${x.tr}ï¼ˆ${x.delay}åˆ†é…ã‚Œï¼‰`);
      if(x.remarks.includes("è»Šä¸¡äº¤æ›äºˆå®š"))push("exchange",`${x.tr}ï¼ˆè»Šä¸¡äº¤æ›äºˆå®šï¼‰`);
    });
    saveNotif(notif);renderNotif(notif);

    function render(table,line){
      table.innerHTML="";
      all.filter(r=>r.line===line).forEach(r=>{
        const tr=document.createElement("tr");
        tr.dataset.updown=r.updown;
        tr.innerHTML=`<td>${r.updown}</td><td>${r.tr}</td><td>${r.ik}</td><td class="${r.syClass}">${r.sy}</td><td>${r.sr}</td><td>${r.pos}</td><td>${r.bs}</td><td>${r.delayLabel}</td><td>${r.remarks}</td>`;
        table.appendChild(tr);
      });
    }
    render(keioTableBody,"keio");
    render(inokTableBody,"inok");
    setupTabs();
  }catch(e){
    updateTimeEl.textContent="æ›´æ–°å¤±æ•—ï¼š"+e.message;
  }
}
function setupTabs(){
  function bind(id,tbody){
    const btns=document.getElementById(id).querySelectorAll("button");
    btns.forEach(btn=>{
      if(btn._b)return;
      btn._b=true;
      btn.addEventListener("click",()=>{
        btns.forEach(b=>b.classList.remove("active"));
        btn.classList.add("active");
        const f=btn.dataset.filter;
        tbody.querySelectorAll("tr").forEach(r=>{
          const up=r.dataset.updown;
          r.style.display=f==="all"||f===up?"":"none";
        });
      });
    });
  }
  bind("filterKeio",keioTableBody);
  bind("filterInok",inokTableBody);
}
function enableSorting(){
  document.querySelectorAll("table").forEach(t=>{
    const hs=t.querySelectorAll("th");
    hs.forEach((th,i)=>{
      if(th._s)return;
      th._s=true;th.style.cursor="pointer";
      th.addEventListener("click",()=>{
        const tb=t.querySelector("tbody");
        const rs=Array.from(tb.querySelectorAll("tr")).filter(r=>r.style.display!=="none");
        const asc=!th.classList.contains("asc");
        hs.forEach(h=>h.classList.remove("asc","desc"));
        th.classList.add(asc?"asc":"desc");
        rs.sort((a,b)=>{
          const A=a.children[i].textContent.trim();
          const B=b.children[i].textContent.trim();
          const nA=parseFloat(A.replace(/[^0-9.-]/g,""));
          const nB=parseFloat(B.replace(/[^0-9.-]/g,""));
          if(!isNaN(nA)&&!isNaN(nB))return asc?nA-nB:nB-nA;
          return asc?A.localeCompare(B,"ja"):B.localeCompare(A,"ja");
        });
        rs.forEach(r=>tb.appendChild(r));
      });
    });
  });
}
fetchData();enableSorting();setInterval(fetchData,30000);
setInterval(()=>{
  const d=loadNotif();
  if(d.expires<=Date.now()){saveNotif({expires:0,list:[]});renderNotif({list:[]});}
},60000);
updateLocalTime();
</script>
</body>
</html>
