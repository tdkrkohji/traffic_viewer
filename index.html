<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>é‹è¡Œä¸­åˆ—è»Š</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
/* å…¨ä½“ã®åŸºæœ¬è¨­å®š */
body {
  font-family: "Segoe UI", "Hiragino Sans", sans-serif;
  background: #f8f8f8;
  color: #222;
  text-align: center;
  margin: 0;
  font-size: 13px;
}

/* ã‚¿ã‚¤ãƒˆãƒ« */
h1 {
  margin: 18px 0 8px;
  font-size: 1.4em;
}

/* ãƒ†ãƒ¼ãƒ–ãƒ«åŸºæœ¬ãƒ‡ã‚¶ã‚¤ãƒ³ */
table {
  border-collapse: collapse;
  margin: 8px auto;
  width: 95%;
  max-width: 1000px;
  background: #fff;
  font-size: 13px;
}

th, td {
  border: 1px solid #ccc;
  padding: 5px 7px;
  text-align: center;
}

th {
  background: #eee;
  cursor: pointer;
}

tr:nth-child(even) {
  background: #f9f9f9;
}

/* ç¨®åˆ¥è‰² */
.tokkyu { background: #d32f2f; color: #fff; }
.kyuko { background: #388e3c; color: #fff; }
.kaisoku { background: #1976d2; color: #fff; }
.kukan { background: #fff176; color: #000; }
.kakutei { background: #e0e0e0; color: #000; }

/* ã‚¿ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³ */
#tabs, .subtabs {
  display: flex;
  justify-content: center;
  margin: 10px 0;
  flex-wrap: wrap;
}

.tab, .subtab {
  padding: 5px 12px;
  border: 1px solid #aaa;
  background: #fff;
  margin: 2px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 13px;
}

.active {
  background: #1976d2;
  color: #fff;
  border-color: #1976d2;
}

/* ç¾åœ¨æ™‚åˆ»ãƒ»æ›´æ–°æ™‚é–“è¡¨ç¤º */
#updateTime, #localTime {
  font-size: 12px;
  color: #555;
  margin: 4px 0;
}

/* é€šçŸ¥æ¬„ */
#notifications {
  background: #fff3cd;
  border: 1px solid #ffecb5;
  padding: 6px;
  margin: 8px auto;
  width: 90%;
  max-width: 800px;
  border-radius: 6px;
  text-align: left;
  font-size: 13px;
}

/* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ãƒœã‚¿ãƒ³ & æ›´æ–°é–“éš”ã‚»ãƒ¬ã‚¯ã‚¿ */
#modeToggle, #intervalSelect {
  position: fixed;
  bottom: 10px;
  padding: 5px 10px;
  border: none;
  border-radius: 6px;
  font-size: 13px;
  cursor: pointer;
}

#modeToggle {
  right: 10px;
  background: #444;
  color: #fff;
}

#intervalSelect {
  left: 10px;
  background: #fff;
  border: 1px solid #ccc;
}

/* ã‚¹ãƒãƒ›å¯¾å¿œ */
@media (max-width: 600px) {
  table { font-size: 11px; }
  th, td { padding: 4px; }
}

/* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰è¨­å®š */
body.dark {
  background: #222;
  color: #eee;
}
body.dark table { background: #333; color: #eee; }
body.dark th { background: #555; }
body.dark tr:nth-child(even) { background: #2a2a2a; }
</style>
</head>

<body>
<h1>é‹è¡Œä¸­åˆ—è»Š</h1>
<p id="updateTime">ãƒ‡ãƒ¼ã‚¿æ›´æ–°ä¸­...</p>
<p id="localTime">ç¾åœ¨æ™‚åˆ»: --:--:--</p>

<!-- é€šçŸ¥æ¬„ -->
<div id="notifications"></div>

<!-- è·¯ç·šã‚¿ãƒ– -->
<div id="tabs">
  <div class="tab active" data-line="keio">äº¬ç‹ç·š</div>
  <div class="tab" data-line="inok">äº•ã®é ­ç·š</div>
</div>

<!-- å„è·¯ç·šå†…å®¹ -->
<div id="content">
  <!-- äº¬ç‹ç·š -->
  <div class="lineTab" id="keio" style="display:block;">
    <div class="subtabs">
      <div class="subtab active" data-dir="up">ä¸Šã‚Š</div>
      <div class="subtab" data-dir="down">ä¸‹ã‚Š</div>
    </div>
    <table id="keio-up">
      <thead><tr><th>åˆ—è»Šç•ªå·</th><th>ç¨®åˆ¥</th><th>ä¸Šä¸‹</th><th>ç¾åœ¨ä½ç½®</th><th>è¡Œå…ˆ</th><th>ä¸¡æ•°</th><th>ç•ªç·š</th><th>é…ã‚Œ</th><th>å‚™è€ƒ</th></tr></thead>
      <tbody></tbody>
    </table>
    <table id="keio-down" style="display:none;">
      <thead><tr><th>åˆ—è»Šç•ªå·</th><th>ç¨®åˆ¥</th><th>ä¸Šä¸‹</th><th>ç¾åœ¨ä½ç½®</th><th>è¡Œå…ˆ</th><th>ä¸¡æ•°</th><th>ç•ªç·š</th><th>é…ã‚Œ</th><th>å‚™è€ƒ</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- äº•ã®é ­ç·š -->
  <div class="lineTab" id="inok" style="display:none;">
    <div class="subtabs">
      <div class="subtab active" data-dir="up">ä¸Šã‚Š</div>
      <div class="subtab" data-dir="down">ä¸‹ã‚Š</div>
    </div>
    <table id="inok-up">
      <thead><tr><th>åˆ—è»Šç•ªå·</th><th>ç¨®åˆ¥</th><th>ä¸Šä¸‹</th><th>ç¾åœ¨ä½ç½®</th><th>è¡Œå…ˆ</th><th>ä¸¡æ•°</th><th>ç•ªç·š</th><th>é…ã‚Œ</th><th>å‚™è€ƒ</th></tr></thead>
      <tbody></tbody>
    </table>
    <table id="inok-down" style="display:none;">
      <thead><tr><th>åˆ—è»Šç•ªå·</th><th>ç¨®åˆ¥</th><th>ä¸Šä¸‹</th><th>ç¾åœ¨ä½ç½®</th><th>è¡Œå…ˆ</th><th>ä¸¡æ•°</th><th>ç•ªç·š</th><th>é…ã‚Œ</th><th>å‚™è€ƒ</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<!-- æ›´æ–°é–“éš”é¸æŠãƒ»ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ -->
<select id="intervalSelect">
  <option value="10000">10ç§’ã”ã¨</option>
  <option value="30000" selected>30ç§’ã”ã¨</option>
  <option value="60000">1åˆ†ã”ã¨</option>
  <option value="180000">3åˆ†ã”ã¨</option>
</select>

<button id="modeToggle">ğŸŒ™</button>

<script>
/* === é§…ãƒ‡ãƒ¼ã‚¿ãƒãƒƒãƒ— === */
const idMap = {
  001:"äº¬ç‹ç·šæ–°å®¿",002:"ç¬¹å¡š",003:"ä»£ç”°æ©‹",004:"æ˜å¤§å‰",005:"ä¸‹é«˜äº•æˆ¸",006:"æ¡œä¸Šæ°´",
  007:"ä¸ŠåŒ—æ²¢",008:"å…«å¹¡å±±",009:"èŠ¦èŠ±å…¬åœ’",010:"åƒæ­³çƒå±±",011:"ä»™å·",012:"ã¤ã¤ã˜ãƒ¶ä¸˜",
  013:"æŸ´å´",014:"å›½é ˜",015:"å¸ƒç”°",016:"èª¿å¸ƒ",017:"è¥¿èª¿å¸ƒ",018:"é£›ç”°çµ¦",019:"æ­¦è”µé‡å°",
  020:"å¤šç£¨éœŠåœ’",021:"æ±åºœä¸­",022:"åºœä¸­",023:"åˆ†å€æ²³åŸ",024:"ä¸­æ²³åŸ",025:"è–è¹Ÿæ¡œãƒ¶ä¸˜",
  026:"ç™¾è‰åœ’",027:"é«˜å¹¡ä¸å‹•",028:"å—å¹³",029:"å¹³å±±åŸå€å…¬åœ’",030:"é•·æ²¼",031:"åŒ—é‡",
  032:"äº¬ç‹å…«ç‹å­",044:"äº¬ç‹å¤šæ‘©å·",045:"äº¬ç‹ç¨²ç”°å ¤",046:"äº¬ç‹ã‚ˆã¿ã†ã‚Šãƒ©ãƒ³ãƒ‰",047:"ç¨²åŸ",
  048:"è‹¥è‘‰å°",049:"äº¬ç‹æ°¸å±±",050:"äº¬ç‹å¤šæ‘©ã‚»ãƒ³ã‚¿ãƒ¼",051:"äº¬ç‹å €ä¹‹å†…",052:"å—å¤§æ²¢",
  053:"å¤šæ‘©å¢ƒ",054:"æ©‹æœ¬",
  081:"æ¸‹è°·",082:"ç¥æ³‰",083:"é§’å ´æ±å¤§å‰",084:"æ± ãƒä¸Š",085:"ä¸‹åŒ—æ²¢",086:"æ–°ä»£ç”°",087:"æ±æ¾åŸ",
  088:"æ˜å¤§å‰",089:"æ°¸ç¦ç”º",090:"è¥¿æ°¸ç¦",091:"æµœç”°å±±",092:"é«˜äº•æˆ¸",093:"å¯Œå£«è¦‹ãƒ¶ä¸˜",
  094:"ä¹…æˆ‘å±±",095:"ä¸‰é·¹å°",096:"äº•ã®é ­å…¬åœ’",097:"å‰ç¥¥å¯º",
  101:"æ–°å®¿ä¸‰ä¸ç›®",102:"æ›™æ©‹",103:"å¸‚ãƒ¶è°·",104:"ä¹æ®µä¸‹",105:"ç¥ä¿ç”º",106:"å°å·ç”º",
  107:"å²©æœ¬ç”º",108:"é¦¬å–°æ¨ªå±±",109:"æµœç”º",110:"æ£®ä¸‹",111:"èŠå·",112:"ä½å‰",113:"è¥¿å¤§å³¶",
  114:"å¤§å³¶",115:"æ±å¤§å³¶",116:"èˆ¹å €",117:"ä¸€ä¹‹æ±Ÿ",118:"ç‘æ±Ÿ",119:"ç¯ å´",120:"æœ¬å…«å¹¡"
};

/* === ç¨®åˆ¥ãƒ‡ãƒ¼ã‚¿ === */
const syMap = {
  1:{name:"ç‰¹æ€¥",class:"tokkyu"},2:{name:"æ€¥è¡Œ",class:"kyuko"},
  3:{name:"å¿«é€Ÿ",class:"kaisoku"},5:{name:"åŒºé–“æ€¥è¡Œ",class:"kukan"},
  6:{name:"å„åœ",class:"kakutei"},9:{name:"ãƒ©ã‚¤ãƒŠãƒ¼",class:"tokkyu"},
  11:{name:"ãƒ©ã‚¤ãƒŠãƒ¼",class:"tokkyu"}
};

/* === ç¾åœ¨æ™‚åˆ»æ›´æ–° === */
function updateLocalTime() {
  document.getElementById("localTime").textContent =
    "ç¾åœ¨æ™‚åˆ»: " + new Date().toLocaleTimeString("ja-JP",{hour12:false});
}
setInterval(updateLocalTime, 1000);
updateLocalTime();

/* === ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ === */
document.getElementById("modeToggle").onclick = () => {
  document.body.classList.toggle("dark");
  document.getElementById("modeToggle").textContent =
    document.body.classList.contains("dark") ? "â˜€ï¸" : "ğŸŒ™";
};

/* === ã‚¿ãƒ–åˆ‡æ›¿ === */
document.querySelectorAll(".tab").forEach(tab=>{
  tab.onclick=()=>{
    document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
    document.querySelectorAll(".lineTab").forEach(l=>l.style.display="none");
    tab.classList.add("active");
    document.getElementById(tab.dataset.line).style.display="block";
  };
});

/* === ä¸Šä¸‹åˆ‡æ›¿ === */
document.querySelectorAll(".subtab").forEach(sub=>{
  sub.onclick=()=>{
    const parent=sub.closest(".lineTab");
    parent.querySelectorAll(".subtab").forEach(s=>s.classList.remove("active"));
    parent.querySelectorAll("table").forEach(tb=>tb.style.display="none");
    sub.classList.add("active");
    parent.querySelector(`table[id$='-${sub.dataset.dir}']`).style.display="table";
  };
});

/* === ãƒ‡ãƒ¼ã‚¿å–å¾— === */
async function fetchData() {
  try {
    const res = await fetch("https://i.opentidkeio.jp/data/traffic_info.json?cache="+Date.now());
    const data = await res.json();
    const t = data.up?.[0]?.dt?.[0];
    if(t) document.getElementById("updateTime").textContent = `ãƒ‡ãƒ¼ã‚¿æœ€çµ‚æ›´æ–°: ${t.yy}/${t.mt}/${t.dy} ${t.hh}:${t.mm}:${t.ss}`;
    
    ["keio-up","keio-down","inok-up","inok-down"].forEach(id=>{
      document.querySelector(`#${id} tbody`).innerHTML="";
    });
    
    const delayNotice = new Set();
    const exchangeNotice = new Set();
    const trainMap = new Map();
    
    function addRows(section, baseId) {
      section.forEach(st=>{
        st.ps.forEach(p=>{
          const trNo = p.tr.trim();
          const sy = syMap[p.sy] || {name:"ä¸æ˜",class:""};
          const ik = idMap[p.ik_tr.padStart(3,"0")] || "ä¸æ˜";
          const pos = idMap[st.id.slice(1).padStart(3,"0")] || "ä¸æ˜";
          const updown = parseInt(st.id.slice(1))%2===0 ? "ä¸Šã‚Š" : "ä¸‹ã‚Š";
          const delay = p.dl==="00" ? "å¹³å¸¸" : `${p.dl}åˆ†é…ã‚Œ`;
          let remarks = "";
          if(sy.name==="ç‰¹æ€¥" && parseInt(p.sr)===8) remarks += "ç‰¹æ€¥ï¼ˆ8ä¸¡ç·¨æˆï¼‰ ";
          if(parseInt(p.ik_tr)>=101 && parseInt(p.ik_tr)<=120) remarks += "éƒ½å–¶æ–°å®¿ç·šç›´é€š ";
          if(trainMap.has(trNo)) {remarks += "è»Šä¸¡äº¤æ›äºˆå®š "; exchangeNotice.add(trNo);} 
          else trainMap.set(trNo,true);
          if(parseInt(p.dl)>=15) delayNotice.add(`${trNo} (${p.dl}åˆ†é…ã‚Œ)`);
          
          const row = `<tr>
            <td>${trNo}</td>
            <td class="${sy.class}">${sy.name}</td>
            <td>${updown}</td>
            <td>${pos}</td>
            <td>${ik}</td>
            <td>${p.sr}</td>
            <td>${p.bs}</td>
            <td>${delay}</td>
            <td>${remarks.trim()}</td>
          </tr>`;
          
          document.querySelector(`#${baseId}-${updown==="ä¸Šã‚Š"?"up":"down"} tbody`)
            .insertAdjacentHTML("beforeend", row);
        });
      });
    }
    if(data.TS) addRows(data.TS,"keio");
    if(data.TB) addRows(data.TB,"inok");
    
    let noteHTML="";
    if(delayNotice.size>0) noteHTML+="ğŸš¨ é…å»¶15åˆ†ä»¥ä¸Š: "+[...delayNotice].join(", ")+"<br>";
    if(exchangeNotice.size>0) noteHTML+="ğŸ”§ è»Šä¸¡äº¤æ›äºˆå®š: "+[...exchangeNotice].join(", ");
    document.getElementById("notifications").innerHTML = noteHTML || "";
    
  } catch(e) {
    document.getElementById("updateTime").textContent = "æ›´æ–°å¤±æ•—ï¼š" + e.message;
  }
}

/* === æ›´æ–°é–“éš”è¨­å®š === */
let fetchInterval;
function setFetchInterval(ms){
  clearInterval(fetchInterval);
  fetchInterval=setInterval(fetchData,ms);
}
document.getElementById("intervalSelect").onchange=e=>{
  const v=parseInt(e.target.value);
  localStorage.setItem("updateInterval",v);
  setFetchInterval(v);
};

/* åˆæœŸè¨­å®š */
const savedInt=parseInt(localStorage.getItem("updateInterval"))||30000;
document.getElementById("intervalSelect").value=savedInt;
fetchData();
setFetchInterval(savedInt);
</script>
</body>
</html>
