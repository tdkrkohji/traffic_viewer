<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>äº¬ç‹ç·šãƒ»äº•ã®é ­ç·š åœ¨ç·šçŠ¶æ³</title>
<style>
  body { font-family: "Segoe UI", sans-serif; text-align: center; background: #f8f8f8; margin-bottom: 50px; }
  h1, h2 { margin-top: 30px; }
  table { border-collapse: collapse; margin: 20px auto; width: 95%; max-width: 1100px; background: #fff; }
  th, td { border: 1px solid #ccc; padding: 6px 10px; text-align: center; }
  th { background: #eee; cursor: pointer; position: sticky; top: 0; }
  tr:hover { background: #f1f1f1; }
  .tokkyu { color: #fff; background: #d32f2f; }
  .kyuko { color: #fff; background: #388e3c; }
  .kaisoku { color: #fff; background: #1976d2; }
  .kukan { color: #000; background: #fff176; }
  .kakutei { color: #000; background: #e0e0e0; }
  #updateTime, #localTime { margin: 5px 0; font-size: 14px; color: #555; }
  .sortable::after { content: " â†•"; font-size: 12px; color: #666; }
  #delayNotice { background: #fff3e0; border: 1px solid #ff9800; margin: 10px auto; padding: 10px; width: 90%; max-width: 800px; border-radius: 6px; }
  #delayNotice h3 { margin: 0 0 8px; color: #e65100; }
  #delayList { list-style: none; padding: 0; margin: 0; }
</style>
</head>
<body>
<h1>äº¬ç‹ç·šãƒ»äº•ã®é ­ç·š åœ¨ç·šçŠ¶æ³</h1>
<p id="updateTime">ãƒ‡ãƒ¼ã‚¿æ›´æ–°ä¸­...</p>
<p id="localTime">ç¾åœ¨æ™‚åˆ»: --:--:--</p>

<div id="delayNotice" style="display:none;">
  <h3>ğŸš¨ é…å»¶é€šçŸ¥ï¼ˆ15åˆ†ä»¥ä¸Šï¼‰</h3>
  <ul id="delayList"></ul>
</div>

<h2>äº¬ç‹ç·šãƒ»ç›¸æ¨¡åŸç·š</h2>
<table id="keioTable">
  <tr>
    <th class="sortable">ä¸Šä¸‹</th>
    <th class="sortable">åˆ—è»Šç•ªå·</th>
    <th class="sortable">è¡Œå…ˆ</th>
    <th class="sortable">ç¨®åˆ¥</th>
    <th class="sortable">ä¸¡æ•°</th>
    <th class="sortable">ç¾åœ¨ä½ç½®</th>
    <th class="sortable">ç•ªç·š</th>
    <th class="sortable">é…ã‚Œ</th>
    <th>å‚™è€ƒ</th>
  </tr>
</table>

<h2>äº•ã®é ­ç·š</h2>
<table id="inokTable">
  <tr>
    <th class="sortable">ä¸Šä¸‹</th>
    <th class="sortable">åˆ—è»Šç•ªå·</th>
    <th class="sortable">è¡Œå…ˆ</th>
    <th class="sortable">ç¨®åˆ¥</th>
    <th class="sortable">ä¸¡æ•°</th>
    <th class="sortable">ç¾åœ¨ä½ç½®</th>
    <th class="sortable">ç•ªç·š</th>
    <th class="sortable">é…ã‚Œ</th>
    <th>å‚™è€ƒ</th>
  </tr>
</table>

<script>
const idMap = {
  001:"äº¬ç‹ç·šæ–°å®¿",002:"ç¬¹å¡š",003:"ä»£ç”°æ©‹",004:"æ˜å¤§å‰",005:"ä¸‹é«˜äº•æˆ¸",006:"æ¡œä¸Šæ°´",007:"ä¸ŠåŒ—æ²¢",008:"å…«å¹¡å±±",
  009:"èŠ¦èŠ±å…¬åœ’",010:"åƒæ­³çƒå±±",011:"ä»™å·",012:"ã¤ã¤ã˜ãƒ¶ä¸˜",013:"æŸ´å´",014:"å›½é ˜",015:"å¸ƒç”°",016:"èª¿å¸ƒ",017:"è¥¿èª¿å¸ƒ",
  018:"é£›ç”°çµ¦",019:"æ­¦è”µé‡å°",020:"å¤šç£¨éœŠåœ’",021:"æ±åºœä¸­",022:"åºœä¸­",023:"åˆ†å€æ²³åŸ",024:"ä¸­æ²³åŸ",025:"è–è¹Ÿæ¡œãƒ¶ä¸˜",
  026:"ç™¾è‰åœ’",027:"é«˜å¹¡ä¸å‹•",028:"å—å¹³",029:"å¹³å±±åŸå€å…¬åœ’",030:"é•·æ²¼",031:"åŒ—é‡",032:"äº¬ç‹å…«ç‹å­",
  044:"äº¬ç‹å¤šæ‘©å·",045:"äº¬ç‹ç¨²ç”°å ¤",046:"äº¬ç‹ã‚ˆã¿ã†ã‚Šãƒ©ãƒ³ãƒ‰",047:"ç¨²åŸ",048:"è‹¥è‘‰å°",049:"äº¬ç‹æ°¸å±±",
  050:"äº¬ç‹å¤šæ‘©ã‚»ãƒ³ã‚¿ãƒ¼",051:"äº¬ç‹å €ä¹‹å†…",052:"å—å¤§æ²¢",053:"å¤šæ‘©å¢ƒ",054:"æ©‹æœ¬",
  081:"æ¸‹è°·",082:"ç¥æ³‰",083:"é§’å ´æ±å¤§å‰",084:"æ± ãƒä¸Š",085:"ä¸‹åŒ—æ²¢",086:"æ–°ä»£ç”°",087:"æ±æ¾åŸ",
  088:"æ˜å¤§å‰",089:"æ°¸ç¦ç”º",090:"è¥¿æ°¸ç¦",091:"æµœç”°å±±",092:"é«˜äº•æˆ¸",093:"å¯Œå£«è¦‹ãƒ¶ä¸˜",094:"ä¹…æˆ‘å±±",
  095:"ä¸‰é·¹å°",096:"äº•ã®é ­å…¬åœ’",097:"å‰ç¥¥å¯º"
};

const syMap = {
  1: {name:"ç‰¹æ€¥", class:"tokkyu"},
  2: {name:"æ€¥è¡Œ", class:"kyuko"},
  3: {name:"å¿«é€Ÿ", class:"kaisoku"},
  5: {name:"åŒºé–“æ€¥è¡Œ", class:"kukan"},
  6: {name:"å„åœ", class:"kakutei"},
  9: {name:"ãƒ©ã‚¤ãƒŠãƒ¼", class:"tokkyu"},
  11:{name:"ãƒ©ã‚¤ãƒŠãƒ¼", class:"tokkyu"}
};

// ç¾åœ¨æ™‚åˆ»ã‚’æ›´æ–°
function updateLocalTime() {
  const now = new Date();
  const h = String(now.getHours()).padStart(2,"0");
  const m = String(now.getMinutes()).padStart(2,"0");
  const s = String(now.getSeconds()).padStart(2,"0");
  document.getElementById("localTime").textContent = `ç¾åœ¨æ™‚åˆ»: ${h}:${m}:${s}`;
}

// --- é…å»¶é€šçŸ¥ãƒ‡ãƒ¼ã‚¿ä¿æŒ ---
function loadDelayData() {
  const today = new Date();
  const key = "delayData_" + today.toISOString().split("T")[0];
  const saved = localStorage.getItem(key);
  if (saved) return JSON.parse(saved);
  return { lastReset: Date.now(), list: [] };
}

function saveDelayData(data) {
  const today = new Date();
  const key = "delayData_" + today.toISOString().split("T")[0];
  localStorage.setItem(key, JSON.stringify(data));
}

function resetIfAfter115() {
  const now = new Date();
  if (now.getHours() === 1 && now.getMinutes() >= 15) {
    localStorage.clear();
  }
}

// --- ãƒ¡ã‚¤ãƒ³å‡¦ç† ---
async function fetchData() {
  try {
    const res = await fetch("https://i.opentidkeio.jp/data/traffic_info.json?cache=" + Date.now());
    const data = await res.json();

    // æ›´æ–°æ™‚åˆ»
    const t = data.up?.[0]?.dt?.[0];
    if (t) {
      const hh = String(parseInt(t.hh) % 24).padStart(2,"0");
      document.getElementById("updateTime").textContent =
        `ãƒ‡ãƒ¼ã‚¿æœ€çµ‚æ›´æ–°: ${t.yy}/${t.mt}/${t.dy} ${hh}:${t.mm}:${t.ss}`;
    }

    const keioTable = document.getElementById("keioTable");
    const inokTable = document.getElementById("inokTable");
    keioTable.innerHTML = keioTable.rows[0].outerHTML;
    inokTable.innerHTML = inokTable.rows[0].outerHTML;

    const allTrains = [];

    function addRows(section, table) {
      section.forEach(st => {
        st.ps.forEach(p => {
          const id = st.id;
          const trNo = p.tr.trim();
          const sy = syMap[p.sy] || {name:"ä¸æ˜", class:""};
          const ik = idMap[p.ik_tr.padStart(3,"0")] || "ä¸æ˜";
          const pos =
            id.startsWith("E") ? idMap[id.slice(1)] + "é§…æ§‹å†…" :
            id.startsWith("U") ? idMap[(+id.slice(1)+1).toString().padStart(3,"0")] + "ã€œ" + idMap[id.slice(1)] + "é–“ ä¸Šã‚Š" :
            id.startsWith("D") ? idMap[id.slice(1)] + "ã€œ" + idMap[(+id.slice(1)-1).toString().padStart(3,"0")] + "é–“ ä¸‹ã‚Š" :
            "ä¸æ˜";
          const updown = parseInt(id.slice(1)) % 2 === 0 ? "ä¸Šã‚Š" : "ä¸‹ã‚Š";
          const delay = p.dl === "00" ? "å¹³å¸¸" : p.dl + "åˆ†é…ã‚Œ";
          allTrains.push({table, trNo, sy, updown, pos, ik, sr:p.sr, bs:p.bs, delay, delayNum: parseInt(p.dl)});
        });
      });
    }

    if (data.TS) addRows(data.TS, keioTable);
    if (data.TB) addRows(data.TB, inokTable);

    // å‚™è€ƒåˆ¤å®š & é…å»¶é€šçŸ¥å‡¦ç†
    const trCount = {};
    allTrains.forEach(t => trCount[t.trNo] = (trCount[t.trNo] || 0) + 1);
    let delayData = loadDelayData();

    allTrains.forEach(t => {
      let remarks = "";
      if (t.sy.name === "ç‰¹æ€¥" && t.sr === "8") remarks = "ç‰¹æ€¥ï¼ˆ8ä¸¡ç·¨æˆï¼‰";
      if (trCount[t.trNo] > 1) remarks += (remarks ? "ï¼" : "") + "è»Šä¸¡äº¤æ›äºˆå®š";
      if (t.delayNum >= 15) {
        if (!delayData.list.find(x => x.trNo === t.trNo)) {
          delayData.list.push({ trNo: t.trNo, delay: t.delay, time: new Date().toLocaleTimeString() });
        }
      }
      const row = `<tr>
        <td>${t.updown}</td>
        <td>${t.trNo}</td>
        <td>${t.ik}</td>
        <td class="${t.sy.class}">${t.sy.name}</td>
        <td>${t.sr}</td>
        <td>${t.pos}</td>
        <td>${t.bs}</td>
        <td>${t.delay}</td>
        <td>${remarks}</td>
      </tr>`;
      t.table.insertAdjacentHTML("beforeend", row);
    });

    // é€šçŸ¥è¡¨ç¤º
    const noticeBox = document.getElementById("delayNotice");
    const list = document.getElementById("delayList");
    list.innerHTML = "";
    if (delayData.list.length > 0) {
      noticeBox.style.display = "block";
      delayData.list.forEach(d => {
        const li = document.createElement("li");
        li.textContent = `${d.trNo}åˆ—è»Š (${d.delay}) [è¨˜éŒ²æ™‚åˆ» ${d.time}]`;
        list.appendChild(li);
      });
    } else {
      noticeBox.style.display = "none";
    }

    saveDelayData(delayData);
    resetIfAfter115();

  } catch (e) {
    document.getElementById("updateTime").textContent = "æ›´æ–°å¤±æ•—ï¼š" + e.message;
  }
}

// ä¸¦ã³æ›¿ãˆ
function makeSortable(tableId) {
  const table = document.getElementById(tableId);
  const headers = table.querySelectorAll("th.sortable");
  headers.forEach((th, idx) => {
    th.addEventListener("click", () => {
      const rows = Array.from(table.querySelectorAll("tr:nth-child(n+2)"));
      const asc = !th.classList.contains("asc");
      headers.forEach(h => h.classList.remove("asc", "desc"));
      th.classList.add(asc ? "asc" : "desc");
      rows.sort((a, b) => {
        const A = a.children[idx].textContent;
        const B = b.children[idx].textContent;
        return asc ? A.localeCompare(B, "ja") : B.localeCompare(A, "ja");
      });
      rows.forEach(r => table.appendChild(r));
    });
  });
}

fetchData();
setInterval(fetchData, 1000);
setInterval(updateLocalTime, 1000);
updateLocalTime();
makeSortable("keioTable");
makeSortable("inokTable");
</script>
</body>
</html>
