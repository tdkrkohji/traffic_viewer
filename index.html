<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>京王線・井の頭線 在線状況</title>
<style>
  body { font-family: "Segoe UI", sans-serif; text-align: center; background: #f8f8f8; margin-bottom: 50px; }
  h1, h2 { margin-top: 30px; }
  table { border-collapse: collapse; margin: 20px auto; width: 95%; max-width: 1100px; background: #fff; }
  th, td { border: 1px solid #ccc; padding: 6px 10px; text-align: center; }
  th { background: #eee; cursor: pointer; position: sticky; top: 0; }
  tr:hover { background: #f1f1f1; }
  .tokkyu { color: #fff; background: #d32f2f; }
  .kyuko { color: #fff; background: #388e3c; }
  .kaisoku { color: #fff; background: #1976d2; }
  .kukan { color: #000; background: #fff176; }
  .kakutei { color: #000; background: #e0e0e0; }
  #updateTime, #localTime { margin: 5px 0; font-size: 14px; color: #555; }
  .sortable::after { content: " ↕"; font-size: 12px; color: #666; }
  #delayNotice { background: #fff3e0; border: 1px solid #ff9800; margin: 10px auto; padding: 10px; width: 90%; max-width: 800px; border-radius: 6px; }
  #delayNotice h3 { margin: 0 0 8px; color: #e65100; }
  #delayList { list-style: none; padding: 0; margin: 0; }
</style>
</head>
<body>
<h1>京王線・井の頭線 在線状況</h1>
<p id="updateTime">データ更新中...</p>
<p id="localTime">現在時刻: --:--:--</p>

<div id="delayNotice" style="display:none;">
  <h3>遅延通知（15分以上）</h3>
  <ul id="delayList"></ul>
</div>

<h2>京王線・相模原線</h2>
<table id="keioTable">
  <tr>
    <th class="sortable">上下</th>
    <th class="sortable">列車番号</th>
    <th class="sortable">行先</th>
    <th class="sortable">種別</th>
    <th class="sortable">両数</th>
    <th class="sortable">現在位置</th>
    <th class="sortable">番線</th>
    <th class="sortable">遅れ</th>
    <th>備考</th>
  </tr>
</table>

<h2>井の頭線</h2>
<table id="inokTable">
  <tr>
    <th class="sortable">上下</th>
    <th class="sortable">列車番号</th>
    <th class="sortable">行先</th>
    <th class="sortable">種別</th>
    <th class="sortable">両数</th>
    <th class="sortable">現在位置</th>
    <th class="sortable">番線</th>
    <th class="sortable">遅れ</th>
    <th>備考</th>
  </tr>
</table>

<script>
const idMap = {
  001:"京王線新宿",002:"笹塚",003:"代田橋",004:"明大前",005:"下高井戸",006:"桜上水",007:"上北沢",008:"八幡山",
  009:"芦花公園",010:"千歳烏山",011:"仙川",012:"つつじヶ丘",013:"柴崎",014:"国領",015:"布田",016:"調布",017:"西調布",
  018:"飛田給",019:"武蔵野台",020:"多磨霊園",021:"東府中",022:"府中",023:"分倍河原",024:"中河原",025:"聖蹟桜ヶ丘",
  026:"百草園",027:"高幡不動",028:"南平",029:"平山城址公園",030:"長沼",031:"北野",032:"京王八王子",
  044:"京王多摩川",045:"京王稲田堤",046:"京王よみうりランド",047:"稲城",048:"若葉台",049:"京王永山",
  050:"京王多摩センター",051:"京王堀之内",052:"南大沢",053:"多摩境",054:"橋本",
  081:"渋谷",082:"神泉",083:"駒場東大前",084:"池ノ上",085:"下北沢",086:"新代田",087:"東松原",
  088:"明大前",089:"永福町",090:"西永福",091:"浜田山",092:"高井戸",093:"富士見ヶ丘",094:"久我山",
  095:"三鷹台",096:"井の頭公園",097:"吉祥寺"
};

const syMap = {
  1: {name:"特急", class:"tokkyu"},
  2: {name:"急行", class:"kyuko"},
  3: {name:"快速", class:"kaisoku"},
  5: {name:"区間急行", class:"kukan"},
  6: {name:"各停", class:"kakutei"},
  9: {name:"ライナー", class:"tokkyu"},
  11:{name:"ライナー", class:"tokkyu"}
};

// 現在時刻を更新
function updateLocalTime() {
  const now = new Date();
  const h = String(now.getHours()).padStart(2,"0");
  const m = String(now.getMinutes()).padStart(2,"0");
  const s = String(now.getSeconds()).padStart(2,"0");
  document.getElementById("localTime").textContent = `現在時刻: ${h}:${m}:${s}`;
}

// --- 遅延通知データ保持 ---
function loadDelayData() {
  const today = new Date();
  const key = "delayData_" + today.toISOString().split("T")[0];
  const saved = localStorage.getItem(key);
  if (saved) return JSON.parse(saved);
  return { lastReset: Date.now(), list: [] };
}

function saveDelayData(data) {
  const today = new Date();
  const key = "delayData_" + today.toISOString().split("T")[0];
  localStorage.setItem(key, JSON.stringify(data));
}

function resetIfAfter115() {
  const now = new Date();
  if (now.getHours() === 1 && now.getMinutes() >= 15) {
    localStorage.clear();
  }
}

// --- メイン処理 ---
async function fetchData() {
  try {
    const res = await fetch("https://i.opentidkeio.jp/data/traffic_info.json?cache=" + Date.now());
    const data = await res.json();

    // 更新時刻
    const t = data.up?.[0]?.dt?.[0];
    if (t) {
      const hh = String(parseInt(t.hh) % 24).padStart(2,"0");
      document.getElementById("updateTime").textContent =
        `データ最終更新: ${t.yy}/${t.mt}/${t.dy} ${hh}:${t.mm}:${t.ss}`;
    }

    const keioTable = document.getElementById("keioTable");
    const inokTable = document.getElementById("inokTable");
    keioTable.innerHTML = keioTable.rows[0].outerHTML;
    inokTable.innerHTML = inokTable.rows[0].outerHTML;

    const allTrains = [];

    function addRows(section, table) {
      section.forEach(st => {
        st.ps.forEach(p => {
          const id = st.id;
          const trNo = p.tr.trim();
          const sy = syMap[p.sy] || {name:"不明", class:""};
          const ik = idMap[p.ik_tr.padStart(3,"0")] || "不明";
          const pos =
            id.startsWith("E") ? idMap[id.slice(1)] + "駅構内" :
            id.startsWith("U") ? idMap[(+id.slice(1)+1).toString().padStart(3,"0")] + "〜" + idMap[id.slice(1)] + "間 上り" :
            id.startsWith("D") ? idMap[id.slice(1)] + "〜" + idMap[(+id.slice(1)-1).toString().padStart(3,"0")] + "間 下り" :
            "不明";
          const updown = parseInt(id.slice(1)) % 2 === 0 ? "上り" : "下り";
          const delay = p.dl === "00" ? "平常" : p.dl + "分遅れ";
          allTrains.push({table, trNo, sy, updown, pos, ik, sr:p.sr, bs:p.bs, delay, delayNum: parseInt(p.dl)});
        });
      });
    }

    if (data.TS) addRows(data.TS, keioTable);
    if (data.TB) addRows(data.TB, inokTable);

    // 備考判定 & 遅延通知処理
    const trCount = {};
    allTrains.forEach(t => trCount[t.trNo] = (trCount[t.trNo] || 0) + 1);
    let delayData = loadDelayData();

    allTrains.forEach(t => {
      let remarks = "";
      if (t.sy.name === "特急" && t.sr === "8") remarks = "特急（8両編成）";
      if (trCount[t.trNo] > 1) remarks += (remarks ? "／" : "") + "車両交換予定";
      if (t.delayNum >= 15) {
        if (!delayData.list.find(x => x.trNo === t.trNo)) {
          delayData.list.push({ trNo: t.trNo, delay: t.delay, time: new Date().toLocaleTimeString() });
        }
      }
      const row = `<tr>
        <td>${t.updown}</td>
        <td>${t.trNo}</td>
        <td>${t.ik}</td>
        <td class="${t.sy.class}">${t.sy.name}</td>
        <td>${t.sr}</td>
        <td>${t.pos}</td>
        <td>${t.bs}</td>
        <td>${t.delay}</td>
        <td>${remarks}</td>
      </tr>`;
      t.table.insertAdjacentHTML("beforeend", row);
    });

    // 通知表示
    const noticeBox = document.getElementById("delayNotice");
    const list = document.getElementById("delayList");
    list.innerHTML = "";
    if (delayData.list.length > 0) {
      noticeBox.style.display = "block";
      delayData.list.forEach(d => {
        const li = document.createElement("li");
        li.textContent = `${d.trNo}列車 (${d.delay}) [記録時刻 ${d.time}]`;
        list.appendChild(li);
      });
    } else {
      noticeBox.style.display = "none";
    }

    saveDelayData(delayData);
    resetIfAfter115();

  } catch (e) {
    document.getElementById("updateTime").textContent = "更新失敗：" + e.message;
  }
}

// 並び替え
function makeSortable(tableId) {
  const table = document.getElementById(tableId);
  const headers = table.querySelectorAll("th.sortable");
  headers.forEach((th, idx) => {
    th.addEventListener("click", () => {
      const rows = Array.from(table.querySelectorAll("tr:nth-child(n+2)"));
      const asc = !th.classList.contains("asc");
      headers.forEach(h => h.classList.remove("asc", "desc"));
      th.classList.add(asc ? "asc" : "desc");
      rows.sort((a, b) => {
        const A = a.children[idx].textContent;
        const B = b.children[idx].textContent;
        return asc ? A.localeCompare(B, "ja") : B.localeCompare(A, "ja");
      });
      rows.forEach(r => table.appendChild(r));
    });
  });
}

fetchData();
setInterval(fetchData, 1000);
setInterval(updateLocalTime, 1000);
updateLocalTime();
makeSortable("keioTable");
makeSortable("inokTable");
</script>
</body>
</html>
