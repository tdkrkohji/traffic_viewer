<!DOCTYPE html>
<html lang="ja" data-version="v0.1.31a">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>運行中列車 — v0.1.31a</title>
<style>
:root{
  --bg:#f6f8fa; --panel:#ffffff; --muted:#6e7781; --border:#d0d7de; --accent:#0969da;
  --tokkyu:#FF4C7C; --kyuko:#00B66A; --kaisoku:#0082FF; --kukan:#D8D100; --kakutei:#ced0d4; --liner:#c71585; --linermt:#32cd32;
  --text:#24292e;
}
[data-theme="dark"]{
  --bg:#0d1117; --panel:#0b1117; --muted:#9aa4b2; --border:#30363d; --accent:#58a6ff;
  --tokkyu:#ff6b6b; --kyuko:#7bd389; --kaisoku:#8cc8ff; --kukan:#ffd86b; --kakutei:#5a5f66; --liner:#191970; --linermt:#32cd32;
  --text:#c9d1d9;
}
html,body{height:100%}
body{
  margin:0; font-family:"Segoe UI","Hiragino Kaku Gothic ProN","Yu Gothic",Meiryo,Arial,sans-serif;
  background:var(--bg); color:var(--text); -webkit-font-smoothing:antialiased;
  line-height:1.45; font-size:13px; padding-bottom:120px;
}
header{padding:14px 12px; text-align:center}
h1{margin:6px 0; font-size:18px}
#meta{font-size:12px;color:var(--muted); display:flex; gap:12px; justify-content:center; align-items:center; flex-wrap:wrap}
.tab-bar{display:flex; justify-content:center; gap:8px; padding:8px 12px}
.tab-btn{
  background:var(--panel); border:1px solid var(--border); padding:8px 14px; border-radius:8px;
  cursor:pointer; color:var(--text); font-weight:600;
}
.tab-btn.active{border-color:var(--accent); color:var(--accent);}
.subtabs{display:flex; justify-content:center; gap:8px; margin-top:6px}
.subtab{background:var(--panel); border:1px solid var(--border); padding:6px 10px; border-radius:6px; cursor:pointer}
.subtab.active{border-color:var(--accent); color:var(--accent); font-weight:600}
.container{max-width:1100px; margin:14px auto; padding:0 12px}
.table-wrap{overflow-x:auto; border:1px solid var(--border); border-radius:6px; background:var(--panel); padding:6px; margin-top:8px}
table{width:100%; min-width:760px; border-collapse:collapse; margin:0; background:transparent}
th,td{padding:8px 10px; border:1px solid var(--border); text-align:center; white-space:nowrap}
th{background:transparent; cursor:pointer; font-weight:600}
th.sorted-asc::after{content:" ▲"; font-weight:600}
th.sorted-desc::after{content:" ▼"; font-weight:600}
tr:hover td{background: rgba(0,0,0,0.03);}
.badge{padding:4px 6px; border-radius:4px; display:inline-block}
.tokkyu{background:var(--tokkyu); color:#fff}
.kyuko{background:var(--kyuko); color:#fff}
.kaisoku{background:var(--kaisoku); color:#fff}
.kukan{background:var(--kukan); color:#000}
.kakutei{background:var(--kakutei); color:#000}
#alerts{max-width:1100px; margin:14px auto; background:var(--panel); border:1px solid var(--border); border-radius:8px; padding:12px}
#alerts h3{margin:0 0 8px; font-size:14px}
.alert-item{padding:8px; border-radius:6px; margin-bottom:8px; font-size:13px}
.alert-delay{background:#ffdfe0; color:#900}
.alert-exchange{background:#fff6d6; color:#8a5b00}
.controls{max-width:1100px; margin:8px auto; display:flex; justify-content:flex-end; gap:8px; align-items:center; padding:0 12px}
select.control, button.control{padding:6px 10px; border-radius:6px; border:1px solid var(--border); background:var(--panel); color:var(--text); cursor:pointer}
footer{margin-top:30px; text-align:center; color:var(--muted); font-size:13px}
@media (max-width:720px){
  body{font-size:12px}
  th,td{padding:6px 8px; font-size:12px}
  .controls{justify-content:center}
}
</style>
</head>
<body>

<header>
  <h1>運行中列車 <small style="font-size:0.7em;color:var(--muted)">v0.1.3</small></h1>
  <div id="meta">
    <div id="updateTime">データ更新: —</div>
    <div id="localTime">現在時刻: —</div>
  </div>
</header>

<div class="tab-bar" role="tablist" aria-label="路線切替">
  <button class="tab-btn active" data-line="keio">京王線</button>
  <button class="tab-btn" data-line="inok">井の頭線</button>
</div>

<div class="container">
  <section id="keio" class="line-block">
    <div class="subtabs" role="tablist" aria-label="上下切替">
      <button class="subtab active" data-dir="up">上り</button>
      <button class="subtab" data-dir="down">下り</button>
    </div>

    <div class="table-wrap" id="keio-up-wrap">
      <table id="keio-up">
        <thead>
          <tr>
            <th data-key="updown">運用記号</th>
            <th data-key="tr">列車番号</th>
            <th data-key="ik">行先</th>
            <th data-key="sy">種別</th>
            <th data-key="sr">両数</th>
            <th data-key="pos">現在位置</th>
            <th data-key="bs">番線</th>
            <th data-key="dl">遅れ</th>
            <th data-key="remarks">備考</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="table-wrap" id="keio-down-wrap" style="display:none;">
      <table id="keio-down">
        <thead>
          <tr>
            <th data-key="updown">運用記号</th>
            <th data-key="tr">列車番号</th>
            <th data-key="ik">行先</th>
            <th data-key="sy">種別</th>
            <th data-key="sr">両数</th>
            <th data-key="pos">現在位置</th>
            <th data-key="bs">番線</th>
            <th data-key="dl">遅れ</th>
            <th data-key="remarks">備考</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <section id="inok" class="line-block" style="display:none;">
    <div class="subtabs" role="tablist" aria-label="上下切替">
      <button class="subtab active" data-dir="up">上り</button>
      <button class="subtab" data-dir="down">下り</button>
    </div>

    <div class="table-wrap" id="inok-up-wrap">
      <table id="inok-up">
        <thead>
          <tr>
            <th data-key="updown">上下</th>
            <th data-key="tr">列車番号</th>
            <th data-key="ik">行先</th>
            <th data-key="sy">種別</th>
            <th data-key="sr">両数</th>
            <th data-key="pos">現在位置</th>
            <th data-key="bs">番線</th>
            <th data-key="dl">遅れ</th>
            <th data-key="remarks">備考</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="table-wrap" id="inok-down-wrap" style="display:none;">
      <table id="inok-down">
        <thead>
          <tr>
            <th data-key="updown">上下</th>
            <th data-key="tr">列車番号</th>
            <th data-key="ik">行先</th>
            <th data-key="sy">種別</th>
            <th data-key="sr">両数</th>
            <th data-key="pos">現在位置</th>
            <th data-key="bs">番線</th>
            <th data-key="dl">遅れ</th>
            <th data-key="remarks">備考</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>
</div>

<div id="alerts" role="region" aria-live="polite">
  <h3>通知</h3>
  <div id="alertsInner">特記事項はありません。</div>
  <div style="margin-top:8px;font-size:12px;color:var(--muted)">
    通知は発生から翌日 01:15 までブラウザに保存されます（ローカルストレージ）。
  </div>
</div>

<div class="controls" role="toolbar" aria-label="設定">
  <label for="intervalSelect" style="color:var(--muted);margin-right:6px">更新間隔</label>
  <select id="intervalSelect" class="control" aria-label="更新間隔">
    <option value="10000">10秒</option>
    <option value="30000" selected>30秒</option>
    <option value="60000">1分</option>
    <option value="180000">3分</option>
  </select>

  <button id="themeBtn" class="control" style="margin-left:8px">ダークモード：無効</button>
</div>

<footer><div>v0.1.3</div></footer>

<script>
/* === 以下の既存ロジックは一切削除・改変なし === */
/* （省略）: あなたが提示した fetchAndRender や各種関数すべてここに含む */

/* === ここにあなたが既に貼ってくれた全スクリプト（fetchAndRender等）をそのまま残してください === */

/* === ↓ 追加部分のみ ↓ === */

// ▼ 運用データマップ
const operationMap = {};

// ▼ toei.txt 読み込み
async function loadOperationMap() {
  try {
    const res = await fetch("toei.txt");
    if (!res.ok) throw new Error("toei.txt 読み込み失敗");
    const text = await res.text();
    const lines = text.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
    let currentOp = null;
    for (const line of lines) {
      const opMatch = line.match(/^\(?(\d+)T\)?/);
      if (opMatch) { currentOp = opMatch[1]; continue; }
      const trMatch = line.match(/^(\d{4}A?)/);
      if (trMatch && currentOp) operationMap[trMatch[1]] = currentOp + "T";
    }
    console.log("[toei.txt 読み込み完了]", Object.keys(operationMap).length);
  } catch (e) { console.error("[toei.txt 読み込み失敗]", e); }
}

function getOperationByTrain(trNo){ return operationMap[trNo] || ""; }

// ▼ renderFromSection をフック
const origRenderFromSection = renderFromSection;
renderFromSection = function(section) {
  origRenderFromSection(section);
  document.querySelectorAll("table").forEach(tbl=>{
    const ths = tbl.tHead.rows[0];
    if (!ths.querySelector("th[data-key='op']")) {
      const th=document.createElement("th");
      th.textContent="運用";
      th.setAttribute("data-key","op");
      ths.insertBefore(th, ths.children[1]);
    }
    Array.from(tbl.tBodies[0].rows).forEach(r=>{
      const trNo=r.cells[1]?.innerText.trim();
      const op=getOperationByTrain(trNo);
      const td=document.createElement("td");
      td.textContent=op||"-";
      r.insertBefore(td, r.children[1]);
    });
  });
};

document.addEventListener("DOMContentLoaded",loadOperationMap);
</script>
</body>
</html>
