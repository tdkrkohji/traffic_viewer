<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>京王線 列車運行情報</title>

<style>
body {
  font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
  margin: 10px;
}

h2 {
  text-align: center;
}

table {
  border-collapse: collapse;
  width: 100%;
  font-size: 14px;
}

th, td {
  border: 1px solid #ccc;
  padding: 6px;
  text-align: center;
  white-space: nowrap;
}

th {
  background: #f3f3f3;
}

/* 種別 */
.tokkyu { background:#ffdddd; }
.kyuko { background:#ffeacc; }
.kaisoku { background:#e6f0ff; }
.kukan { background:#fff3cc; }
.kakutei { background:#e8ffe8; }
.liner { background:#f0e6ff; }

/* 遅延 */
.delay {
  color: #d00000;
  font-weight: bold;
}

/* 駅間 */
.between {
  color: #666;
  font-style: italic;
}

/* スマホ対応 */
@media (max-width: 768px) {
  table {
    font-size: 12px;
  }
  th, td {
    padding: 4px;
  }
}
</style>
</head>
<body>

<h2>京王線 列車運行情報</h2>
<p id="updated" style="text-align:center;"></p>

<table>
  <thead>
    <tr>
      <th>列車番号</th>
      <th>行先</th>
      <th>種別</th>
      <th>両数</th>
      <th>現在位置</th>
      <th>番線</th>
      <th>遅れ</th>
      <th>備考</th>
    </tr>
  </thead>
  <tbody id="train-body"></tbody>
</table>

<script>
/* ===== 駅コード ===== */
const stationMap = {
  1:"京王線新宿",2:"笹塚",3:"代田橋",4:"明大前",5:"下高井戸",6:"桜上水",7:"上北沢",
  8:"八幡山",9:"芦花公園",10:"千歳烏山",11:"仙川",12:"つつじヶ丘",13:"柴崎",14:"国領",
  15:"布田",16:"調布",17:"西調布",18:"飛田給",19:"武蔵野台",20:"多磨霊園",21:"東府中",
  22:"府中",23:"分倍河原",24:"中河原",25:"聖蹟桜ヶ丘",26:"百草園",27:"高幡不動",28:"南平",
  29:"平山城址公園",30:"長沼",31:"北野",32:"京王八王子",
  44:"京王多摩川",45:"京王稲田堤",46:"京王よみうりランド",47:"稲城",
  48:"若葉台",49:"京王永山",50:"京王多摩センター",51:"京王堀之内",52:"南大沢",
  53:"多摩境",54:"橋本",
  81:"渋谷",82:"神泉",83:"駒場東大前",84:"池ノ上",85:"下北沢",86:"新代田",
  87:"東松原",88:"明大前",89:"永福町",90:"西永福",91:"浜田山",92:"高井戸",
  93:"富士見ヶ丘",94:"久我山",95:"三鷹台",96:"井の頭公園",97:"吉祥寺",
  300:"京王線新宿・都営新宿線方面",301:"都営新宿線方面",
  302:"京王線新宿方面",303:"調布方面",
  304:"高幡不動方面",400:"京王八王子方面",
  401:"高尾山口方面",402:"橋本方面"
};

/* ===== 種別 ===== */
const syMap = {
  1:{name:"特急", cls:"tokkyu"},
  2:{name:"急行", cls:"kyuko"},
  3:{name:"快速", cls:"kaisoku"},
  5:{name:"区間急行", cls:"kukan"},
  6:{name:"各停", cls:"kakutei"},
  9:{name:"ライナー", cls:"liner"},
  11:{name:"ライナー", cls:"liner"}
};

function render() {
  fetch("https://i.opentidkeio.jp/data/traffic_info.json")
    .then(res => res.json())
    .then(data => {
      const tbody = document.getElementById("train-body");
      tbody.innerHTML = "";

      document.getElementById("updated").textContent =
        "最終更新: " + data.up;

      data.TS.forEach(group => {
        group.ps.forEach(t => {

          const tr = document.createElement("tr");
          const sy = syMap[t.sy] || {name:"不明", cls:""};

          /* 現在位置 */
          let posText = stationMap[t.ik] || "";
          let posClass = "";
          if (!stationMap[t.ik]) {
            posText = "駅間走行中";
            posClass = "between";
          }

          /* 遅延 */
          let delayText = "";
          let delayClass = "";
          if (t.dl && t.dl > 0) {
            delayText = t.dl + "分";
            delayClass = "delay";
          }

          tr.innerHTML = `
            <td>${t.tr || ""}</td>
            <td>${stationMap[t.ik_tr] || ""}</td>
            <td class="${sy.cls}">${sy.name}</td>
            <td>${t.sr || ""}</td>
            <td class="${posClass}">${posText}</td>
            <td>${t.bs || ""}</td>
            <td class="${delayClass}">${delayText}</td>
            <td>${t.inf || ""}</td>
          `;
          tbody.appendChild(tr);
        });
      });
    });
}

/* 初回表示 */
render();

/* 30秒ごとに自動更新 */
setInterval(render, 30000);
</script>

</body>
</html>
