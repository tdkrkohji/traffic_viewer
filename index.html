<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>é‹è¡Œä¸­åˆ—è»Š</title>
<style>
:root {
  --bg:#f7f8fa; --fg:#222;
  --table-bg:#fff; --table-border:#e6e9ec;
  --th-bg:#fbfdff;
  --notif-bg:#fff3f3; --notif-border:#f2c0c0;
  --tokkyu:#d32f2f; --kyuko:#388e3c;
  --kaisoku:#1976d2; --kukan:#fff176;
  --kakutei:#e0e0e0;
}
body.dark {
  --bg:#1e1e1e; --fg:#ddd;
  --table-bg:#2a2a2a; --table-border:#3a3a3a;
  --th-bg:#333; --notif-bg:#2b2b2b; --notif-border:#555;
  --kakutei:#555;
}
body {
  font-family: "Segoe UI", system-ui, -apple-system, "Helvetica Neue", Arial;
  margin: 0; background: var(--bg); color: var(--fg);
  font-size: 15px; transition: background 0.3s, color 0.3s;
}
header { padding: 16px 12px; text-align: center; position: relative; }
h1 { margin: 0; font-size: 20px; }
#themeToggle { position: absolute; right: 15px; top: 15px; border: none; background: none; font-size: 20px; cursor: pointer; color: var(--fg); }
#meta { display: flex; gap: 12px; justify-content: center; align-items: center; margin-top: 8px; font-size: 13px; }

.tabs {
  display: flex; justify-content: center; margin: 10px auto 0; gap: 10px;
}
.tab-btn {
  border: 1px solid var(--table-border); background: var(--th-bg);
  padding: 6px 12px; cursor: pointer; border-radius: 6px 6px 0 0;
  font-size: 14px; transition: all 0.3s;
}
.tab-btn.active {
  background: var(--table-bg); border-bottom: 1px solid var(--table-bg);
  font-weight: bold;
}

main { padding: 10px 8px 140px; }
h2 { margin: 18px 0 8px; font-size: 17px; text-align: center; }
.table-container { overflow-x: auto; }
table { width: 95%; max-width: 1000px; margin: 0 auto 24px; border-collapse: collapse;
        background: var(--table-bg); box-shadow: 0 1px 3px rgba(0,0,0,0.04); min-width: 600px; }
th, td { padding: 8px 10px; border: 1px solid var(--table-border); text-align: center;
         font-size: 14px; white-space: nowrap; }
th { background: var(--th-bg); position: sticky; top: 0; cursor: pointer; user-select: none; }
th.sorted-asc::after { content:" â–²"; font-size:12px; }
th.sorted-desc::after { content:" â–¼"; font-size:12px; }
tr:hover td { background: rgba(0,0,0,0.05); }

.tokkyu { color:#fff; background:var(--tokkyu); }
.kyuko { color:#fff; background:var(--kyuko); }
.kaisoku { color:#fff; background:var(--kaisoku); }
.kukan { color:#000; background:var(--kukan); }
.kakutei { color:#000; background:var(--kakutei); }

#notification {
  position: fixed; left: 8px; right: 8px; bottom: 8px;
  background: var(--notif-bg); border: 1px solid var(--notif-border);
  padding: 10px; border-radius: 8px; box-shadow: 0 4px 16px rgba(0,0,0,0.06);
  max-height: 180px; overflow: auto; transition: background 0.3s, color 0.3s;
  font-size: 14px;
}
#notification h3 { margin: 0 0 8px; text-align: center; font-size: 15px; }
#notification ul { margin: 0; padding: 0; list-style: none; }
#notification li { padding: 4px 6px; border-radius: 4px; margin-bottom: 4px; }
.notif-delay { background:#ffdfe0; color:#900; }
.notif-exchange { background:#fff6d6; color:#8a5b00; }
body.dark .notif-delay { background:#662828; color:#ffbebe; }
body.dark .notif-exchange { background:#554400; color:#ffeaaa; }

@media (max-width:600px){
  h1{font-size:18px;} h2{font-size:15px;} body{font-size:14px;}
  th,td{font-size:13px;padding:6px 8px;} #notification{font-size:13px;padding:8px;}
}
</style>
</head>
<body>
<header>
  <h1>é‹è¡Œä¸­åˆ—è»Š</h1>
  <button id="themeToggle">ğŸŒ™</button>
  <div id="meta">
    <div id="updateTime">ãƒ‡ãƒ¼ã‚¿æ›´æ–°ä¸­...</div>
    <div id="localTime">ç¾åœ¨æ™‚åˆ»: --:--:--</div>
  </div>
</header>

<div class="tabs">
  <button class="tab-btn active" data-tab="keio">äº¬ç‹ç·šãƒ»ç›¸æ¨¡åŸç·š</button>
  <button class="tab-btn" data-tab="inok">äº•ã®é ­ç·š</button>
</div>

<main>
  <div id="keio" class="tab-content">
    <div class="table-container">
      <table id="keioTable">
        <thead>
          <tr>
            <th>ä¸Šä¸‹</th><th>åˆ—è»Šç•ªå·</th><th>è¡Œå…ˆ</th><th>ç¨®åˆ¥</th><th>ä¸¡æ•°</th>
            <th>ç¾åœ¨ä½ç½®</th><th>ç•ªç·š</th><th>é…ã‚Œ</th><th>å‚™è€ƒ</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div id="inok" class="tab-content" style="display:none;">
    <div class="table-container">
      <table id="inokTable">
        <thead>
          <tr>
            <th>ä¸Šä¸‹</th><th>åˆ—è»Šç•ªå·</th><th>è¡Œå…ˆ</th><th>ç¨®åˆ¥</th><th>ä¸¡æ•°</th>
            <th>ç¾åœ¨ä½ç½®</th><th>ç•ªç·š</th><th>é…ã‚Œ</th><th>å‚™è€ƒ</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</main>

<div id="notification">
  <h3>é€šçŸ¥</h3>
  <ul id="notifList"></ul>
</div>

<script>
// ===== ãƒ†ãƒ¼ãƒåˆ‡æ›¿ =====
const themeToggle=document.getElementById("themeToggle");
if(localStorage.getItem("theme")==="dark"){document.body.classList.add("dark");themeToggle.textContent="â˜€ï¸";}
themeToggle.onclick=()=>{
  const dark=document.body.classList.toggle("dark");
  themeToggle.textContent=dark?"â˜€ï¸":"ğŸŒ™";
  localStorage.setItem("theme",dark?"dark":"light");
};

// ===== ã‚¿ãƒ–åˆ‡æ›¿ =====
document.querySelectorAll(".tab-btn").forEach(btn=>{
  btn.onclick=()=>{
    document.querySelectorAll(".tab-btn").forEach(b=>b.classList.remove("active"));
    document.querySelectorAll(".tab-content").forEach(c=>c.style.display="none");
    btn.classList.add("active");
    document.getElementById(btn.dataset.tab).style.display="block";
  };
});

// ===== æ™‚è¨ˆ =====
function updateClock(){
  document.getElementById("localTime").textContent="ç¾åœ¨æ™‚åˆ»: "+new Date().toLocaleTimeString();
}
setInterval(updateClock,1000);updateClock();

// ===== ãƒ‡ãƒ¼ã‚¿ãƒãƒƒãƒ— =====
const idMap={
  1:"äº¬ç‹ç·šæ–°å®¿",2:"ç¬¹å¡š",3:"ä»£ç”°æ©‹",4:"æ˜å¤§å‰",5:"ä¸‹é«˜äº•æˆ¸",6:"æ¡œä¸Šæ°´",7:"ä¸ŠåŒ—æ²¢",8:"å…«å¹¡å±±",
  9:"èŠ¦èŠ±å…¬åœ’",10:"åƒæ­³çƒå±±",11:"ä»™å·",12:"ã¤ã¤ã˜ãƒ¶ä¸˜",13:"æŸ´å´",14:"å›½é ˜",15:"å¸ƒç”°",16:"èª¿å¸ƒ",
  17:"è¥¿èª¿å¸ƒ",18:"é£›ç”°çµ¦",19:"æ­¦è”µé‡å°",20:"å¤šç£¨éœŠåœ’",21:"æ±åºœä¸­",22:"åºœä¸­",23:"åˆ†å€æ²³åŸ",
  24:"ä¸­æ²³åŸ",25:"è–è¹Ÿæ¡œãƒ¶ä¸˜",26:"ç™¾è‰åœ’",27:"é«˜å¹¡ä¸å‹•",28:"å—å¹³",29:"å¹³å±±åŸå€å…¬åœ’",30:"é•·æ²¼",
  31:"åŒ—é‡",32:"äº¬ç‹å…«ç‹å­",44:"äº¬ç‹å¤šæ‘©å·",45:"äº¬ç‹ç¨²ç”°å ¤",46:"äº¬ç‹ã‚ˆã¿ã†ã‚Šãƒ©ãƒ³ãƒ‰",47:"ç¨²åŸ",
  48:"è‹¥è‘‰å°",49:"äº¬ç‹æ°¸å±±",50:"äº¬ç‹å¤šæ‘©ã‚»ãƒ³ã‚¿ãƒ¼",51:"äº¬ç‹å €ä¹‹å†…",52:"å—å¤§æ²¢",53:"å¤šæ‘©å¢ƒ",54:"æ©‹æœ¬",
  81:"æ¸‹è°·",82:"ç¥æ³‰",83:"é§’å ´æ±å¤§å‰",84:"æ± ãƒä¸Š",85:"ä¸‹åŒ—æ²¢",86:"æ–°ä»£ç”°",87:"æ±æ¾åŸ",88:"æ˜å¤§å‰",
  89:"æ°¸ç¦ç”º",90:"è¥¿æ°¸ç¦",91:"æµœç”°å±±",92:"é«˜äº•æˆ¸",93:"å¯Œå£«è¦‹ãƒ¶ä¸˜",94:"ä¹…æˆ‘å±±",95:"ä¸‰é·¹å°",96:"äº•ã®é ­å…¬åœ’",
  97:"å‰ç¥¥å¯º",
  101:"æ–°å®¿ä¸‰ä¸ç›®",102:"æ›™æ©‹",103:"å¸‚ãƒ¶è°·",104:"ä¹æ®µä¸‹",105:"ç¥ä¿ç”º",106:"å°å·ç”º",107:"å²©æœ¬ç”º",
  108:"é¦¬å–°æ¨ªå±±",109:"æµœç”º",110:"æ£®ä¸‹",111:"èŠå·",112:"ä½å‰",113:"è¥¿å¤§å³¶",114:"å¤§å³¶",115:"æ±å¤§å³¶",
  116:"èˆ¹å €",117:"ä¸€ä¹‹æ±Ÿ",118:"ç‘æ±Ÿ",119:"ç¯ å´",120:"æœ¬å…«å¹¡",
  300:"äº¬ç‹ç·šæ–°å®¿ãƒ»éƒ½å–¶æ–°å®¿ç·šæ–¹é¢",301:"éƒ½å–¶æ–°å®¿ç·šæ–¹é¢",302:"äº¬ç‹ç·šæ–°å®¿æ–¹é¢",303:"èª¿å¸ƒæ–¹é¢",
  304:"é«˜å¹¡ä¸å‹•æ–¹é¢",305:"å…«å¹¡å±±æ–¹é¢",306:"ç¬¹å¡šæ–¹é¢",400:"äº¬ç‹å…«ç‹å­æ–¹é¢",401:"é«˜å°¾å±±å£æ–¹é¢",
  402:"æ©‹æœ¬æ–¹é¢",403:"åºœä¸­ãƒ»åºœä¸­ç«¶é¦¬æ­£é–€å‰æ–¹é¢",501:"æ˜å¤§å‰ãƒ»æ°¸ç¦ç”ºæ–¹é¢",502:"å‰ç¥¥å¯ºæ–¹é¢"
};
const syMap={1:{name:"ç‰¹æ€¥",class:"tokkyu"},2:{name:"æ€¥è¡Œ",class:"kyuko"},3:{name:"å¿«é€Ÿ",class:"kaisoku"},
5:{name:"åŒºé–“æ€¥è¡Œ",class:"kukan"},6:{name:"å„åœ",class:"kakutei"},9:{name:"ãƒ©ã‚¤ãƒŠãƒ¼",class:"tokkyu"},
11:{name:"ãƒ©ã‚¤ãƒŠãƒ¼",class:"tokkyu"}};

// ===== ä¸¦ã³æ›¿ãˆ =====
function makeSortable(table){
  const ths=table.querySelectorAll("th");
  ths.forEach((th,i)=>{
    th.addEventListener("click",()=>{
      const rows=[...table.tBodies[0].rows];
      const asc=!th.classList.contains("sorted-asc");
      ths.forEach(x=>x.classList.remove("sorted-asc","sorted-desc"));
      th.classList.add(asc?"sorted-asc":"sorted-desc");
      rows.sort((a,b)=>{
        const A=a.cells[i].innerText,B=b.cells[i].innerText;
        if(!isNaN(A)&&!isNaN(B))return asc?A-B:B-A;
        return asc?A.localeCompare(B,"ja"):B.localeCompare(A,"ja");
      });
      rows.forEach(r=>table.tBodies[0].appendChild(r));
    });
  });
}

// ===== ãƒ‡ãƒ¼ã‚¿å–å¾— =====
async function fetchData(){
  try{
    const res=await fetch("https://i.opentidkeio.jp/data/traffic_info.json?cache="+Date.now());
    const data=await res.json();
    const t=data.up?.[0]?.dt?.[0];
    if(t)document.getElementById("updateTime").textContent=`ãƒ‡ãƒ¼ã‚¿æœ€çµ‚æ›´æ–°: ${t.yy}/${t.mt}/${t.dy} ${t.hh}:${t.mm}:${t.ss}`;
    const keio=document.querySelector("#keioTable tbody");
    const inok=document.querySelector("#inokTable tbody");
    keio.innerHTML=""; inok.innerHTML="";
    const notif=document.querySelector("#notifList");
    notif.innerHTML=""; const note=[],trainIDs=new Map();

    function render(section,tbody){
      section.forEach(st=>{
        st.ps.forEach(p=>{
          const trNo=p.tr.trim(); const sy=syMap[p.sy]||{name:"ä¸æ˜",class:""};
          const ik=parseInt(p.ik_tr),dest=idMap[ik]||"ä¸æ˜";
          const updown=(parseInt(st.id.slice(1))%2===0)?"ä¸Šã‚Š":"ä¸‹ã‚Š";
          const pos=idMap[st.id.slice(1)]||"åŒºé–“ä¸æ˜";
          const delay=parseInt(p.dl)||0; const delayTxt=delay?`${delay}åˆ†é…ã‚Œ`:"å¹³å¸¸";
          let remarks=[];
          if(sy.name==="ç‰¹æ€¥"&&p.sr==="8")remarks.push("ç‰¹æ€¥ï¼ˆ8ä¸¡ç·¨æˆï¼‰");
          if(trainIDs.has(trNo)){remarks.push("è»Šä¸¡äº¤æ›äºˆå®š");note.push({t:"äº¤æ›",text:`${trNo}ï¼šè»Šä¸¡äº¤æ›äºˆå®š`});}
          else trainIDs.set(trNo,true);
          if(delay>=15)note.push({t:"é…å»¶",text:`${trNo}ï¼š${delay}åˆ†é…ã‚Œ`});
          if(ik>=101&&ik<=120)remarks.push("éƒ½å–¶æ–°å®¿ç·šç›´é€š");
          tbody.insertAdjacentHTML("beforeend",
            `<tr><td>${updown}</td><td>${trNo}</td><td>${dest}</td><td class="${sy.class}">${sy.name}</td>
             <td>${p.sr}</td><td>${pos}</td><td>${p.bs}</td><td>${delayTxt}</td><td>${remarks.join("ãƒ»")}</td></tr>`);
        });
      });
    }
    if(data.TS)render(data.TS,keio);
    if(data.TB)render(data.TB,inok);
    note.forEach(n=>{
      const li=document.createElement("li");
      li.textContent=n.text;
      li.classList.add(n.t==="é…å»¶"?"notif-delay":"notif-exchange");
      notif.appendChild(li);
    });
    makeSortable(document.getElementById("keioTable"));
    makeSortable(document.getElementById("inokTable"));
  }catch(e){document.getElementById("updateTime").textContent="æ›´æ–°å¤±æ•—ï¼š"+e.message;}
}
fetchData();
setInterval(fetchData,30000);
</script>
</body>
</html>
