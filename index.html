<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>äº¬ç‹ç·šãƒ»äº•ã®é ­ç·š åœ¨ç·šçŠ¶æ³</title>
<style>
  body { font-family: "Segoe UI", sans-serif; text-align: center; background: #f8f8f8; margin-bottom: 120px; }
  h1, h2 { margin-top: 30px; }
  table { border-collapse: collapse; margin: 10px auto; width: 95%; max-width: 1000px; background: #fff; }
  th, td { border: 1px solid #ccc; padding: 6px 10px; text-align: center; }
  th { background: #eee; cursor: pointer; }
  tr:hover { background: #fafafa; }

  /* ç¨®åˆ¥ã‚«ãƒ©ãƒ¼ */
  .tokkyu { color: #fff; background: #d32f2f; }
  .kyuko { color: #fff; background: #388e3c; }
  .kaisoku { color: #fff; background: #1976d2; }
  .kukan { color: #000; background: #fff176; }
  .kakutei { color: #000; background: #e0e0e0; }

  /* ã‚¿ãƒ–åˆ‡æ›¿ãƒ‡ã‚¶ã‚¤ãƒ³ */
  .tab-buttons {
    display: flex; justify-content: center; border-bottom: 2px solid #ccc; margin: 10px auto; width: 95%; max-width: 1000px;
  }
  .tab-buttons button {
    flex: 1; border: none; background: none; padding: 10px; font-size: 16px; cursor: pointer;
    border-bottom: 3px solid transparent; transition: all 0.2s ease;
  }
  .tab-buttons button:hover { background: #f3f3f3; }
  .tab-buttons button.active { border-bottom: 3px solid #1976d2; color: #1976d2; font-weight: bold; }

  /* é€šçŸ¥æ¬„ */
  #notification {
    position: fixed; bottom: 0; left: 0; right: 0;
    background: #fff3cd; color: #000; border-top: 2px solid #f0ad4e;
    padding: 10px; font-size: 15px; text-align: left;
    max-height: 120px; overflow-y: auto;
  }
  #notification h3 { margin: 0 0 5px; font-size: 16px; color: #d9534f; text-align: center; }
  #notification ul { list-style: none; padding: 0; margin: 0; }
  #notification li { padding: 3px 0; }

  #updateTime, #localTime { margin: 5px 0; font-size: 14px; color: #555; }
</style>
</head>
<body>
<h1>äº¬ç‹ç·šãƒ»äº•ã®é ­ç·š åœ¨ç·šçŠ¶æ³</h1>
<p id="updateTime">ãƒ‡ãƒ¼ã‚¿æ›´æ–°ä¸­...</p>
<p id="localTime">ç¾åœ¨æ™‚åˆ»: --:--:--</p>

<!-- äº¬ç‹ç·š -->
<h2>äº¬ç‹ç·šãƒ»ç›¸æ¨¡åŸç·š</h2>
<div class="tab-buttons" id="filterKeio">
  <button data-filter="all" class="active">å…¨ã¦</button>
  <button data-filter="ä¸Šã‚Š">ä¸Šã‚Š</button>
  <button data-filter="ä¸‹ã‚Š">ä¸‹ã‚Š</button>
</div>
<table id="keioTable">
  <tr><th>ä¸Šä¸‹</th><th>åˆ—è»Šç•ªå·</th><th>è¡Œå…ˆ</th><th>ç¨®åˆ¥</th><th>ä¸¡æ•°</th><th>ç¾åœ¨ä½ç½®</th><th>ç•ªç·š</th><th>é…ã‚Œ</th><th>å‚™è€ƒ</th></tr>
</table>

<!-- äº•ã®é ­ç·š -->
<h2>äº•ã®é ­ç·š</h2>
<div class="tab-buttons" id="filterInok">
  <button data-filter="all" class="active">å…¨ã¦</button>
  <button data-filter="ä¸Šã‚Š">ä¸Šã‚Š</button>
  <button data-filter="ä¸‹ã‚Š">ä¸‹ã‚Š</button>
</div>
<table id="inokTable">
  <tr><th>ä¸Šä¸‹</th><th>åˆ—è»Šç•ªå·</th><th>è¡Œå…ˆ</th><th>ç¨®åˆ¥</th><th>ä¸¡æ•°</th><th>ç¾åœ¨ä½ç½®</th><th>ç•ªç·š</th><th>é…ã‚Œ</th><th>å‚™è€ƒ</th></tr>
</table>

<!-- é€šçŸ¥æ¬„ -->
<div id="notification">
  <h3>ğŸš¨ é‹è¡Œé€šçŸ¥</h3>
  <ul id="notifyList"><li>èª­ã¿è¾¼ã¿ä¸­...</li></ul>
</div>

<script>
const idMap = {
  1:"äº¬ç‹ç·šæ–°å®¿",2:"ç¬¹å¡š",3:"ä»£ç”°æ©‹",4:"æ˜å¤§å‰",5:"ä¸‹é«˜äº•æˆ¸",6:"æ¡œä¸Šæ°´",7:"ä¸ŠåŒ—æ²¢",8:"å…«å¹¡å±±",9:"èŠ¦èŠ±å…¬åœ’",10:"åƒæ­³çƒå±±",11:"ä»™å·",
  12:"ã¤ã¤ã˜ãƒ¶ä¸˜",13:"æŸ´å´",14:"å›½é ˜",15:"å¸ƒç”°",16:"èª¿å¸ƒ",17:"è¥¿èª¿å¸ƒ",18:"é£›ç”°çµ¦",19:"æ­¦è”µé‡å°",20:"å¤šç£¨éœŠåœ’",21:"æ±åºœä¸­",22:"åºœä¸­",
  23:"åˆ†å€æ²³åŸ",24:"ä¸­æ²³åŸ",25:"è–è¹Ÿæ¡œãƒ¶ä¸˜",26:"ç™¾è‰åœ’",27:"é«˜å¹¡ä¸å‹•",28:"å—å¹³",29:"å¹³å±±åŸå€å…¬åœ’",30:"é•·æ²¼",31:"åŒ—é‡",32:"äº¬ç‹å…«ç‹å­",
  44:"äº¬ç‹å¤šæ‘©å·",45:"äº¬ç‹ç¨²ç”°å ¤",46:"äº¬ç‹ã‚ˆã¿ã†ã‚Šãƒ©ãƒ³ãƒ‰",47:"ç¨²åŸ",48:"è‹¥è‘‰å°",49:"äº¬ç‹æ°¸å±±",50:"äº¬ç‹å¤šæ‘©ã‚»ãƒ³ã‚¿ãƒ¼",51:"äº¬ç‹å €ä¹‹å†…",
  52:"å—å¤§æ²¢",53:"å¤šæ‘©å¢ƒ",54:"æ©‹æœ¬",81:"æ¸‹è°·",82:"ç¥æ³‰",83:"é§’å ´æ±å¤§å‰",84:"æ± ãƒä¸Š",85:"ä¸‹åŒ—æ²¢",86:"æ–°ä»£ç”°",87:"æ±æ¾åŸ",88:"æ˜å¤§å‰",
  89:"æ°¸ç¦ç”º",90:"è¥¿æ°¸ç¦",91:"æµœç”°å±±",92:"é«˜äº•æˆ¸",93:"å¯Œå£«è¦‹ãƒ¶ä¸˜",94:"ä¹…æˆ‘å±±",95:"ä¸‰é·¹å°",96:"äº•ã®é ­å…¬åœ’",97:"å‰ç¥¥å¯º"
};

const syMap = {
  1:{name:"ç‰¹æ€¥", class:"tokkyu"},2:{name:"æ€¥è¡Œ", class:"kyuko"},3:{name:"å¿«é€Ÿ", class:"kaisoku"},
  5:{name:"åŒºé–“æ€¥è¡Œ", class:"kukan"},6:{name:"å„åœ", class:"kakutei"},9:{name:"ãƒ©ã‚¤ãƒŠãƒ¼", class:"tokkyu"},11:{name:"ãƒ©ã‚¤ãƒŠãƒ¼", class:"tokkyu"}
};

function updateLocalTime(){
  const now=new Date();
  document.getElementById("localTime").textContent=
    `ç¾åœ¨æ™‚åˆ»: ${now.toLocaleTimeString("ja-JP",{hour12:false})}`;
}

function getPositionLabel(id){
  const n=parseInt(id.slice(1));
  if(id.startsWith("E")) return `${idMap[n]}é§…æ§‹å†…`;
  if(id.startsWith("U")) return `${idMap[n+1]}ã€œ${idMap[n]}é–“ ä¸Šã‚Š`;
  if(id.startsWith("D")) return `${idMap[n]}ã€œ${idMap[n-1]}é–“ ä¸‹ã‚Š`;
  return "ä¸æ˜";
}

async function fetchData(){
  try{
    const res=await fetch("https://i.opentidkeio.jp/data/traffic_info.json?cache="+Date.now());
    const data=await res.json();

    const t=data.up?.[0]?.dt?.[0];
    if(t) document.getElementById("updateTime").textContent=
      `ãƒ‡ãƒ¼ã‚¿æœ€çµ‚æ›´æ–°: ${t.yy}/${t.mt}/${t.dy} ${String(t.hh%24).padStart(2,"0")}:${t.mm}:${t.ss}`;

    const keioTable=document.getElementById("keioTable");
    const inokTable=document.getElementById("inokTable");
    keioTable.innerHTML=`<tr><th>ä¸Šä¸‹</th><th>åˆ—è»Šç•ªå·</th><th>è¡Œå…ˆ</th><th>ç¨®åˆ¥</th><th>ä¸¡æ•°</th><th>ç¾åœ¨ä½ç½®</th><th>ç•ªç·š</th><th>é…ã‚Œ</th><th>å‚™è€ƒ</th></tr>`;
    inokTable.innerHTML=`<tr><th>ä¸Šä¸‹</th><th>åˆ—è»Šç•ªå·</th><th>è¡Œå…ˆ</th><th>ç¨®åˆ¥</th><th>ä¸¡æ•°</th><th>ç¾åœ¨ä½ç½®</th><th>ç•ªç·š</th><th>é…ã‚Œ</th><th>å‚™è€ƒ</th></tr>`;

    const allTrains=[];
    function addRows(section,table){
      section.forEach(st=>{
        st.ps.forEach(p=>{
          const id=st.id;
          const updown=parseInt(id.slice(1))%2===0?"ä¸Šã‚Š":"ä¸‹ã‚Š";
          const sy=syMap[p.sy]||{name:"ä¸æ˜",class:""};
          const ik=idMap[p.ik_tr.padStart(3,"0")]||"ä¸æ˜";
          const pos=getPositionLabel(id);
          const delay=p.dl==="00"?"å¹³å¸¸":p.dl+"åˆ†é…ã‚Œ";

          allTrains.push({
            tr:p.tr.trim(),sy:sy.name,syClass:sy.class,updown,ik,sr:p.sr,bs:p.bs,delay:p.dl,
            pos,id,remarks:""
          });
        });
      });
    }

    if(data.TS) addRows(data.TS,keioTable);
    if(data.TB) addRows(data.TB,inokTable);

    // å‚™è€ƒç”Ÿæˆ
    const trCount={};
    allTrains.forEach(t=>trCount[t.tr]=(trCount[t.tr]||0)+1);
    allTrains.forEach(t=>{
      if(t.sy==="ç‰¹æ€¥"&&t.sr==="8") t.remarks="ç‰¹æ€¥ï¼ˆ8ä¸¡ç·¨æˆï¼‰";
      if(trCount[t.tr]>1) t.remarks+=(t.remarks?"ï¼":"")+"è»Šä¸¡äº¤æ›äºˆå®š";
    });

    // è¡¨æç”»
    function render(table,filter,line){
      table.innerHTML=`<tr><th>ä¸Šä¸‹</th><th>åˆ—è»Šç•ªå·</th><th>è¡Œå…ˆ</th><th>ç¨®åˆ¥</th><th>ä¸¡æ•°</th><th>ç¾åœ¨ä½ç½®</th><th>ç•ªç·š</th><th>é…ã‚Œ</th><th>å‚™è€ƒ</th></tr>`;
      allTrains
        .filter(t=>line==="keio"?(parseInt(t.id.slice(1))<=54):(parseInt(t.id.slice(1))>=81))
        .filter(t=>filter==="all"||t.updown===filter)
        .forEach(t=>{
          const delayLabel=t.delay==="00"?"å¹³å¸¸":`${t.delay}åˆ†é…ã‚Œ`;
          const row=`<tr>
            <td>${t.updown}</td>
            <td>${t.tr}</td>
            <td>${t.ik}</td>
            <td class="${t.syClass}">${t.sy}</td>
            <td>${t.sr}</td>
            <td>${t.pos}</td>
            <td>${t.bs}</td>
            <td>${delayLabel}</td>
            <td data-remarks="${t.remarks}">${t.remarks}</td>
          </tr>`;
          table.insertAdjacentHTML("beforeend",row);
        });
    }

    // é€šçŸ¥æ¬„
    const notifyList=document.getElementById("notifyList");
    const notifications=[];
    allTrains.forEach(t=>{
      if(parseInt(t.delay)>=15)
        notifications.push(`${t.tr}ï¼ˆ${t.delay}åˆ†é…ã‚Œï¼‰`);
      if(t.remarks.includes("è»Šä¸¡äº¤æ›äºˆå®š"))
        notifications.push(`${t.tr}ï¼ˆè»Šä¸¡äº¤æ›äºˆå®šï¼‰`);
    });
    notifyList.innerHTML=notifications.length?
      notifications.map(n=>`<li>${n}</li>`).join(""):
      "<li>å¹³å¸¸é‹è»¢</li>";

    localStorage.setItem("notifications",JSON.stringify({
      expires:new Date(new Date().setHours(25,15,0,0)).getTime(),
      list:notifications
    }));

    render(keioTable,"all","keio");
    render(inokTable,"all","inok");

    // ã‚¿ãƒ–åˆ‡æ›¿
    function setupTabs(id,table,line){
      document.querySelectorAll(`#${id} button`).forEach(btn=>{
        btn.onclick=()=>{
          document.querySelectorAll(`#${id} button`).forEach(b=>b.classList.remove("active"));
          btn.classList.add("active");
          render(table,btn.dataset.filter,line);
        };
      });
    }
    setupTabs("filterKeio",keioTable,"keio");
    setupTabs("filterInok",inokTable,"inok");

  }catch(e){
    document.getElementById("updateTime").textContent="æ›´æ–°å¤±æ•—ï¼š"+e.message;
  }
}

// åˆå›å®Ÿè¡Œãƒ»è‡ªå‹•æ›´æ–°
fetchData();
setInterval(fetchData,30000);
setInterval(updateLocalTime,1000);
updateLocalTime();

// éå»é€šçŸ¥å¾©å…ƒ
window.addEventListener("load",()=>{
  const saved=JSON.parse(localStorage.getItem("notifications")||"{}");
  if(saved.expires>Date.now()){
    const list=document.getElementById("notifyList");
    list.innerHTML=saved.list.length?
      saved.list.map(n=>`<li>${n}</li>`).join(""):
      "<li>å¹³å¸¸é‹è»¢</li>";
  }
});
</script>
</body>
</html>
