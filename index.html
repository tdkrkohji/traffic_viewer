<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>運行中列車</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
/* 全体の基本設定 */
body {
  font-family: "Segoe UI", "Hiragino Sans", sans-serif;
  background: #f8f8f8;
  color: #222;
  text-align: center;
  margin: 0;
  font-size: 13px;
}

/* タイトル */
h1 {
  margin: 18px 0 8px;
  font-size: 1.4em;
}

/* テーブル基本デザイン */
table {
  border-collapse: collapse;
  margin: 8px auto;
  width: 95%;
  max-width: 1000px;
  background: #fff;
  font-size: 13px;
}

th, td {
  border: 1px solid #ccc;
  padding: 5px 7px;
  text-align: center;
}

th {
  background: #eee;
  cursor: pointer;
}

tr:nth-child(even) {
  background: #f9f9f9;
}

/* 種別色 */
.tokkyu { background: #d32f2f; color: #fff; }
.kyuko { background: #388e3c; color: #fff; }
.kaisoku { background: #1976d2; color: #fff; }
.kukan { background: #fff176; color: #000; }
.kakutei { background: #e0e0e0; color: #000; }

/* タブデザイン */
#tabs, .subtabs {
  display: flex;
  justify-content: center;
  margin: 10px 0;
  flex-wrap: wrap;
}

.tab, .subtab {
  padding: 5px 12px;
  border: 1px solid #aaa;
  background: #fff;
  margin: 2px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 13px;
}

.active {
  background: #1976d2;
  color: #fff;
  border-color: #1976d2;
}

/* 現在時刻・更新時間表示 */
#updateTime, #localTime {
  font-size: 12px;
  color: #555;
  margin: 4px 0;
}

/* 通知欄 */
#notifications {
  background: #fff3cd;
  border: 1px solid #ffecb5;
  padding: 6px;
  margin: 8px auto;
  width: 90%;
  max-width: 800px;
  border-radius: 6px;
  text-align: left;
  font-size: 13px;
}

/* ダークモード切替ボタン & 更新間隔セレクタ */
#modeToggle, #intervalSelect {
  position: fixed;
  bottom: 10px;
  padding: 5px 10px;
  border: none;
  border-radius: 6px;
  font-size: 13px;
  cursor: pointer;
}

#modeToggle {
  right: 10px;
  background: #444;
  color: #fff;
}

#intervalSelect {
  left: 10px;
  background: #fff;
  border: 1px solid #ccc;
}

/* スマホ対応 */
@media (max-width: 600px) {
  table { font-size: 11px; }
  th, td { padding: 4px; }
}

/* ダークモード設定 */
body.dark {
  background: #222;
  color: #eee;
}
body.dark table { background: #333; color: #eee; }
body.dark th { background: #555; }
body.dark tr:nth-child(even) { background: #2a2a2a; }
</style>
</head>

<body>
<h1>運行中列車</h1>
<p id="updateTime">データ更新中...</p>
<p id="localTime">現在時刻: --:--:--</p>

<!-- 通知欄 -->
<div id="notifications"></div>

<!-- 路線タブ -->
<div id="tabs">
  <div class="tab active" data-line="keio">京王線</div>
  <div class="tab" data-line="inok">井の頭線</div>
</div>

<!-- 各路線内容 -->
<div id="content">
  <!-- 京王線 -->
  <div class="lineTab" id="keio" style="display:block;">
    <div class="subtabs">
      <div class="subtab active" data-dir="up">上り</div>
      <div class="subtab" data-dir="down">下り</div>
    </div>
    <table id="keio-up">
      <thead><tr><th>列車番号</th><th>種別</th><th>上下</th><th>現在位置</th><th>行先</th><th>両数</th><th>番線</th><th>遅れ</th><th>備考</th></tr></thead>
      <tbody></tbody>
    </table>
    <table id="keio-down" style="display:none;">
      <thead><tr><th>列車番号</th><th>種別</th><th>上下</th><th>現在位置</th><th>行先</th><th>両数</th><th>番線</th><th>遅れ</th><th>備考</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- 井の頭線 -->
  <div class="lineTab" id="inok" style="display:none;">
    <div class="subtabs">
      <div class="subtab active" data-dir="up">上り</div>
      <div class="subtab" data-dir="down">下り</div>
    </div>
    <table id="inok-up">
      <thead><tr><th>列車番号</th><th>種別</th><th>上下</th><th>現在位置</th><th>行先</th><th>両数</th><th>番線</th><th>遅れ</th><th>備考</th></tr></thead>
      <tbody></tbody>
    </table>
    <table id="inok-down" style="display:none;">
      <thead><tr><th>列車番号</th><th>種別</th><th>上下</th><th>現在位置</th><th>行先</th><th>両数</th><th>番線</th><th>遅れ</th><th>備考</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<!-- 更新間隔選択・ダークモードボタン -->
<select id="intervalSelect">
  <option value="10000">10秒ごと</option>
  <option value="30000" selected>30秒ごと</option>
  <option value="60000">1分ごと</option>
  <option value="180000">3分ごと</option>
</select>

<button id="modeToggle">🌙</button>

<script>
/* === 駅データマップ === */
const idMap = {
  001:"京王線新宿",002:"笹塚",003:"代田橋",004:"明大前",005:"下高井戸",006:"桜上水",
  007:"上北沢",008:"八幡山",009:"芦花公園",010:"千歳烏山",011:"仙川",012:"つつじヶ丘",
  013:"柴崎",014:"国領",015:"布田",016:"調布",017:"西調布",018:"飛田給",019:"武蔵野台",
  020:"多磨霊園",021:"東府中",022:"府中",023:"分倍河原",024:"中河原",025:"聖蹟桜ヶ丘",
  026:"百草園",027:"高幡不動",028:"南平",029:"平山城址公園",030:"長沼",031:"北野",
  032:"京王八王子",044:"京王多摩川",045:"京王稲田堤",046:"京王よみうりランド",047:"稲城",
  048:"若葉台",049:"京王永山",050:"京王多摩センター",051:"京王堀之内",052:"南大沢",
  053:"多摩境",054:"橋本",
  081:"渋谷",082:"神泉",083:"駒場東大前",084:"池ノ上",085:"下北沢",086:"新代田",087:"東松原",
  088:"明大前",089:"永福町",090:"西永福",091:"浜田山",092:"高井戸",093:"富士見ヶ丘",
  094:"久我山",095:"三鷹台",096:"井の頭公園",097:"吉祥寺",
  101:"新宿三丁目",102:"曙橋",103:"市ヶ谷",104:"九段下",105:"神保町",106:"小川町",
  107:"岩本町",108:"馬喰横山",109:"浜町",110:"森下",111:"菊川",112:"住吉",113:"西大島",
  114:"大島",115:"東大島",116:"船堀",117:"一之江",118:"瑞江",119:"篠崎",120:"本八幡"
};

/* === 種別データ === */
const syMap = {
  1:{name:"特急",class:"tokkyu"},2:{name:"急行",class:"kyuko"},
  3:{name:"快速",class:"kaisoku"},5:{name:"区間急行",class:"kukan"},
  6:{name:"各停",class:"kakutei"},9:{name:"ライナー",class:"tokkyu"},
  11:{name:"ライナー",class:"tokkyu"}
};

/* === 現在時刻更新 === */
function updateLocalTime() {
  document.getElementById("localTime").textContent =
    "現在時刻: " + new Date().toLocaleTimeString("ja-JP",{hour12:false});
}
setInterval(updateLocalTime, 1000);
updateLocalTime();

/* === ダークモード切替 === */
document.getElementById("modeToggle").onclick = () => {
  document.body.classList.toggle("dark");
  document.getElementById("modeToggle").textContent =
    document.body.classList.contains("dark") ? "☀️" : "🌙";
};

/* === タブ切替 === */
document.querySelectorAll(".tab").forEach(tab=>{
  tab.onclick=()=>{
    document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
    document.querySelectorAll(".lineTab").forEach(l=>l.style.display="none");
    tab.classList.add("active");
    document.getElementById(tab.dataset.line).style.display="block";
  };
});

/* === 上下切替 === */
document.querySelectorAll(".subtab").forEach(sub=>{
  sub.onclick=()=>{
    const parent=sub.closest(".lineTab");
    parent.querySelectorAll(".subtab").forEach(s=>s.classList.remove("active"));
    parent.querySelectorAll("table").forEach(tb=>tb.style.display="none");
    sub.classList.add("active");
    parent.querySelector(`table[id$='-${sub.dataset.dir}']`).style.display="table";
  };
});

/* === データ取得 === */
async function fetchData() {
  try {
    const res = await fetch("https://i.opentidkeio.jp/data/traffic_info.json?cache="+Date.now());
    const data = await res.json();
    const t = data.up?.[0]?.dt?.[0];
    if(t) document.getElementById("updateTime").textContent = `データ最終更新: ${t.yy}/${t.mt}/${t.dy} ${t.hh}:${t.mm}:${t.ss}`;
    
    ["keio-up","keio-down","inok-up","inok-down"].forEach(id=>{
      document.querySelector(`#${id} tbody`).innerHTML="";
    });
    
    const delayNotice = new Set();
    const exchangeNotice = new Set();
    const trainMap = new Map();
    
    function addRows(section, baseId) {
      section.forEach(st=>{
        st.ps.forEach(p=>{
          const trNo = p.tr.trim();
          const sy = syMap[p.sy] || {name:"不明",class:""};
          const ik = idMap[p.ik_tr.padStart(3,"0")] || "不明";
          const pos = idMap[st.id.slice(1).padStart(3,"0")] || "不明";
          const updown = parseInt(st.id.slice(1))%2===0 ? "上り" : "下り";
          const delay = p.dl==="00" ? "平常" : `${p.dl}分遅れ`;
          let remarks = "";
          if(sy.name==="特急" && parseInt(p.sr)===8) remarks += "特急（8両編成） ";
          if(parseInt(p.ik_tr)>=101 && parseInt(p.ik_tr)<=120) remarks += "都営新宿線直通 ";
          if(trainMap.has(trNo)) {remarks += "車両交換予定 "; exchangeNotice.add(trNo);} 
          else trainMap.set(trNo,true);
          if(parseInt(p.dl)>=15) delayNotice.add(`${trNo} (${p.dl}分遅れ)`);
          
          const row = `<tr>
            <td>${trNo}</td>
            <td class="${sy.class}">${sy.name}</td>
            <td>${updown}</td>
            <td>${pos}</td>
            <td>${ik}</td>
            <td>${p.sr}</td>
            <td>${p.bs}</td>
            <td>${delay}</td>
            <td>${remarks.trim()}</td>
          </tr>`;
          
          document.querySelector(`#${baseId}-${updown==="上り"?"up":"down"} tbody`)
            .insertAdjacentHTML("beforeend", row);
        });
      });
    }
    if(data.TS) addRows(data.TS,"keio");
    if(data.TB) addRows(data.TB,"inok");
    
    let noteHTML="";
    if(delayNotice.size>0) noteHTML+="🚨 遅延15分以上: "+[...delayNotice].join(", ")+"<br>";
    if(exchangeNotice.size>0) noteHTML+="🔧 車両交換予定: "+[...exchangeNotice].join(", ");
    document.getElementById("notifications").innerHTML = noteHTML || "";
    
  } catch(e) {
    document.getElementById("updateTime").textContent = "更新失敗：" + e.message;
  }
}

/* === 更新間隔設定 === */
let fetchInterval;
function setFetchInterval(ms){
  clearInterval(fetchInterval);
  fetchInterval=setInterval(fetchData,ms);
}
document.getElementById("intervalSelect").onchange=e=>{
  const v=parseInt(e.target.value);
  localStorage.setItem("updateInterval",v);
  setFetchInterval(v);
};

/* 初期設定 */
const savedInt=parseInt(localStorage.getItem("updateInterval"))||30000;
document.getElementById("intervalSelect").value=savedInt;
fetchData();
setFetchInterval(savedInt);
</script>
</body>
</html>
