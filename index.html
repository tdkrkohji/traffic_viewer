<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>é‹è¡Œä¸­åˆ—è»Š</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  :root {
    --bg: #f6f8fa;
    --text: #24292e;
    --border: #d0d7de;
    --accent: #0969da;
    --table-bg: #ffffff;
  }
  [data-theme="dark"] {
    --bg: #0d1117;
    --text: #c9d1d9;
    --border: #30363d;
    --accent: #58a6ff;
    --table-bg: #161b22;
  }

  body {
    font-family: "Segoe UI", "Hiragino Sans", sans-serif;
    background: var(--bg);
    color: var(--text);
    margin: 0;
    padding: 0 0 80px;
    transition: background 0.3s, color 0.3s;
  }

  h1 {
    text-align: center;
    font-size: 1.8em;
    margin: 25px 0 10px;
  }

  #updateTime, #localTime {
    text-align: center;
    font-size: 0.9em;
    color: #6e7781;
    margin: 0 0 5px;
  }

  .tab-buttons {
    display: flex;
    justify-content: center;
    margin-top: 20px;
    gap: 5px;
  }

  .tab-buttons button {
    background: var(--table-bg);
    color: var(--text);
    border: 1px solid var(--border);
    padding: 8px 16px;
    cursor: pointer;
    font-size: 0.95em;
    border-radius: 6px 6px 0 0;
  }

  .tab-buttons button.active {
    background: var(--bg);
    border-bottom: 2px solid var(--accent);
    color: var(--accent);
    font-weight: bold;
  }

  table {
    border-collapse: collapse;
    margin: 0 auto 30px;
    width: 95%;
    max-width: 1000px;
    background: var(--table-bg);
    border: 1px solid var(--border);
    font-size: 0.9em;
  }

  th, td {
    border: 1px solid var(--border);
    padding: 6px 8px;
    text-align: center;
  }

  th {
    background: var(--bg);
    cursor: pointer;
  }

  tr:hover {
    background: rgba(150,150,150,0.08);
  }

  /* ç¨®åˆ¥è‰² */
  .tokkyu { background: #d32f2f; color: #fff; }
  .kyuko { background: #388e3c; color: #fff; }
  .kaisoku { background: #1976d2; color: #fff; }
  .kukan { background: #fbc02d; color: #000; }
  .kakutei { background: #9e9e9e; color: #000; }

  /* é€šçŸ¥æ¬„ */
  #alerts {
    width: 95%;
    max-width: 1000px;
    margin: 20px auto;
    border: 1px solid var(--border);
    border-radius: 6px;
    background: var(--table-bg);
    padding: 10px;
    font-size: 0.9em;
  }

  #alerts h3 { margin: 0 0 8px; font-size: 1em; border-bottom: 1px solid var(--border); padding-bottom: 4px; }

  #controls {
    text-align: center;
    margin-top: 10px;
  }

  #controls button, #intervalSelect {
    background: var(--table-bg);
    color: var(--text);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 6px 10px;
    margin: 3px;
    cursor: pointer;
  }

  #controls button:hover {
    background: var(--bg);
  }
</style>
</head>
<body>
<h1>é‹è¡Œä¸­åˆ—è»Š</h1>
<p id="updateTime">ãƒ‡ãƒ¼ã‚¿æ›´æ–°ä¸­...</p>
<p id="localTime">ç¾åœ¨æ™‚åˆ»: --:--:--</p>

<div class="tab-buttons">
  <button id="keioTab" class="active" onclick="switchTab('keio')">äº¬ç‹ç·šãƒ»ç›¸æ¨¡åŸç·š</button>
  <button id="inokTab" onclick="switchTab('inok')">äº•ã®é ­ç·š</button>
</div>

<div id="alerts">
  <h3>é€šçŸ¥</h3>
  <div id="alertContent">ç¾åœ¨ã€ç‰¹è¨˜äº‹é …ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</div>
</div>

<div id="controls">
  <label for="intervalSelect">æ›´æ–°é–“éš”ï¼š</label>
  <select id="intervalSelect">
    <option value="30000">30ç§’</option>
    <option value="60000" selected>1åˆ†</option>
    <option value="120000">2åˆ†</option>
    <option value="300000">5åˆ†</option>
  </select>
  <button onclick="toggleDarkMode()">ğŸŒ— ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿</button>
</div>

<div id="keioTableContainer">
  <table id="keioTable">
    <tr>
      <th onclick="sortTable('keioTable',0)">åˆ—è»Šç•ªå·</th>
      <th>ç¨®åˆ¥</th>
      <th onclick="sortTable('keioTable',2)">ä¸Šä¸‹</th>
      <th onclick="sortTable('keioTable',3)">ç¾åœ¨ä½ç½®</th>
      <th>è¡Œå…ˆ</th>
      <th>ä¸¡æ•°</th>
      <th>ç•ªç·š</th>
      <th>é…ã‚Œ</th>
      <th>å‚™è€ƒ</th>
    </tr>
  </table>
</div>

<div id="inokTableContainer" style="display:none;">
  <table id="inokTable">
    <tr>
      <th onclick="sortTable('inokTable',0)">åˆ—è»Šç•ªå·</th>
      <th>ç¨®åˆ¥</th>
      <th onclick="sortTable('inokTable',2)">ä¸Šä¸‹</th>
      <th onclick="sortTable('inokTable',3)">ç¾åœ¨ä½ç½®</th>
      <th>è¡Œå…ˆ</th>
      <th>ä¸¡æ•°</th>
      <th>ç•ªç·š</th>
      <th>é…ã‚Œ</th>
      <th>å‚™è€ƒ</th>
    </tr>
  </table>
</div>

<script>
const idMap = {
  001:"äº¬ç‹ç·šæ–°å®¿",002:"ç¬¹å¡š",003:"ä»£ç”°æ©‹",004:"æ˜å¤§å‰",005:"ä¸‹é«˜äº•æˆ¸",006:"æ¡œä¸Šæ°´",007:"ä¸ŠåŒ—æ²¢",008:"å…«å¹¡å±±",
  009:"èŠ¦èŠ±å…¬åœ’",010:"åƒæ­³çƒå±±",011:"ä»™å·",012:"ã¤ã¤ã˜ãƒ¶ä¸˜",013:"æŸ´å´",014:"å›½é ˜",015:"å¸ƒç”°",016:"èª¿å¸ƒ",017:"è¥¿èª¿å¸ƒ",
  018:"é£›ç”°çµ¦",019:"æ­¦è”µé‡å°",020:"å¤šç£¨éœŠåœ’",021:"æ±åºœä¸­",022:"åºœä¸­",023:"åˆ†å€æ²³åŸ",024:"ä¸­æ²³åŸ",025:"è–è¹Ÿæ¡œãƒ¶ä¸˜",
  026:"ç™¾è‰åœ’",027:"é«˜å¹¡ä¸å‹•",028:"å—å¹³",029:"å¹³å±±åŸå€å…¬åœ’",030:"é•·æ²¼",031:"åŒ—é‡",032:"äº¬ç‹å…«ç‹å­",
  044:"äº¬ç‹å¤šæ‘©å·",045:"äº¬ç‹ç¨²ç”°å ¤",046:"äº¬ç‹ã‚ˆã¿ã†ã‚Šãƒ©ãƒ³ãƒ‰",047:"ç¨²åŸ",048:"è‹¥è‘‰å°",049:"äº¬ç‹æ°¸å±±",
  050:"äº¬ç‹å¤šæ‘©ã‚»ãƒ³ã‚¿ãƒ¼",051:"äº¬ç‹å €ä¹‹å†…",052:"å—å¤§æ²¢",053:"å¤šæ‘©å¢ƒ",054:"æ©‹æœ¬",
  081:"æ¸‹è°·",082:"ç¥æ³‰",083:"é§’å ´æ±å¤§å‰",084:"æ± ãƒä¸Š",085:"ä¸‹åŒ—æ²¢",086:"æ–°ä»£ç”°",087:"æ±æ¾åŸ",
  088:"æ˜å¤§å‰",089:"æ°¸ç¦ç”º",090:"è¥¿æ°¸ç¦",091:"æµœç”°å±±",092:"é«˜äº•æˆ¸",093:"å¯Œå£«è¦‹ãƒ¶ä¸˜",094:"ä¹…æˆ‘å±±",
  095:"ä¸‰é·¹å°",096:"äº•ã®é ­å…¬åœ’",097:"å‰ç¥¥å¯º",
  101:"æ–°å®¿ä¸‰ä¸ç›®",102:"æ›™æ©‹",103:"å¸‚ãƒ¶è°·",104:"ä¹æ®µä¸‹",105:"ç¥ä¿ç”º",106:"å°å·ç”º",107:"å²©æœ¬ç”º",
  108:"é¦¬å–°æ¨ªå±±",109:"æµœç”º",110:"æ£®ä¸‹",111:"èŠå·",112:"ä½å‰",113:"è¥¿å¤§å³¶",114:"å¤§å³¶",115:"æ±å¤§å³¶",
  116:"èˆ¹å €",117:"ä¸€ä¹‹æ±Ÿ",118:"ç‘æ±Ÿ",119:"ç¯ å´",120:"æœ¬å…«å¹¡",
  300:"äº¬ç‹ç·šæ–°å®¿ãƒ»éƒ½å–¶æ–°å®¿ç·šæ–¹é¢",301:"éƒ½å–¶æ–°å®¿ç·šæ–¹é¢",302:"äº¬ç‹ç·šæ–°å®¿æ–¹é¢",303:"èª¿å¸ƒæ–¹é¢",
  304:"é«˜å¹¡ä¸å‹•æ–¹é¢",305:"å…«å¹¡å±±æ–¹é¢",306:"ç¬¹å¡šæ–¹é¢",
  400:"äº¬ç‹å…«ç‹å­æ–¹é¢",401:"é«˜å°¾å±±å£æ–¹é¢",402:"æ©‹æœ¬æ–¹é¢",403:"åºœä¸­ãƒ»åºœä¸­ç«¶é¦¬æ­£é–€å‰æ–¹é¢",
  501:"æ˜å¤§å‰ãƒ»æ°¸ç¦ç”ºæ–¹é¢",502:"å‰ç¥¥å¯ºæ–¹é¢"
};

const syMap = {
  1:{name:"ç‰¹æ€¥",class:"tokkyu"},
  2:{name:"æ€¥è¡Œ",class:"kyuko"},
  3:{name:"å¿«é€Ÿ",class:"kaisoku"},
  5:{name:"åŒºé–“æ€¥è¡Œ",class:"kukan"},
  6:{name:"å„åœ",class:"kakutei"},
  9:{name:"ãƒ©ã‚¤ãƒŠãƒ¼",class:"tokkyu"},
  11:{name:"ãƒ©ã‚¤ãƒŠãƒ¼",class:"tokkyu"}
};

let updateInterval = 60000;
let updateTimer;

function updateLocalTime(){
  const now = new Date();
  const f = n => String(n).padStart(2,"0");
  document.getElementById("localTime").textContent = `ç¾åœ¨æ™‚åˆ»: ${f(now.getHours())}:${f(now.getMinutes())}:${f(now.getSeconds())}`;
}

function switchTab(tab){
  document.getElementById("keioTab").classList.toggle("active",tab==="keio");
  document.getElementById("inokTab").classList.toggle("active",tab==="inok");
  document.getElementById("keioTableContainer").style.display = (tab==="keio") ? "block":"none";
  document.getElementById("inokTableContainer").style.display = (tab==="inok") ? "block":"none";
}

function toggleDarkMode(){
  const cur = document.body.dataset.theme === "dark" ? "light" : "dark";
  document.body.dataset.theme = cur;
  localStorage.setItem("theme",cur);
}

document.body.dataset.theme = localStorage.getItem("theme") || "light";

document.getElementById("intervalSelect").addEventListener("change", e=>{
  clearInterval(updateTimer);
  updateInterval = parseInt(e.target.value);
  updateTimer = setInterval(fetchData, updateInterval);
});

async function fetchData(){
  try {
    const res = await fetch("https://i.opentidkeio.jp/data/traffic_info.json?cache="+Date.now());
    const data = await res.json();

    const t = data.up?.[0]?.dt?.[0];
    if(t){
      document.getElementById("updateTime").textContent = 
        `æœ€çµ‚æ›´æ–°: ${t.yy}/${t.mt}/${t.dy} ${t.hh}:${t.mm}:${t.ss}`;
    }

    const keioT = document.getElementById("keioTable");
    const inokT = document.getElementById("inokTable");
    keioT.querySelectorAll("tr:not(:first-child)").forEach(tr=>tr.remove());
    inokT.querySelectorAll("tr:not(:first-child)").forEach(tr=>tr.remove());

    const alerts = [];

    const allTrains = [];
    function addRows(section,table){
      section.forEach(st=>{
        st.ps.forEach(p=>{
          const sy = syMap[p.sy] || {name:"ä¸æ˜",class:""};
          const ik = idMap[p.ik_tr] || "ä¸æ˜";
          const updown = (parseInt(p.tr)%2===0) ? "ä¸Šã‚Š" : "ä¸‹ã‚Š";
          let remarks = "";
          if(sy.name==="ç‰¹æ€¥" && p.sr==="8") remarks="ç‰¹æ€¥ï¼ˆ8ä¸¡ç·¨æˆï¼‰";
          if(p.ik_tr>=101 && p.ik_tr<=120) remarks += (remarks?", ":"")+"éƒ½å–¶æ–°å®¿ç·šç›´é€š";
          allTrains.push(p.tr);

          const delayMin = parseInt(p.dl);
          if(delayMin>=15) alerts.push(` ${p.tr}åˆ—è»Š ${delayMin}åˆ†é…ã‚Œ`);

          const pos = idMap[p.id?.slice(1)] || "ä½ç½®ä¸æ˜";

          const row = `<tr><td>${p.tr}</td><td class="${sy.class}">${sy.name}</td><td>${updown}</td><td>${pos}</td><td>${ik}</td><td>${p.sr}</td><td>${p.bs}</td><td>${p.dl==="00"?"å¹³å¸¸":p.dl+"åˆ†"}</td><td>${remarks}</td></tr>`;
          table.insertAdjacentHTML("beforeend",row);
        });
      });
    }

    if(data.TS) addRows(data.TS,keioT);
    if(data.TB) addRows(data.TB,inokT);

    // è»Šä¸¡äº¤æ›äºˆå®šãƒã‚§ãƒƒã‚¯
    const dup = allTrains.filter((v,i,a)=>a.indexOf(v)!==i);
    dup.forEach(d=>{
      alerts.push(` ${d}åˆ—è»Š è»Šä¸¡äº¤æ›äºˆå®š`);
    });

    document.getElementById("alertContent").innerHTML = alerts.length? alerts.join("<br>"):"ç¾åœ¨ã€ç‰¹è¨˜äº‹é …ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚";

  }catch(e){
    document.getElementById("updateTime").textContent = "æ›´æ–°å¤±æ•—ï¼š" + e.message;
  }
}

function sortTable(id,col){
  const table=document.getElementById(id);
  const rows=[...table.rows].slice(1);
  const asc=!table.asc;
  rows.sort((a,b)=>a.cells[col].innerText.localeCompare(b.cells[col].innerText,"ja",{numeric:true})*(asc?1:-1));
  rows.forEach(r=>table.appendChild(r));
  table.asc=asc;
}

// åˆæœŸèµ·å‹•
fetchData();
updateLocalTime();
updateTimer = setInterval(fetchData, updateInterval);
setInterval(updateLocalTime,1000);
</script>
</body>
</html>
