<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>äº¬ç‹ç·šãƒ»äº•ã®é ­ç·š åœ¨ç·šçŠ¶æ³</title>
<style>
  :root{
    --tokkyu:#d32f2f; /* èµ¤ */
    --kyuko:#388e3c;  /* ç·‘ */
    --kaisoku:#1976d2;/* é’ */
    --kukan:#fff176;  /* é»„ */
    --kakutei:#e0e0e0;/* ç° */
    --accent:#1976d2;
  }
  body{font-family:Segoe UI,system-ui,-apple-system,"Helvetica Neue",Arial;margin:0;background:#f7f8fa;color:#222}
  header{padding:18px 12px;text-align:center}
  h1{margin:0;font-size:20px}
  #meta{display:flex;gap:12px;justify-content:center;align-items:center;margin-top:8px}
  #updateTime,#localTime{color:#555;font-size:13px}
  main{padding:10px 8px 140px}
  h2{margin:18px 0 8px;font-size:16px}
  .tab-buttons{display:flex;justify-content:center;border-bottom:2px solid #e3e6ea;margin:0 auto 10px;max-width:1000px}
  .tab-buttons button{flex:1;border:0;background:none;padding:10px 8px;font-size:15px;cursor:pointer;border-bottom:3px solid transparent;transition:.15s}
  .tab-buttons button:hover{background:#f3f5f7}
  .tab-buttons button.active{border-bottom:3px solid var(--accent);color:var(--accent);font-weight:600}
  table{width:95%;max-width:1000px;margin:10px auto 24px;border-collapse:collapse;background:#fff;box-shadow:0 1px 3px rgba(0,0,0,0.04)}
  th,td{padding:8px 10px;border:1px solid #e6e9ec;text-align:center;font-size:14px}
  th{background:#fbfdff;position:sticky;top:0}
  tr:hover td{background:#fbfbfb}
  .tokkyu{color:#fff;background:var(--tokkyu)}
  .kyuko{color:#fff;background:var(--kyuko)}
  .kaisoku{color:#fff;background:var(--kaisoku)}
  .kukan{color:#000;background:var(--kukan)}
  .kakutei{color:#000;background:var(--kakutei)}
  /* notification bottom */
  #notification{position:fixed;left:8px;right:8px;bottom:8px;background:#fff3f3;border:1px solid #f2c0c0;padding:10px;border-radius:8px;box-shadow:0 4px 16px rgba(0,0,0,0.06);max-height:160px;overflow:auto}
  #notification h3{margin:0 0 8px;color:#b71c1c;text-align:center}
  #notification ul{margin:0;padding:0;list-style:none}
  #notification li{padding:4px 6px;border-radius:4px;margin-bottom:4px}
  .notif-delay{background:#ffdfe0;color:#900} /* é…å»¶ */
  .notif-exchange{background:#fff6d6;color:#8a5b00} /* äº¤æ› */
  /* settings */
  #controls{position:fixed;top:12px;right:12px}
  .btn{background:var(--accent);color:#fff;padding:8px 10px;border-radius:6px;border:0;cursor:pointer;font-size:13px}
  .btn.ghost{background:#fff;border:1px solid #cfd8e3;color:#333}
  /* lock screen */
  #lockScreen{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(240,240,240,0.95);z-index:9999}
  .lockBox{background:#fff;padding:22px;border-radius:8px;box-shadow:0 6px 24px rgba(0,0,0,0.12);width:min(420px,92%);text-align:center}
  .lockBox input{width:100%;padding:10px;margin-top:8px;border-radius:6px;border:1px solid #ddd;font-size:15px}
  .lockBox .small{font-size:13px;color:#666;margin-top:8px}
  /* modal settings */
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.35);z-index:9999}
  .modal .card{background:#fff;padding:16px;border-radius:8px;max-width:420px;width:92%}
  .form-row{margin:8px 0}
  input[type="password"]{width:100%;padding:8px;border:1px solid #ddd;border-radius:6px}
  .footer-note{font-size:12px;color:#666;text-align:center;margin-top:8px}
  @media (max-width:520px){
    th,td{font-size:12px;padding:6px}
    .tab-buttons button{font-size:14px;padding:9px}
    #notification{left:6px;right:6px;bottom:6px}
  }
</style>
</head>
<body>
<header>
  <h1>äº¬ç‹ç·šãƒ»äº•ã®é ­ç·š åœ¨æ¥åœ¨ç·šçŠ¶æ³</h1>
  <div id="meta">
    <div id="updateTime">ãƒ‡ãƒ¼ã‚¿æ›´æ–°ä¸­...</div>
    <div id="localTime">ç¾åœ¨æ™‚åˆ»: --:--:--</div>
  </div>
</header>

<!-- controls -->
<div id="controls">
  <button class="btn ghost" id="btnLogout" style="display:none">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
  <button class="btn" id="btnSettings" style="display:none">è¨­å®š</button>
</div>

<main id="content" style="display:none">
  <section>
    <h2>äº¬ç‹ç·šãƒ»ç›¸æ¨¡åŸç·š</h2>
    <div class="tab-buttons" id="filterKeio">
      <button data-filter="all" class="active">å…¨ã¦</button>
      <button data-filter="ä¸Šã‚Š">ä¸Šã‚Š</button>
      <button data-filter="ä¸‹ã‚Š">ä¸‹ã‚Š</button>
    </div>
    <table id="keioTable"><thead><tr><th>ä¸Šä¸‹</th><th>åˆ—è»Šç•ªå·</th><th>è¡Œå…ˆ</th><th>ç¨®åˆ¥</th><th>ä¸¡æ•°</th><th>ç¾åœ¨ä½ç½®</th><th>ç•ªç·š</th><th>é…ã‚Œ</th><th>å‚™è€ƒ</th></tr></thead><tbody></tbody></table>
  </section>

  <section>
    <h2>äº•ã®é ­ç·š</h2>
    <div class="tab-buttons" id="filterInok">
      <button data-filter="all" class="active">å…¨ã¦</button>
      <button data-filter="ä¸Šã‚Š">ä¸Šã‚Š</button>
      <button data-filter="ä¸‹ã‚Š">ä¸‹ã‚Š</button>
    </div>
    <table id="inokTable"><thead><tr><th>ä¸Šä¸‹</th><th>åˆ—è»Šç•ªå·</th><th>è¡Œå…ˆ</th><th>ç¨®åˆ¥</th><th>ä¸¡æ•°</th><th>ç¾åœ¨ä½ç½®</th><th>ç•ªç·š</th><th>é…ã‚Œ</th><th>å‚™è€ƒ</th></tr></thead><tbody></tbody></table>
  </section>
</main>

<!-- notification bottom -->
<div id="notification" aria-live="polite">
  <h3>ğŸš¨ é‹è¡Œé€šçŸ¥</h3>
  <ul id="notifyList"><li>èª­ã¿è¾¼ã¿ä¸­...</li></ul>
</div>

<!-- lock screen -->
<div id="lockScreen">
  <div class="lockBox">
    <h3>ã‚¢ã‚¯ã‚»ã‚¹èªè¨¼</h3>
    <p>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>
    <input id="passInput" type="password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
    <div style="display:flex;gap:8px;margin-top:10px;justify-content:center">
      <button class="btn" id="unlockBtn">èªè¨¼</button>
      <button class="btn ghost" id="helpBtn">åˆæœŸå€¤</button>
    </div>
    <div class="small" id="lockMsg"></div>
  </div>
</div>

<!-- settings modal -->
<div class="modal" id="modalSettings">
  <div class="card">
    <h3>è¨­å®š</h3>
    <div class="form-row">
      <label>ç¾åœ¨ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
      <input id="curPass" type="password" placeholder="ç¾åœ¨ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
    </div>
    <div class="form-row">
      <label>æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
      <input id="newPass" type="password" placeholder="æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
      <button class="btn ghost" id="closeSettings">é–‰ã˜ã‚‹</button>
      <button class="btn" id="savePass">å¤‰æ›´ã‚’ä¿å­˜</button>
    </div>
    <div class="footer-note">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã® localStorage ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚</div>
  </div>
</div>

<script>
/* ---------- è¨­å®šã‚­ãƒ¼ã¨åˆæœŸå€¤ ---------- */
const KEY_PASS = "keio_pass";
const KEY_ACCESS = "keio_access";
const KEY_NOTIF = "keio_notifications";
const DEFAULT_PASS = "0000";

/* ---------- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ---------- */
function nowTime(){ return new Date().toLocaleTimeString("ja-JP",{hour12:false}); }
function getStoredPass(){ return localStorage.getItem(KEY_PASS) || DEFAULT_PASS; }
function setStoredPass(v){ localStorage.setItem(KEY_PASS, v); }

/* ---------- DOM refs ---------- */
const lockScreen = document.getElementById("lockScreen");
const content = document.getElementById("content");
const unlockBtn = document.getElementById("unlockBtn");
const passInput = document.getElementById("passInput");
const lockMsg = document.getElementById("lockMsg");
const helpBtn = document.getElementById("helpBtn");
const btnLogout = document.getElementById("btnLogout");
const btnSettings = document.getElementById("btnSettings");
const modalSettings = document.getElementById("modalSettings");
const closeSettings = document.getElementById("closeSettings");
const savePass = document.getElementById("savePass");
const curPass = document.getElementById("curPass");
const newPass = document.getElementById("newPass");

/* ---------- èµ·å‹•æ™‚ï¼šè¡¨ç¤ºãƒ»èªè¨¼ç®¡ç† ---------- */
function showLocked(){ lockScreen.style.display="flex"; content.style.display="none"; btnLogout.style.display="none"; btnSettings.style.display="none"; }
function showUnlocked(){ lockScreen.style.display="none"; content.style.display="block"; btnLogout.style.display="inline-block"; btnSettings.style.display="inline-block"; }

function checkAccess(){ return localStorage.getItem(KEY_ACCESS) === "granted"; }

/* è‡ªå‹•çš„ã«ã‚¢ã‚¯ã‚»ã‚¹ãŒè¨±å¯ã•ã‚Œã¦ã„ã‚‹å ´åˆ */
if(checkAccess()){
  showUnlocked();
} else {
  showLocked();
}

/* åˆæœŸå€¤è¡¨ç¤ºï¼ˆãƒ˜ãƒ«ãƒ—ãƒœã‚¿ãƒ³ã§æ¡ˆå†…ï¼‰ */
helpBtn.addEventListener("click", ()=>{ lockMsg.textContent = `åˆæœŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯ã€Œ${DEFAULT_PASS}ã€ã§ã™`; setTimeout(()=>lockMsg.textContent="",4000); });

unlockBtn.addEventListener("click", ()=>{
  const v = passInput.value || "";
  if(v === getStoredPass()){
    localStorage.setItem(KEY_ACCESS,"granted");
    passInput.value="";
    showUnlocked();
  } else {
    lockMsg.textContent = "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™";
    setTimeout(()=>lockMsg.textContent="",2500);
  }
});

/* ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ */
btnLogout.addEventListener("click", ()=>{
  localStorage.removeItem(KEY_ACCESS);
  showLocked();
});

/* è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« */
btnSettings.addEventListener("click", ()=>{ modalSettings.style.display="flex"; });
closeSettings.addEventListener("click", ()=>{ modalSettings.style.display="none"; curPass.value=""; newPass.value=""; });

savePass.addEventListener("click", ()=>{
  const cur = curPass.value||"";
  const nw = newPass.value||"";
  if(cur !== getStoredPass()){ alert("ç¾åœ¨ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™"); return; }
  if(nw.length < 1){ alert("æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
  setStoredPass(nw);
  modalSettings.style.display="none";
  curPass.value=""; newPass.value="";
  alert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã—ã¾ã—ãŸ");
});

/* ---------- ãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºãƒ­ã‚¸ãƒƒã‚¯ï¼ˆfetchãƒ»æç”»ãƒ»é€šçŸ¥ï¼‰ ---------- */
/* idMap / syMap ã®å®šç¾©ï¼ˆçŸ­ç¸®æ¸ˆã¿ï¼‰ */
const idMap = {1:"äº¬ç‹ç·šæ–°å®¿",2:"ç¬¹å¡š",3:"ä»£ç”°æ©‹",4:"æ˜å¤§å‰",5:"ä¸‹é«˜äº•æˆ¸",6:"æ¡œä¸Šæ°´",7:"ä¸ŠåŒ—æ²¢",8:"å…«å¹¡å±±",9:"èŠ¦èŠ±å…¬åœ’",10:"åƒæ­³çƒå±±",11:"ä»™å·",12:"ã¤ã¤ã˜ãƒ¶ä¸˜",13:"æŸ´å´",14:"å›½é ˜",15:"å¸ƒç”°",16:"èª¿å¸ƒ",17:"è¥¿èª¿å¸ƒ",18:"é£›ç”°çµ¦",19:"æ­¦è”µé‡å°",20:"å¤šç£¨éœŠåœ’",21:"æ±åºœä¸­",22:"åºœä¸­",23:"åˆ†å€æ²³åŸ",24:"ä¸­æ²³åŸ",25:"è–è¹Ÿæ¡œãƒ¶ä¸˜",26:"ç™¾è‰åœ’",27:"é«˜å¹¡ä¸å‹•",28:"å—å¹³",29:"å¹³å±±åŸå€å…¬åœ’",30:"é•·æ²¼",31:"åŒ—é‡",32:"äº¬ç‹å…«ç‹å­",44:"äº¬ç‹å¤šæ‘©å·",45:"äº¬ç‹ç¨²ç”°å ¤",46:"äº¬ç‹ã‚ˆã¿ã†ã‚Šãƒ©ãƒ³ãƒ‰",47:"ç¨²åŸ",48:"è‹¥è‘‰å°",49:"äº¬ç‹æ°¸å±±",50:"äº¬ç‹å¤šæ‘©ã‚»ãƒ³ã‚¿ãƒ¼",51:"äº¬ç‹å €ä¹‹å†…",52:"å—å¤§æ²¢",53:"å¤šæ‘©å¢ƒ",54:"æ©‹æœ¬",81:"æ¸‹è°·",82:"ç¥æ³‰",83:"é§’å ´æ±å¤§å‰",84:"æ± ãƒä¸Š",85:"ä¸‹åŒ—æ²¢",86:"æ–°ä»£ç”°",87:"æ±æ¾åŸ",88:"æ˜å¤§å‰",89:"æ°¸ç¦ç”º",90:"è¥¿æ°¸ç¦",91:"æµœç”°å±±",92:"é«˜äº•æˆ¸",93:"å¯Œå£«è¦‹ãƒ¶ä¸˜",94:"ä¹…æˆ‘å±±",95:"ä¸‰é·¹å°",96:"äº•ã®é ­å…¬åœ’",97:"å‰ç¥¥å¯º"};
const syMap = {1:{name:"ç‰¹æ€¥",class:"tokkyu"},2:{name:"æ€¥è¡Œ",class:"kyuko"},3:{name:"å¿«é€Ÿ",class:"kaisoku"},5:{name:"åŒºé–“æ€¥è¡Œ",class:"kukan"},6:{name:"å„åœ",class:"kakutei"},9:{name:"ãƒ©ã‚¤ãƒŠãƒ¼",class:"tokkyu"},11:{name:"ãƒ©ã‚¤ãƒŠãƒ¼",class:"tokkyu"}};

const updateTimeEl = document.getElementById("updateTime");
const localTimeEl = document.getElementById("localTime");
const keioTableBody = document.querySelector("#keioTable tbody");
const inokTableBody = document.querySelector("#inokTable tbody");
const notifyList = document.getElementById("notifyList");

/* helper */
function getPosLabel(id){
  const n = parseInt(id.slice(1));
  if(id.startsWith("E")) return `${idMap[n]}é§…æ§‹å†…`;
  if(id.startsWith("U")) return `${idMap[n+1]||"ä¸æ˜"}ã€œ${idMap[n]||"ä¸æ˜"}é–“ ä¸Šã‚Š`;
  if(id.startsWith("D")) return `${idMap[n]||"ä¸æ˜"}ã€œ${idMap[n-1]||"ä¸æ˜"}é–“ ä¸‹ã‚Š`;
  return "ä¸æ˜";
}
function parseDelay(dl){ const v = parseInt(dl); return isNaN(v)?0:v; }

/* é€šçŸ¥ä¿å­˜/å¾©å…ƒ */
function notifExpiryTimestamp(){
  // ç¿Œæ—¥ 1:15 ã®ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«æ™‚é–“ï¼‰
  const now = new Date();
  const tomorrow = new Date(now.getFullYear(), now.getMonth(), now.getDate()+1, 1, 15, 0, 0);
  return tomorrow.getTime();
}
function loadNotifications(){
  const raw = localStorage.getItem(KEY_NOTIF);
  if(!raw) return {expires:0,list:[]};
  try{ const obj = JSON.parse(raw); if(obj.expires && obj.expires > Date.now()) return obj; }catch(e){}
  return {expires:0,list:[]};
}
function saveNotifications(obj){ localStorage.setItem(KEY_NOTIF, JSON.stringify(obj)); }

/* render notifications into bottom box */
function renderNotifications(obj){
  notifyList.innerHTML = "";
  if(!obj.list || obj.list.length===0){ notifyList.innerHTML="<li>å¹³å¸¸é‹è»¢</li>"; return; }
  obj.list.forEach(item=>{
    const li = document.createElement("li");
    li.textContent = item.text + (item.time?` [è¨˜éŒ² ${item.time}]`:"");
    li.className = item.type==="delay" ? "notif-delay" : "notif-exchange";
    notifyList.appendChild(li);
  });
}

/* main fetch & render */
async function fetchAndRender(){
  try{
    const url = "https://i.opentidkeio.jp/data/traffic_info.json?cache="+Date.now();
    const res = await fetch(url);
    const data = await res.json();

    // update times
    const t = data.up?.[0]?.dt?.[0];
    if(t){
      const hh = String(parseInt(t.hh) % 24).padStart(2,"0");
      updateTimeEl.textContent = `ãƒ‡ãƒ¼ã‚¿æœ€çµ‚æ›´æ–°: ${t.yy}/${t.mt}/${t.dy} ${hh}:${t.mm}:${t.ss}`;
    }

    // collect trains
    const all = [];
    function collect(section, source){
      section.forEach(st=>{
        st.ps.forEach(p=>{
          const id = st.id;
          const tr = (p.tr||"").trim();
          const sy = syMap[p.sy] ? syMap[p.sy].name : "ä¸æ˜";
          const syClass = syMap[p.sy] ? syMap[p.sy].class : "";
          const ik = idMap[(p.ik_tr||"").padStart(3,"0")] || "ä¸æ˜";
          const pos = getPosLabel(id);
          const updown = (parseInt(id.slice(1))%2===0) ? "ä¸Šã‚Š" : "ä¸‹ã‚Š";
          const delayNum = parseDelay(p.dl);
          all.push({id,source,tr,sy,syClass,ik,pos,updown,sr:p.sr||"",bs:p.bs||"",delayNum,delayLabel: p.dl==="00" ? "å¹³å¸¸" : (p.dl+"åˆ†é…ã‚Œ"),remarks:""});
        });
      });
    }
    if(data.TS) collect(data.TS,"keio");
    if(data.TB) collect(data.TB,"inok");

    // remarks: special rules
    const count = {};
    all.forEach(x=>{ count[x.tr] = (count[x.tr]||0)+1; });
    all.forEach(x=>{
      if(x.sy==="ç‰¹æ€¥" && x.sr==="8") x.remarks = "ç‰¹æ€¥ï¼ˆ8ä¸¡ç·¨æˆï¼‰";
      if(count[x.tr] > 1) x.remarks += (x.remarks ? "ï¼":"") + "è»Šä¸¡äº¤æ›äºˆå®š";
    });

    // notifications: load old, append new unique items, set expiry
    const stored = loadNotifications();
    // start with stored list (if still valid)
    let notifObj = stored.expires > Date.now() ? stored : {expires: notifExpiryTimestamp(), list: []};
    // helper to push if not exist
    function pushNotif(type, text){
      if(!notifObj.list.find(i => i.text === text)){
        notifObj.list.push({type,text,time: nowTime()});
      }
    }
    // check all trains: delay >=15 and exchange
    all.forEach(x=>{
      if(x.delayNum >= 15) pushNotif("delay", `${x.tr}ï¼ˆ${x.delayNum}åˆ†é…ã‚Œï¼‰`);
      if(x.remarks.includes("è»Šä¸¡äº¤æ›äºˆå®š")) pushNotif("exchange", `${x.tr}ï¼ˆè»Šä¸¡äº¤æ›äºˆå®šï¼‰`);
    });
    // save
    notifObj.expires = notifExpiryTimestamp();
    saveNotifications(notifObj);
    renderNotifications(notifObj);

    // render tables (filtering handled by tabs)
    function renderTable(bodyEl, lineFilter){
      bodyEl.innerHTML = "";
      all.filter(r => {
        if(lineFilter === "keio") return parseInt(r.id.slice(1)) <= 54;
        if(lineFilter === "inok") return parseInt(r.id.slice(1)) >= 81;
        return true;
      }).forEach(r=>{
        const tr = document.createElement("tr");
        tr.setAttribute("data-updown", r.updown);
        tr.innerHTML = `<td>${r.updown}</td>
          <td>${r.tr}</td>
          <td>${r.ik}</td>
          <td class="${r.syClass}">${r.sy}</td>
          <td>${r.sr}</td>
          <td>${r.pos}</td>
          <td>${r.bs}</td>
          <td>${r.delayLabel}</td>
          <td>${r.remarks}</td>`;
        bodyEl.appendChild(tr);
      });
    }
    renderTable(keioTableBody,"keio");
    renderTable(inokTableBody,"inok");

    // setup tabs (bind once)
    setupTabs();

  }catch(err){
    updateTimeEl.textContent = "æ›´æ–°å¤±æ•—: " + (err.message||err);
  }
}

/* tabs and filters */
function setupTabs(){
  function bind(id, tbody, line){
    const el = document.getElementById(id);
    const buttons = el.querySelectorAll("button");
    buttons.forEach(btn=>{
      if(btn._bound) return;
      btn._bound = true;
      btn.addEventListener("click", ()=>{
        buttons.forEach(b=>b.classList.remove("active"));
        btn.classList.add("active");
        const filter = btn.dataset.filter;
        tbody.querySelectorAll("tr").forEach(tr=>{
          const updown = tr.getAttribute("data-updown");
          tr.style.display = (filter==="all" || updown===filter) ? "" : "none";
        });
      });
    });
  }
  bind("filterKeio", keioTableBody, "keio");
  bind("filterInok", inokTableBody, "inok");
}

/* sorting: click header to sort (simple localeCompare) */
function enableSorting(){
  document.querySelectorAll("table").forEach(table=>{
    const headers = table.querySelectorAll("thead th");
    headers.forEach((th, idx)=>{
      if(th._sortBound) return;
      th._sortBound = true;
      th.style.cursor = "pointer";
      th.addEventListener("click", ()=>{
        const tbody = table.querySelector("tbody");
        const rows = Array.from(tbody.querySelectorAll("tr")).filter(r=>r.style.display!=="none");
        const asc = !th.classList.contains("asc");
        headers.forEach(h=>h.classList.remove("asc","desc"));
        th.classList.add(asc?"asc":"desc");
        rows.sort((a,b)=>{
          const A = a.children[idx].textContent.trim();
          const B = b.children[idx].textContent.trim();
          // numeric compare if both numeric
          const nA = parseFloat(A.replace(/[^0-9.-]/g,""));
          const nB = parseFloat(B.replace(/[^0-9.-]/g,""));
          if(!isNaN(nA) && !isNaN(nB)) return asc ? nA - nB : nB - nA;
          return asc ? A.localeCompare(B,"ja") : B.localeCompare(A,"ja");
        });
        rows.forEach(r => tbody.appendChild(r));
      });
    });
  });
}

/* clock update */
setInterval(()=>{ if(checkAccess()){ updateLocalTime(); } },1000);

/* start fetch loop only when unlocked */
let fetchInterval = null;
function startAutoFetch(){
  if(fetchInterval) clearInterval(fetchInterval);
  fetchAndRender();
  fetchInterval = setInterval(fetchAndRender, 30000); // 30s
  enableSorting();
}
function stopAutoFetch(){ if(fetchInterval) clearInterval(fetchInterval); fetchInterval = null; }

if(checkAccess()){
  startAutoFetch();
} else {
  stopAutoFetch();
}

/* unlock action also starts fetch */
unlockBtn.addEventListener("click", ()=>{
  if(checkAccess()){
    startAutoFetch();
  } else {
    if(passInput.value === getStoredPass()){
      localStorage.setItem(KEY_ACCESS,"granted");
      startAutoFetch();
    }
  }
});

/* when unlocking by stored access (on pageload) */
if(checkAccess()){
  startAutoFetch();
}

/* logout should stop fetch and lock UI */
btnLogout.addEventListener("click", ()=>{
  localStorage.removeItem(KEY_ACCESS);
  stopAutoFetch();
  showLocked();
});

/* restore notifications on load (if not expired) */
window.addEventListener("load", ()=>{
  const saved = loadNotifications();
  if(saved.expires > Date.now()){
    renderNotifications(saved);
  }
});

/* clear expired notifications at 1:15 */
setInterval(()=>{
  const saved = loadNotifications();
  if(saved.expires && saved.expires <= Date.now()){
    saveNotifications({expires:0,list:[]});
    renderNotifications({list:[]});
  }
}, 60000);

/* close modal when clicking outside */
modalSettings.addEventListener("click",(e)=>{ if(e.target===modalSettings) modalSettings.style.display="none"; });

/* small UX: help to show default pass */
document.getElementById("helpBtn").addEventListener("click", ()=>{ alert("åˆæœŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯ 0000 ã§ã™"); });

</script>
</body>
</html>
