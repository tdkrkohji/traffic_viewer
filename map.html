<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title>ライブ配線図 — 京王線</title>
    <style>
        :root {
            --bg: #0d1117;
            --text: #e6edf3;
            --accent: #58a6ff;
        }
        body {
            margin: 0;
            background-color: var(--bg);
            color: var(--text);
            font-family: sans-serif;
            overflow: hidden; /* スクロールはコンテナで行う */
        }
        /* ヘッダー */
        header {
            position: fixed;
            top: 0;
            width: 100%;
            height: 50px;
            background: rgba(13, 17, 23, 0.9);
            display: flex;
            align-items: center;
            padding: 0 15px;
            z-index: 100;
            border-bottom: 1px solid #30363d;
        }
        h1 { font-size: 16px; margin: 0; flex-grow: 1; }
        #status { font-size: 12px; color: #8b949e; }

        /* マップ表示エリア */
        .map-wrapper {
            position: absolute;
            top: 50px;
            bottom: 0;
            left: 0;
            right: 0;
            overflow: auto; /* スマホで縦横スクロール可能に */
            -webkit-overflow-scrolling: touch;
        }
        .map-content {
            position: relative;
            /* 座標の最大値に合わせてサイズを固定 */
            width: 4000px; 
            height: 1080px; 
        }
        .map-img {
            position: absolute;
            top: 0;
            left: 0;
            display: block;
        }

        /* 列車アイコン */
        .train {
            position: absolute;
            width: 18px;
            height: 18px;
            border-radius: 4px;
            border: 2px solid #fff;
            transform: translate(-50%, -50%);
            z-index: 10;
            transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }
        .train::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 2px;
            background: inherit;
            opacity: 0.4;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); opacity: 0.4; }
            70% { transform: scale(2); opacity: 0; }
            100% { transform: scale(1); opacity: 0; }
        }
        .train-no {
            position: absolute;
            top: -22px;
            background: rgba(0, 0, 0, 0.75);
            color: #fff;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
            white-space: nowrap;
            pointer-events: none;
        }

        /* 種別カラー */
        .sy-tokkyu { background-color: #ff4c7c; }
        .sy-kyuko { background-color: #00b66a; }
        .sy-kaisoku { background-color: #0082ff; }
        .sy-kukan { background-color: #d8d100; color: #000; }
        .sy-kakutei { background-color: #ced0d4; color: #000; }
        .sy-liner { background-color: #c71585; }
    </style>
</head>
<body>

<header>
    <h1>京王線 リアルタイム配線図</h1>
    <div id="status">更新中...</div>
</header>

<div class="map-wrapper">
    <div class="map-content" id="mapContent">
        <img src="image.png" class="map-img" alt="配線図">
        </div>
</div>

<script>
const FEED_URL = "https://i.opentidkeio.jp/data/traffic_info.json";

// いただいた座標データ
const posCoords = {
  "E001_1": {x: 503, y: 458}, "E001_2": {x: 503, y: 557}, "E001_3": {x: 503, y: 655},
  "D002": {x: 1250, y: 557}, "E002_1": {x: 2325, y: 220}, "D003": {x: 2650, y: 220},
  "E003": {x: 3050, y: 312}, "D004": {x: 3326, y: 312}, "E004": {x: 3600, y: 312},
  "E033_4": {x: 503, y: 308}, "E033_5": {x: 503, y: 407}, "D034": {x: 900, y: 308},
  "E034": {x: 1250, y: 308}, "D035": {x: 1460, y: 308}, "E035": {x: 1673, y: 315},
  "S002": {x: 2060, y: 308}, "E002_2": {x: 2325, y: 315}
};

const syClass = { 1:"sy-tokkyu", 2:"sy-kyuko", 3:"sy-kaisoku", 5:"sy-kukan", 6:"sy-kakutei", 9:"sy-liner", 11:"sy-liner" };

async function fetchToei() {
    let map = {};
    try {
        const res = await fetch("toei.txt");
        if (res.ok) {
            const text = await res.text();
            let current = "";
            text.split("\n").forEach(l => {
                l = l.trim();
                if (/^\d+[A-Z]$/.test(l)) current = l;
                else if (l) l.split(",").forEach(t => map[t.trim()] = current);
            });
        }
    } catch(e) {}
    return map;
}

async function update() {
    try {
        const unyoMap = await fetchToei();
        const res = await fetch(FEED_URL + "?" + Date.now());
        const data = await res.json();
        const container = document.getElementById('mapContent');
        
        // 既存の列車を取得（更新用）
        const currentTrains = document.querySelectorAll('.train');
        const activeIds = new Set();

        [...(data.TS || []), ...(data.TB || [])].forEach(st => {
            (st.ps || []).forEach(p => {
                if (!p.tr) return;
                
                const coordKey = p.bs ? `${st.id}_${p.bs}` : st.id;
                const coords = posCoords[coordKey] || posCoords[st.id];

                if (coords) {
                    activeIds.add(p.tr);
                    let el = document.getElementById(`tr-${p.tr}`);
                    
                    if (!el) {
                        el = document.createElement('div');
                        el.id = `tr-${p.tr}`;
                        el.className = `train ${syClass[p.sy] || ''}`;
                        container.appendChild(el);
                    }

                    // 運用番号があれば付与
                    const unyo = unyoMap[p.tr] ? `${unyoMap[p.tr]} ` : "";
                    el.innerHTML = `<div class="train-no">${unyo}${p.tr}</div>`;
                    
                    // 位置更新
                    el.style.left = `${coords.x}px`;
                    el.style.top = `${coords.y}px`;
                }
            });
        });

        // 画面外（データから消えた）列車を削除
        currentTrains.forEach(el => {
            if (!activeIds.has(el.id.replace('tr-', ''))) el.remove();
        });

        document.getElementById('status').textContent = `最終更新: ${new Date().toLocaleTimeString()}`;
    } catch (e) {
        console.error(e);
        document.getElementById('status').textContent = "接続エラー";
    }
}

// 30秒ごとに更新
setInterval(update, 30000);
update();
</script>

</body>
</html>
