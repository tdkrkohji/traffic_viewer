<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title>ライブ配線図 (CSS描画版)</title>
    <style>
        :root {
            --bg: #1a1a1a;
            --rail: #ffffff;
            --station: #ffffff;
            --tokkyu: #ff4c7c;
            --kakutei: #ced0d4;
        }
        body { margin: 0; background: var(--bg); color: #fff; font-family: sans-serif; }
        header { padding: 10px; border-bottom: 1px solid #444; display: flex; align-items: center; }
        
        /* 全体のコンテナ */
        .map-container {
            position: relative;
            width: 100%;
            height: 80vh;
            overflow: auto;
            padding: 20px;
        }
        
        /* 描画エリア */
        .canvas {
            position: relative;
            width: 1200px; /* 基準幅 */
            height: 600px;
            background: #111;
            border-radius: 8px;
        }

        /* 線路の基本パーツ */
        .rail {
            position: absolute;
            height: 2px;
            background: var(--rail);
        }
        /* 駅のホーム（白い箱） */
        .platform {
            position: absolute;
            background: var(--station);
            height: 12px;
            width: 80px;
            border: 1px solid #888;
        }
        .st-label {
            position: absolute;
            font-size: 14px;
            font-weight: bold;
            color: #ccc;
        }

        /* 列車アイコン */
        .train {
            position: absolute;
            width: 24px;
            height: 16px;
            border-radius: 3px;
            border: 1px solid #fff;
            z-index: 100;
            transform: translate(-50%, -50%);
            transition: all 1s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 9px;
            font-weight: bold;
            color: #000;
        }

        /* 個別の配置設定（新宿〜明大前イメージ） */
        /* 本線（上り・下り） */
        .r-h-up { top: 200px; left: 0; width: 100%; }
        .r-h-dn { top: 240px; left: 0; width: 100%; }
        
        /* 新線 */
        .r-s-up { top: 140px; left: 0; width: 400px; border-bottom: 2px solid var(--rail); height: 0; }
        .r-s-up::after { content:''; position:absolute; top:30px; left:380px; width:60px; height:30px; border-left: 2px solid #fff; border-bottom: 2px solid #fff; transform: skewX(-45deg); }

        /* 新宿ホーム */
        .pl-shinjuku-1 { top: 194px; left: 100px; }
        .pl-shinjuku-2 { top: 234px; left: 100px; }
    </style>
</head>
<body>

<header>
    <a href="index.html" style="color:#58a6ff; text-decoration:none; margin-right:15px;">← 戻る</a>
    <h1 style="font-size:18px; margin:0;">京王線 描画版ライブモニター</h1>
</header>

<div class="map-container">
    <div class="canvas" id="mapCanvas">
        <div class="rail r-h-up"></div>
        <div class="rail r-h-dn"></div>
        
        <div class="st-label" style="top:160px; left:110px;">新 宿</div>
        <div class="st-label" style="top:160px; left:480px;">笹 塚</div>

        <div class="platform pl-shinjuku-1"></div>
        <div class="platform pl-shinjuku-2"></div>
        <div class="platform" style="top:194px; left:480px;"></div> <div class="platform" style="top:234px; left:480px;"></div>

        </div>
</div>

<script>
// CSS描画上の座標と駅IDを紐付け
const coordMap = {
    "E001_1": { x: 140, y: 200 }, // 新宿1番線
    "E001_2": { x: 140, y: 240 }, // 新宿2番線
    "E002_1": { x: 520, y: 200 }, // 笹塚
    "D002":   { x: 350, y: 240 }, // 笹塚付近(駅間)
};

async function update() {
    try {
        const res = await fetch("https://i.opentidkeio.jp/data/traffic_info.json?" + Date.now());
        const data = await res.json();
        const canvas = document.getElementById('mapCanvas');
        
        // 前回の列車を削除
        document.querySelectorAll('.train').forEach(e => e.remove());

        const all = [...(data.TS || []), ...(data.TB || [])];
        all.forEach(st => {
            (st.ps || []).forEach(p => {
                const key = p.bs ? `${st.id}_${p.bs}` : st.id;
                const pos = coordMap[key] || coordMap[st.id];

                if (pos) {
                    const tr = document.createElement('div');
                    tr.className = 'train';
                    // 種別判定（暫定）
                    tr.style.backgroundColor = (p.sy == 1) ? '#ff4c7c' : '#ced0d4';
                    tr.style.left = pos.x + "px";
                    tr.style.top = pos.y + "px";
                    tr.innerText = p.tr;
                    canvas.appendChild(tr);
                }
            });
        });
    } catch(e) { console.error(e); }
}

setInterval(update, 30000);
update();
</script>
</body>
</html>
