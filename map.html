<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title>京王線 ライブ配線図モニター Ver.1.1</title>
    <style>
        :root { --bg: #0f0f0f; --accent: #58a6ff; }
        body { margin: 0; background: var(--bg); color: #fff; font-family: 'Helvetica Neue', Arial, sans-serif; overflow: hidden; }
        
        header {
            height: 50px; padding: 0 15px; background: rgba(0,0,0,0.9);
            display: flex; align-items: center; border-bottom: 1px solid #333;
            position: fixed; top: 0; width: 100%; z-index: 1000;
        }

        .map-wrapper {
            position: absolute; top: 50px; bottom: 0; left: 0; right: 0;
            overflow: auto; -webkit-overflow-scrolling: touch; background: #000;
        }

        /* 1200x675固定サイズ */
        .map-content { position: relative; width: 1200px; height: 675px; }
        .map-img { position: absolute; top: 0; left: 0; width: 1200px; height: 675px; display: block; pointer-events: none; }

        /* 列車アイコン */
        .train {
            position: absolute; width: 26px; height: 16px;
            border-radius: 2px; border: 1.5px solid #fff;
            transform: translate(-50%, -50%); z-index: 100;
            transition: all 1.5s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 0 10px rgba(0,0,0,0.8);
            display: flex; align-items: center; justify-content: center;
        }

        /* 詳細情報ラベル (白文字統一) */
        .train-label {
            position: absolute; top: -38px;
            background: rgba(0,0,0,0.85); color: #fff;
            padding: 3px 6px; border-radius: 4px;
            font-size: 10px; font-weight: bold; white-space: nowrap;
            display: flex; flex-direction: column; align-items: center;
            line-height: 1.3; border: 1px solid #444;
            pointer-events: none;
        }

        .label-row { display: flex; gap: 6px; align-items: center; color: #fff; }
        .delay-text { color: #ff4444; font-weight: 900; } /* 遅れのみ赤 */

        /* 種別カラー設定 */
        .sy-1 { background-color: #ff4c7c; } /* 特急 */
        .sy-2 { background-color: #00b66a; } /* 急行 */
        .sy-3 { background-color: #0082ff; } /* 快速 */
        .sy-5 { background-color: #d8d100; color: #000; } /* 区急 */
        .sy-6 { background-color: #888; }    /* 各停 */
        .sy-9, .sy-11 { background-color: #c71585; } /* ライナー */
    </style>
</head>
<body>

<header>
    <a href="index.html" style="color:var(--accent); text-decoration:none; margin-right:15px; font-size:13px;">← 一覧</a>
    <h1 style="font-size:14px; margin:0;">京王線 ライブ配線図 (新宿-明大前)</h1>
    <div id="status" style="margin-left:auto; font-size:11px; color:#aaa;">運用データ読込中...</div>
</header>

<div class="map-wrapper">
    <div class="map-content" id="mapContent">
        <img src="image.png" class="map-img">
        <div id="trainLayer"></div>
    </div>
</div>

<script>
const FEED_URL = "https://i.opentidkeio.jp/data/traffic_info.json";
let unyoMap = {}; // 運用情報を保持するグローバル変数

// 座標リスト (1200x675)
const posCoords = {
    "E001_1": {x: 149, y: 135}, "E001_2": {x: 149, y: 163}, "E001_3": {x: 149, y: 191},
    "D002":   {x: 366, y: 163}, "U001":   {x: 366, y: 191},
    "E002_1": {x: 680, y: 65},  "E002_2": {x: 680, y: 91}, "E002_3": {x: 680, y: 120}, "E002_4": {x: 680, y: 146},
    "E033_4": {x: 149, y: 91},  "E033_5": {x: 149, y: 119},
    "D034":   {x: 295, y: 91},  "U033":   {x: 295, y: 120},
    "E034_1": {x: 367, y: 91},  "E034_2": {x: 367, y: 120},
    "D035":   {x: 430, y: 91},  "U034":   {x: 430, y: 120},
    "E035_1": {x: 490, y: 91},  "E035_2": {x: 490, y: 120},
    "S002":   {x: 600, y: 91},  "U035":   {x: 600, y: 120},
    "D003":   {x: 785, y: 65},  "U002":   {x: 785, y: 146},
    "E003_1": {x: 893, y: 91},  "E003_2": {x: 893, y: 120},
    "D004":   {x: 976, y: 91},  "U003":   {x: 976, y: 120},
    "E004_1": {x: 1053, y: 91}, "E004_2": {x: 1053, y: 120}
};

// sk(車両区分)判定
function getCarModel(sk) {
    const models = { "2":"2000", "5":"5000", "7":"7000", "8":"8000", "9":"9000", "0":"10-300" };
    return models[String(sk)] || "";
}

// toei.txt 読込関数
async function loadUnyoData() {
    try {
        const res = await fetch("toei.txt?" + Date.now());
        if (!res.ok) throw new Error("toei.txt not found");
        const text = await res.text();
        const lines = text.split(/\r?\n/);
        let currentUnyo = "";
        
        unyoMap = {}; // クリア
        lines.forEach(line => {
            line = line.trim();
            if (!line) return;
            // 運用番号 (数字+T/K)
            if (/^\d+[TK]$/.test(line)) {
                currentUnyo = line;
            } else if (currentUnyo) {
                line.split(',').forEach(tr => {
                    const cleanTr = tr.trim();
                    if (cleanTr) unyoMap[cleanTr] = currentUnyo;
                });
            }
        });
        console.log("Unyo data loaded:", Object.keys(unyoMap).length);
    } catch (e) {
        console.error("Unyo load failed:", e);
    }
}

async function update() {
    try {
        const res = await fetch(FEED_URL + "?" + Date.now());
        const data = await res.json();
        const layer = document.getElementById('trainLayer');
        const activeIds = new Set();
        const all = [...(data.TS || []), ...(data.TB || [])];
        const posCounter = {};

        all.forEach(st => {
            (st.ps || []).forEach(p => {
                if (!p.tr) return;
                const key = p.bs ? `${st.id}_${p.bs}` : st.id;
                const base = posCoords[key] || posCoords[st.id];

                if (base) {
                    activeIds.add(p.tr);
                    
                    // 重複回避ロジック
                    const cKey = `${base.x}_${base.y}`;
                    const offset = (posCounter[cKey] || 0) * 10;
                    posCounter[cKey] = (posCounter[cKey] || 0) + 1;

                    let el = document.getElementById(`tr-${p.tr}`);
                    if (!el) {
                        el = document.createElement('div');
                        el.id = `tr-${p.tr}`;
                        el.className = 'train';
                        layer.appendChild(el);
                    }
                    
                    el.className = `train sy-${p.sy || '6'}`;
                    el.style.left = `${base.x + offset}px`;
                    el.style.top = `${base.y}px`;

                    const model = getCarModel(p.sk);
                    const unyo = unyoMap[p.tr] || "--";
                    const delayHtml = (p.dl && parseInt(p.dl) > 0) ? `<span class="delay-text">+${p.dl}</span>` : "";

                    el.innerHTML = `
                        <div class="train-label">
                            <div class="label-row"><span>${model}</span><span>${unyo}</span></div>
                            <div class="label-row"><span>${p.tr}</span>${delayHtml}</div>
                        </div>`;
                }
            });
        });

        // 不要な列車を削除
        document.querySelectorAll('.train').forEach(el => {
            if (!activeIds.has(el.id.replace('tr-', ''))) el.remove();
        });
        document.getElementById('status').textContent = "更新: " + new Date().toLocaleTimeString();
    } catch (e) { console.error(e); }
}

// 起動シーケンス
(async () => {
    await loadUnyoData(); // 1回読込
    update();             // 初回描画
    setInterval(update, 20000);   // 位置更新
    setInterval(loadUnyoData, 300000); // 運用データは5分おきに再読込
})();
</script>
</body>
</html>
