<<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8" />
    <title>京王線 ライブモニター 完全版</title>
    <style>
        :root { --bg: #0f0f0f; }
        body { margin: 0; background: var(--bg); color: #fff; font-family: sans-serif; overflow: hidden; }
        header { height: 50px; padding: 0 15px; background: #000; display: flex; align-items: center; border-bottom: 1px solid #333; }
        .map-wrapper { position: absolute; top: 50px; bottom: 0; left: 0; right: 0; overflow: auto; background: #000; }
        .map-content { position: relative; width: 1200px; height: 675px; }
        .map-img { position: absolute; width: 1200px; height: 675px; }
        .train { position: absolute; width: 26px; height: 16px; border-radius: 2px; border: 1.5px solid #fff; transform: translate(-50%, -50%); z-index: 100; transition: all 1s linear; }
        .train-label { position: absolute; top: -26px; background: rgba(0,0,0,0.8); color: #fff; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: bold; white-space: nowrap; border: 1px solid #444; display: flex; gap: 5px; }
        .delay-text { color: #ff4444; }
        /* 種別色 */
        .sy-1 { background-color: #ff4c7c; } .sy-2 { background-color: #00b66a; } 
        .sy-6 { background-color: #888; }
    </style>
</head>
<body>

<header>
    <h1 style="font-size:14px; margin:0;">京王線 ライブモニター</h1>
    <div id="status" style="margin-left:auto; font-size:11px; color:#00ff00;">運用データ解析中...</div>
</header>

<div class="map-wrapper">
    <div class="map-content" id="mapContent">
        <img src="image.png" class="map-img">
        <div id="trainLayer"></div>
    </div>
</div>

<script>
const RAW_UNYO_DATA = `
1T
5803,5802,4807,2802
3T
5805,5804,4809,2804,5873,5872,5889,5888,5805A,6909,6918,5847A,5842A
15T
5813,5812,4821,4830,4847,4852,5811A,5812A,5835A,5832A,4897,4806A
81K
6904,5809,5808,4811,4826,2811,2826,2831,2846,5841A,5838A,4801A,2720,6758
91K
6117,5108,5867,5866,2817,2832,4869,4876,5853A,5848A,4813A
`; // (必要に応じて上のリストをフル版に差し替えてください)

function parseUnyo(raw) {
    const map = {};
    const lines = raw.split('\n');
    let currentUnyo = "--";
    let count = 0;

    lines.forEach(line => {
        const trimmed = line.trim();
        if (!trimmed) return;
        if (/^\d+[TK]$/.test(trimmed)) {
            currentUnyo = trimmed;
        } else {
            trimmed.split(',').forEach(tr => {
                const trNum = tr.trim();
                if (trNum) {
                    // 【重要】全ての列車番号を「文字列」として保存
                    map[String(trNum)] = currentUnyo;
                    count++;
                }
            });
        }
    });
    // 画面に解析結果を表示
    document.getElementById('status').textContent = `運用データ: ${count}件 読込完了`;
    return map;
}

const unyoMap = parseUnyo(RAW_UNYO_DATA);

const posCoords = {
    "E001_1": {x: 149, y: 135}, "E001_2": {x: 149, y: 163}, "E001_3": {x: 149, y: 191},
    "D002":   {x: 366, y: 163}, "U001":   {x: 366, y: 191},
    "E033_4": {x: 149, y: 91},  "E033_5": {x: 149, y: 119},
    "D034":   {x: 295, y: 91},  "U033":   {x: 295, y: 120}
};

async function update() {
    try {
        const res = await fetch("https://i.opentidkeio.jp/data/traffic_info.json?" + Date.now());
        const data = await res.json();
        const layer = document.getElementById('trainLayer');
        const activeIds = new Set();
        const all = [...(data.TS || []), ...(data.TB || [])];

        all.forEach(st => {
            (st.ps || []).forEach(p => {
                if (!p.tr) return;
                const base = posCoords[p.bs ? `${st.id}_${p.bs}` : st.id];

                if (base) {
                    activeIds.add(p.tr);
                    let el = document.getElementById(`tr-${p.tr}`);
                    if (!el) {
                        el = document.createElement('div');
                        el.id = `tr-${p.tr}`;
                        el.className = 'train';
                        layer.appendChild(el);
                    }
                    
                    el.style.left = `${base.x}px`;
                    el.style.top = `${base.y}px`;
                    el.className = `train sy-${p.sy || '6'}`;

                    // 【解決策】APIの列車番号(p.tr)を文字列に変換してから照合
                    const trStr = String(p.tr);
                    const unyo = unyoMap[trStr] || "--"; 
                    
                    const delayHtml = (p.dl && parseInt(p.dl) > 0) ? `<span class="delay-text">+${p.dl}</span>` : "";

                    el.innerHTML = `
                        <div class="train-label">
                            <span>${unyo}</span>
                            <span>${trStr}</span>
                            ${delayHtml}
                        </div>`;
                }
            });
        });
        // (不要な列車削除ロジック省略)
    } catch (e) { console.error(e); }
}

setInterval(update, 20000);
update();
</script>
</body>
</html>
