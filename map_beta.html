<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8" />
    <title>京王線 運用表示 Ver.1.7</title>
    <script src="unyo_kt.js"></script>
    <style>
        :root { --bg: #0f0f0f; --accent: #58a6ff; }
        body { margin: 0; background: var(--bg); color: #fff; font-family: sans-serif; overflow: hidden; }
        header { height: 50px; padding: 0 15px; background: rgba(0,0,0,0.9); display: flex; align-items: center; border-bottom: 1px solid #333; position: fixed; top: 0; width: 100%; z-index: 1000; }
        .map-wrapper { position: absolute; top: 50px; bottom: 0; left: 0; right: 0; overflow: auto; background: #000; }
        .map-content { position: relative; width: 1200px; height: 675px; }
        .map-img { position: absolute; top: 0; left: 0; width: 1200px; height: 675px; pointer-events: none; }
        .train { position: absolute; width: 26px; height: 16px; border-radius: 2px; border: 1.5px solid #fff; transform: translate(-50%, -50%); z-index: 100; transition: all 1.5s linear; box-shadow: 0 0 8px #000; }
        .train-label { position: absolute; top: 50%; transform: translateY(-50%); background: rgba(0,0,0,0.85); color: #fff; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: bold; white-space: nowrap; display: flex; gap: 4px; border: 1px solid #444; }
        .label-nobori { right: 100%; margin-right: 8px; }
        .label-kudari { left: 100%; margin-left: 8px; }
        .unyo-no { color: #ffeb3b; }
        .car-model { color: #00ffcc; font-size: 9px; }
        .dest-text { background: #333; padding: 0 2px; }
    </style>
</head>
<body>
<header>
    <div style="font-size:14px; font-weight:bold;">京王線 リアルタイム運用モニター</div>
    <div id="status" style="margin-left:auto; font-size:11px; color:#aaa;">読込中...</div>
</header>
<div class="map-wrapper">
    <div class="map-content">
        <img src="image.png" class="map-img">
        <div id="trainLayer"></div>
    </div>
</div>

<script>
const FEED_URL = "https://i.opentidkeio.jp/data/traffic_info.json";
const posCoords = {
    "E001_1": {x: 149, y: 135}, "E001_2": {x: 149, y: 163}, "E001_3": {x: 149, y: 191},
    "D002":   {x: 366, y: 163}, "U001":   {x: 366, y: 191},
    "E002_1": {x: 680, y: 65},  "E002_2": {x: 680, y: 91},  "E002_3S": {x: 680, y: 120}, "E002_4": {x: 680, y: 146},
    "E033_4": {x: 149, y: 91},  "E033_5": {x: 149, y: 119},
    "D034":   {x: 295, y: 91},  "U033":   {x: 295, y: 120},
    "E034_1": {x: 367, y: 91},  "E034_2": {x: 367, y: 120},
    "D035":   {x: 430, y: 91},  "U034":   {x: 430, y: 120},
    "E035_1": {x: 490, y: 91},  "E035_2": {x: 490, y: 120},
    "S002":   {x: 600, y: 91},  "U035":   {x: 600, y: 120},
    "D003":   {x: 785, y: 65},  "U002":   {x: 785, y: 146},
    "E003_1": {x: 893, y: 91},  "E003_2": {x: 893, y: 120},
    "D004":   {x: 976, y: 91},  "U003":   {x: 976, y: 120},
    "E004_1": {x: 1053, y: 91}, "E004_2": {x: 1053, y: 120},
    "D005":   {x: 55,  y: 322}, "U004":   {x: 1145, y: 120},
    "E005_1": {x: 145, y: 322}, "E005_2": {x: 145, y: 351},
    "D006":   {x: 230, y: 322}, "U005":   {x: 230, y: 351},
    "E006_1": {x: 337, y: 294}, "E006_2": {x: 337, y: 322}, "E006_3": {x: 337, y: 351}, "E006_4": {x: 337, y: 378},
    "D007":   {x: 419, y: 322}, "U006":   {x: 419, y: 351},
    "E007_1": {x: 479, y: 322}, "E007_2": {x: 479, y: 351},
    "D008":   {x: 549, y: 322}, "U007":   {x: 549, y: 351},
    "E008_10": {x: 630, y: 294}, "E008_1": {x: 630, y: 310}, "E008_2": {x: 630, y: 336}, "E008_3": {x: 630, y: 351},
    "D009":   {x: 729, y: 322}, "U008":   {x: 729, y: 351},
    "E009_1": {x: 788, y: 322}, "E009_2": {x: 788, y: 351},
    "D010":   {x: 871, y: 322}, "U009":   {x: 871, y: 351},
    "E010_1": {x: 950, y: 322}, "E010_2": {x: 950, y: 351},
    "D011":   {x: 1033, y: 322}, "U010":  {x: 1033, y: 351},
    "E011_1": {x: 1122, y: 322}, "E011_2": {x: 1122, y: 351}
};

function getCarModel(sk) {
    const m = { "2":"2000", "5":"5000", "7":"7000", "8":"8000", "9":"9000", "0":"10-300" };
    return m[String(sk)] || "";
}

function getDestName(ik) {
    const d = { "001":"新", "033":"N", "002":"笹", "003":"明", "006":"桜", "010":"烏", "012":"つ", "016":"調", "018":"飛", "021":"東", "022":"府", "027":"高", "031":"北", "032":"八", "036":"馬", "037":"動", "042":"尾", "043":"山", "048":"若", "050":"セ", "052":"沢", "054":"橋", "101":"市", "107":"岩", "112":"住", "114":"島", "118":"瑞", "120":"本" };
    return d[String(ik)] || ik;
}

// 運用取得
function getUnyo(tr) {
    return (window.trToUnyo && window.trToUnyo[String(tr)]) ? window.trToUnyo[String(tr)] : "--";
}

async function update() {
    try {
        const res = await fetch(FEED_URL + "?" + Date.now());
        const json = await res.json();
        const layer = document.getElementById('trainLayer');
        const activeIds = new Set();
        const all = [...(json.TS || []), ...(json.TB || [])];
        const counter = {};

        all.forEach(st => {
            (st.ps || []).forEach(p => {
                if (!p.tr) return;
                const key = p.bs ? `${st.id}_${p.bs}` : st.id;
                const pos = posCoords[key] || posCoords[st.id];

                if (pos) {
                    activeIds.add(p.tr);
                    const cKey = `${pos.x}_${pos.y}`;
                    const offset = (counter[cKey] || 0) * 10;
                    counter[cKey] = (counter[cKey] || 0) + 1;

                    let el = document.getElementById(`tr-${p.tr}`);
                    if (!el) {
                        el = document.createElement('div');
                        el.id = `tr-${p.tr}`;
                        el.className = 'train';
                        layer.appendChild(el);
                    }
                    el.className = `train sy-${p.sy || '6'}`;
                    el.style.left = (pos.x + offset) + "px";
                    el.style.top = pos.y + "px";

                    const dir = (String(p.ki) === "1") ? "label-nobori" : "label-kudari";
                    el.innerHTML = `
                        <div class="train-label ${dir}">
                            <span class="car-model">${getCarModel(p.sk)}</span>
                            <span class="unyo-no">${getUnyo(p.tr)}</span>
                            <span class="dest-text">${getDestName(p.ik_tr)}</span>
                            <span>${p.tr}</span>
                        </div>`;
                }
            });
        });
        document.querySelectorAll('.train').forEach(e => {
            if (!activeIds.has(e.id.replace('tr-', ''))) e.remove();
        });
        document.getElementById('status').textContent = "更新: " + new Date().toLocaleTimeString();
    } catch (e) { console.error(e); }
}
setInterval(update, 2000);
update();
</script>
</body>
</html>
