<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>京王線v0.03情報</title>

<style>
body {
  font-family: -apple-system,BlinkMacSystemFont,sans-serif;
  background: #f8f8f8;
  margin: 0;
  padding: 0;
}
.header {
  background: #c40018;
  color: #fff;
  padding: 12px;
  text-align: center;
  font-weight: bold;
}
.station-list {
  padding: 8px;
}
.station {
  display: flex;
  align-items: center;
  padding: 4px 0;
  border-bottom: 1px solid #ddd;
  font-size: 14px;
}
.station-name {
  width: 140px;
  font-weight: 600;
}
.trains {
  flex: 1;
  display: flex;
  gap: 6px;
  flex-wrap: wrap;
}
.train-card {
  padding: 4px 6px;
  border-radius: 4px;
  font-size: 12px;
  color: #fff;
  min-width: 36px;
  text-align: center;
}

/* 種別色 */
.tokkyu { background: #e60011; }
.kyuko { background: #f57c00; }
.kaisoku { background: #1565c0; }
.kukan { background: #ffb300; }
.kakutei { background: #2e7d32; }
.liner { background: #6a1b9a; }

/* 駅間 */
.between {
  font-size: 12px;
  font-style: italic;
  color: #666;
}

/* 遅延 */
.delay {
  border: 2px solid #ff0000;
}

/* スマホ対応 */
@media (max-width: 600px) {
  .station-name { width: 100px; font-size: 13px; }
  .train-card { font-size: 11px; }
}
</style>
</head>
<body>

<div class="header">京王線 こすとれ風 運行情報</div>
<div class="station-list" id="station-list"></div>

<script>
const stations = [
  "京王線新宿","笹塚","代田橋","明大前","下高井戸","桜上水","上北沢","八幡山",
  "芦花公園","千歳烏山","仙川","つつじヶ丘","柴崎","国領","布田","調布",
  "西調布","飛田給","武蔵野台","多磨霊園","東府中","府中","分倍河原","中河原",
  "聖蹟桜ヶ丘","百草園","高幡不動","南平","平山城址公園","長沼","北野","京王八王子",
  "京王多摩川","京王稲田堤","京王よみうりランド","稲城","若葉台","京王永山","京王多摩センター",
  "京王堀之内","南大沢","多摩境","橋本"
];

const syMap = {
  1:{cls:"tokkyu"},
  2:{cls:"kyuko"},
  3:{cls:"kaisoku"},
  5:{cls:"kukan"},
  6:{cls:"kakutei"},
  9:{cls:"liner"},
  11:{cls:"liner"}
};

function formatTrainNo(tr){return String(tr ?? "").padStart(3,"0");}

function render(){
  fetch("https://i.opentidkeio.jp/data/traffic_info.json")
  .then(r=>r.json())
  .then(data=>{
    const list = document.getElementById("station-list");
    list.innerHTML = "";
    
    // 駅ごとの列車一覧へ変換
    const map = {};
    data.TS.forEach(g=>{
      g.ps.forEach(t=>{
        const pos = t.ik;
        const stName = stations[pos-1] ?? null;
        const key = stName || "駅間";
        const sy = syMap[t.sy] || {};
        const cls = sy.cls || "";
        const no = formatTrainNo(t.tr);
        const dl = t.dl>0 ? "⚠"+t.dl:"";
        if(!map[key]) map[key]=[];
        map[key].push({no,cls,dl});
      });
    });
    
    // 駅一覧描画
    stations.forEach(st=>{
      const trains = map[st] || [];
      const div = document.createElement("div");
      div.className="station";
      div.innerHTML = `<div class="station-name">${st}</div><div class="trains"></div>`;
      
      const container = div.querySelector(".trains");
      trains.forEach(t=>{
        const c = document.createElement("div");
        c.className="train-card "+t.cls+(t.dl?" delay":"");
        c.textContent = t.no+(t.dl?" "+t.dl:"");
        container.appendChild(c);
      });
      list.appendChild(div);
    });
  });
}

render();
setInterval(render,30000);
</script>

</body>
</html>
