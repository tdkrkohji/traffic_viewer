<!DOCTYPE html>
<html lang="ja" data-version="v0.1.40">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>運行中列車 — v0.1.47</title>
<style>
/* 基本スタイル（GitHub風・レスポンシブ） */
:root{
  --bg:#f6f8fa; --panel:#ffffff; --muted:#6e7781; --border:#d0d7de; --accent:#0969da;
  --tokkyu:#FF4C7C; --kyuko:#00B66A; --kaisoku:#0082FF; --kukan:#D8D100; --kakutei:#ced0d4; --liner:#c71585; --linermt:#32cd32;
  --text:#24292e;
}
[data-theme="dark"]{
  --bg:#0d1117; --panel:#0b1117; --muted:#9aa4b2; --border:#30363d; --accent:#58a6ff;
  --tokkyu:#ff6b6b; --kyuko:#7bd389; --kaisoku:#8cc8ff; --kukan:#ffd86b; --kakutei:#5a5f66; --liner:#191970; --linermt:#32cd32;
  --text:#c9d1d9;
}
html,body{height:100%}
body{
  margin:0; font-family:"Segoe UI","Hiragino Kaku Gothic ProN","Yu Gothic",Meiryo,Arial,sans-serif;
  background:var(--bg); color:var(--text); -webkit-font-smoothing:antialiased;
  line-height:1.45; font-size:13px; padding-bottom:120px;
}
header{padding:14px 12px; text-align:center}
h1{margin:6px 0; font-size:18px}
#meta{font-size:12px;color:var(--muted); display:flex; gap:12px; justify-content:center; align-items:center; flex-wrap:wrap}

/* タブ */
.tab-bar{display:flex; justify-content:center; gap:8px; padding:8px 12px}
.tab-btn{
  background:var(--panel); border:1px solid var(--border); padding:8px 14px; border-radius:8px;
  cursor:pointer; color:var(--text); font-weight:600;
}
.tab-btn.active{border-color:var(--accent); color:var(--accent);}

/* サブタブ */
.subtabs{display:flex; justify-content:center; gap:8px; margin-top:6px}
.subtab{background:var(--panel); border:1px solid var(--border); padding:6px 10px; border-radius:6px; cursor:pointer}
.subtab.active{border-color:var(--accent); color:var(--accent); font-weight:600}

/* コンテナとテーブル */
.container{max-width:1100px; margin:14px auto; padding:0 12px}
.table-wrap{overflow-x:auto; border:1px solid var(--border); border-radius:6px; background:var(--panel); padding:6px; margin-top:8px}
table{width:100%; min-width:760px; border-collapse:collapse; margin:0; background:transparent}
th,td{padding:8px 10px; border:1px solid var(--border); text-align:center; white-space:nowrap}
th{background:transparent; cursor:pointer; font-weight:600}
th.sorted-asc::after{content:" ▲"; font-weight:600}
th.sorted-desc::after{content:" ▼"; font-weight:600}
tr:hover td{background: rgba(0,0,0,0.03);}

/* 種別バッジ */
.badge{padding:4px 6px; border-radius:4px; display:inline-block}
.tokkyu{background:var(--tokkyu); color:#fff}
.liner{background:var(--liner); color:#fff}
.linermt{background:var(--linermt); color:#fff}
.kyuko{background:var(--kyuko); color:#fff}
.kaisoku{background:var(--kaisoku); color:#fff}
.kukan{background:var(--kukan); color:#000}
.kakutei{background:var(--kakutei); color:#000}

/* 通知 */
#alerts{max-width:1100px; margin:14px auto; background:var(--panel); border:1px solid var(--border); border-radius:8px; padding:12px}
#alerts h3{margin:0 0 8px; font-size:14px}
.alert-item{padding:8px; border-radius:6px; margin-bottom:8px; font-size:13px}
.alert-delay{background:#ffdfe0; color:#900}
.alert-exchange{background:#fff6d6; color:#8a5b00}

/* コントロール */
.controls{max-width:1100px; margin:8px auto; display:flex; justify-content:flex-end; gap:8px; align-items:center; padding:0 12px}
select.control, button.control{padding:6px 10px; border-radius:6px; border:1px solid var(--border); background:var(--panel); color:var(--text); cursor:pointer}

/* フッター */
footer{margin-top:30px; text-align:center; color:var(--muted); font-size:13px}

/* スマホ調整 */
@media (max-width:720px){
  body{font-size:12px}
  th,td{padding:6px 8px; font-size:12px}
  .controls{justify-content:center}
}
</style>
</head>
<body>

<header>
  <h1>運行中列車 <small style="font-size:0.7em;color:var(--muted)">v0.1.3</small></h1>
  <div id="meta">
    <div id="updateTime">データ更新: —</div>
    <div id="localTime">現在時刻: —</div>
  </div>
</header>

<!-- 路線切替 -->
<div class="tab-bar" role="tablist" aria-label="路線切替">
  <button class="tab-btn active" data-line="keio">京王線</button>
  <button class="tab-btn" data-line="inok">井の頭線</button>
</div>

<div class="container">

  <!-- 京王線 -->
  <section id="keio" class="line-block">
    <div class="subtabs" role="tablist" aria-label="上下切替">
      <button class="subtab active" data-dir="up">上り</button>
      <button class="subtab" data-dir="down">下り</button>
    </div>

    <div class="table-wrap" id="keio-up-wrap">
      <table id="keio-up">
        <thead>
          <tr>
            <th data-key="updown">運用記号</th>
            <th data-key="tr">列車番号</th>
            <th data-key="ik">行先</th>
            <th data-key="sy">種別</th>
            <th data-key="sr">両数</th>
            <th data-key="pos">現在位置</th>
            <th data-key="bs">番線</th>
            <th data-key="dl">遅れ</th>
            <th data-key="remarks">備考</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="table-wrap" id="keio-down-wrap" style="display:none;">
      <table id="keio-down">
        <thead>
          <tr>
            <th data-key="updown">運用記号</th>
            <th data-key="tr">列車番号</th>
            <th data-key="ik">行先</th>
            <th data-key="sy">種別</th>
            <th data-key="sr">両数</th>
            <th data-key="pos">現在位置</th>
            <th data-key="bs">番線</th>
            <th data-key="dl">遅れ</th>
            <th data-key="remarks">備考</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- 井の頭線 -->
  <section id="inok" class="line-block" style="display:none;">
    <div class="subtabs" role="tablist" aria-label="上下切替">
      <button class="subtab active" data-dir="up">上り</button>
      <button class="subtab" data-dir="down">下り</button>
    </div>

    <div class="table-wrap" id="inok-up-wrap">
      <table id="inok-up">
        <thead>
          <tr>
            <th data-key="updown">上下</th>
            <th data-key="tr">列車番号</th>
            <th data-key="ik">行先</th>
            <th data-key="sy">種別</th>
            <th data-key="sr">両数</th>
            <th data-key="pos">現在位置</th>
            <th data-key="bs">番線</th>
            <th data-key="dl">遅れ</th>
            <th data-key="remarks">備考</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="table-wrap" id="inok-down-wrap" style="display:none;">
      <table id="inok-down">
        <thead>
          <tr>
            <th data-key="updown">上下</th>
            <th data-key="tr">列車番号</th>
            <th data-key="ik">行先</th>
            <th data-key="sy">種別</th>
            <th data-key="sr">両数</th>
            <th data-key="pos">現在位置</th>
            <th data-key="bs">番線</th>
            <th data-key="dl">遅れ</th>
            <th data-key="remarks">備考</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

</div>

<!-- 通知欄 -->
<div id="alerts" role="region" aria-live="polite">
  <h3>通知</h3>
  <div id="alertsInner">特記事項はありません。</div>
  <div style="margin-top:8px;font-size:12px;color:var(--muted)">
    通知は発生から翌日 01:15 までブラウザに保存されます（ローカルストレージ）。
  </div>
</div>

<!-- コントロール（下部） -->
<div class="controls" role="toolbar" aria-label="設定">
  <label for="intervalSelect" style="color:var(--muted);margin-right:6px">更新間隔</label>
  <select id="intervalSelect" class="control" aria-label="更新間隔">
    <option value="10000">10秒</option>
    <option value="30000" selected>30秒</option>
    <option value="60000">1分</option>
    <option value="180000">3分</option>
  </select>

  <button id="themeBtn" class="control" style="margin-left:8px">ダークモード：無効</button>
</div>

<footer>
  <div>v0.1.3</div>
</footer>

<script>
window.onerror = function(message, source, lineno, colno, error) {
  alert(
    "エラーが発生しました\n\n" +
    message + "\n\n" +
    "行番号: " + lineno
  );
};
 
//* --- 基本設定とマップ --- */
const FEED_URL = "https://i.opentidkeio.jp/data/traffic_info.json";

const idMap = {
  001:"京王線新宿",002:"笹塚",3:"代田橋",4:"明大前",5:"下高井戸",6:"桜上水",7:"上北沢",
  8:"八幡山",9:"芦花公園",10:"千歳烏山",11:"仙川",12:"つつじヶ丘",13:"柴崎",14:"国領",
  15:"布田",16:"調布",17:"西調布",18:"飛田給",19:"武蔵野台",20:"多磨霊園",21:"東府中",
  22:"府中",23:"分倍河原",24:"中河原",25:"聖蹟桜ヶ丘",26:"百草園",27:"高幡不動",28:"南平",
  29:"平山城址公園",30:"長沼",31:"北野",32:"京王八王子",33:"新線新宿",34:"初台",35:"幡ヶ谷",
  36:"府中競馬正門前",37:"多摩動物公園",38:"京王片倉",39:"山田",40:"めじろ台",41:"狭間",
  42:"高尾",43:"高尾山口",44:"京王多摩川",45:"京王稲田堤",46:"京王よみうりランド",47:"稲城",
  48:"若葉台",49:"京王永山",50:"京王多摩センター",51:"京王堀之内",52:"南大沢",53:"多摩境",
  54:"橋本",81:"渋谷",82:"神泉",83:"駒場東大前",84:"池ノ上",85:"下北沢",86:"新代田",87:"東松原",
  88:"明大前",89:"永福町",90:"西永福",91:"浜田山",92:"高井戸",93:"富士見ヶ丘",94:"久我山",
  95:"三鷹台",96:"井の頭公園",97:"吉祥寺",100:"新線新宿",101:"新宿三丁目",102:"曙橋",
  103:"市ヶ谷",104:"九段下",105:"神保町",106:"小川町",107:"岩本町",108:"馬喰横山",
  109:"浜町",110:"森下",111:"菊川",112:"住吉",113:"西大島",114:"大島",115:"東大島",
  116:"船堀",117:"一之江",118:"瑞江",119:"篠崎",120:"本八幡",
  300:"京王線新宿・都営新宿線方面",301:"都営新宿線方面",302:"京王線新宿方面",303:"調布方面",
  304:"高幡不動方面",305:"八幡山方面",306:"笹塚方面",400:"京王八王子方面",401:"高尾山口方面",
  402:"橋本方面",403:"府中・府中競馬正門前方面",501:"明大前・永福町方面",502:"吉祥寺方面"
};

const syMap = {
  1:{name:"特急", cls:"tokkyu"}, 2:{name:"急行", cls:"kyuko"}, 3:{name:"快速", cls:"kaisoku"},
  5:{name:"区間急行", cls:"kukan"}, 6:{name:"各停", cls:"kakutei"}, 9:{name:"ライナー", cls:"liner"},
  11:{name:"ライナー", cls:"linermt"}
};

/* --- 補助関数 --- */
function updownFromTrain(tr, stId) {
  const num = parseInt(tr.replace(/\D/g, ""), 10);
  if (!isNaN(num)) return (num % 2 === 0) ? "up" : "down";
  if (stId && stId.length > 1) {
    const n = parseInt(stId.slice(1), 10);
    if (!isNaN(n)) return (n % 2 === 0) ? "up" : "down";
  }
  return "up";
}

function skToLabel(sk) {
  const m = { "8":"8000", "9":"9000", "5":"5000", "2":"2000", "7":"7000", "0":"10-300" };
  return m[String(sk)] || "";
}

function classifyLineByIk(ik_tr) {
  const ikNum = parseInt(String(ik_tr).replace(/\D/g, ""), 10);
  return (ikNum >= 55 && ikNum <= 100) ? "inok" : "keio";
}

function posLabel(stId) {
  if (stId === "S016") return "京王多摩川〜調布間 上り";
  if (stId === "S031") return "京王片倉〜北野間 上り";
  if (stId === "D038") return "北野〜京王片倉間 下り";
  if (stId === "S021") return "東府中〜府中競馬正門前間 下り";
  if (stId === "S027") return "多摩動物公園〜高幡不動間 上り";
  if (stId === "D037") return "高幡不動〜多摩動物公園間 下り";
  if (stId === "D044") return "調布〜京王多摩川間 下り";
  if (stId === "S002") return "幡ヶ谷〜笹塚間 下り";
  if (stId === "U035") return "笹塚〜幡ヶ谷間 上り";
  if (!stId || stId.length < 2) return "不明";
  const kind = stId[0], n = parseInt(stId.slice(1), 10);
  if (isNaN(n)) return "不明";
  if (kind === "E") return idMap[n] || `#${n}`;
  if (kind === "U") return `${idMap[n + 1] || n + 1}〜${idMap[n] || n}間 上り`;
  if (kind === "D") return `${idMap[n] || n}〜${idMap[n - 1] || n - 1}間 下り`;
  return "不明";
}

/* --- 通知・ソート --- */
const NOTIF_KEY = "traffic_viewer_notifications_v1";
function loadNotifs(){ try{ return JSON.parse(localStorage.getItem(NOTIF_KEY)) || {expires:0,list:[]}; }catch(e){ return {expires:0,list:[]}; } }
function saveNotifs(obj){ localStorage.setItem(NOTIF_KEY, JSON.stringify(obj)); }
function addNotifUnique(type, text) {
  const obj = loadNotifs();
  if (!(obj.list || []).some(x => x.text === text)) {
    obj.list.push({ type, text, time: new Date().toLocaleTimeString("ja-JP", { hour12: false }) });
    obj.expires = new Date().setHours(25, 15, 0, 0); // 翌1:15
    saveNotifs(obj);
  }
}
function renderNotifs() {
  const out = document.getElementById("alertsInner"), obj = loadNotifs();
  if (!obj.list?.length) { out.textContent = "特記事項はありません。"; return; }
  out.innerHTML = "";
  obj.list.forEach(it => {
    const d = document.createElement("div");
    d.className = `alert-item ${it.type === "delay" ? "alert-delay" : "alert-exchange"}`;
    d.textContent = `${it.text} [${it.time}]`;
    out.appendChild(d);
  });
}

function bindSortable(table) {
  if (!table || table._bound) return;
  table.tHead.querySelectorAll("th").forEach((th, idx) => {
    th.addEventListener("click", () => {
      const asc = !th.classList.contains("sorted-asc");
      table.tHead.querySelectorAll("th").forEach(h => h.classList.remove("sorted-asc", "sorted-desc"));
      th.classList.add(asc ? "sorted-asc" : "sorted-desc");
      const rows = Array.from(table.tBodies[0].rows);
      rows.sort((a, b) => {
        if (th.dataset.key === "pos") {
          return (parseInt(a.dataset.trainId.slice(-3)) || 0) - (parseInt(b.dataset.trainId.slice(-3)) || 0) * (asc ? 1 : -1);
        }
        const A = a.cells[idx].innerText, B = b.cells[idx].innerText;
        return asc ? A.localeCompare(B, "ja", { numeric: true }) : B.localeCompare(A, "ja", { numeric: true });
      });
      rows.forEach(r => table.tBodies[0].appendChild(r));
    });
  });
  table._bound = true;
}

/* --- メイン処理 --- */
async function fetchAndRender() {
  try {
    const res = await fetch(FEED_URL + "?cache=" + Date.now());
    const data = await res.json();
    
    // Toei運用データの取得（任意）
    let toeiMap = {};
    try {
      const tRes = await fetch("toei.txt");
      if (tRes.ok) {
        const tText = await tRes.text();
        let cur = "";
        tText.split("\n").forEach(l => {
          l = l.trim();
          if (/^\d+[A-Z]$/.test(l)) cur = l;
          else if (l) l.split(",").forEach(id => toeiMap[id.trim()] = cur);
        });
      }
    } catch(e) {}

    // 更新時刻
    const t = data.up?.[0]?.dt?.[0];
    document.getElementById("updateTime").textContent = t ? `データ更新: ${t.yy}/${t.mt}/${t.dy} ${t.hh}:${t.mm}:${t.ss}` : "データ更新: —";

    // クリア
    const bodies = { "keio-up": document.querySelector("#keio-up tbody"), "keio-down": document.querySelector("#keio-down tbody"), "inok-up": document.querySelector("#inok-up tbody"), "inok-down": document.querySelector("#inok-down tbody") };
    Object.values(bodies).forEach(b => b.innerHTML = "");

    const trainCount = {};
    [...(data.TS || []), ...(data.TB || [])].forEach(st => (st.ps || []).forEach(p => { if(p.tr) trainCount[p.tr] = (trainCount[p.tr] || 0) + 1; }));

    [...(data.TS || []), ...(data.TB || [])].forEach(st => {
      (st.ps || []).forEach(p => {
        const trNo = (p.tr || "").trim();
        if (!trNo) return;

        const line = classifyLineByIk(p.ik_tr);
        const dir = updownFromTrain(trNo, st.id);
        const targetBody = bodies[`${line}-${dir}`];
        if (!targetBody) return;

        const sy = syMap[p.sy] || { name: "不明", cls: "" };
        const ikLabel = idMap[p.ik_tr] || "不明";
        const dlNum = parseInt(p.dl, 10) || 0;
        
        // 備考ロジック
        let remarks = [];
        if (sy.name === "特急" && p.sr === "8") remarks.push("特急(8両)");
        if (trainCount[trNo] > 1) { remarks.push("車両交換予定"); addNotifUnique("exchange", `${trNo}:車両交換予定`); }
        if (p.ik_tr >= 101 && p.ik_tr <= 120) remarks.push("都営直通");
        if (dlNum >= 15) addNotifUnique("delay", `${trNo}: ${dlNum}分遅れ`);

        const row = document.createElement("tr");
        row.dataset.trainId = st.id || "";
        const opLabel = toeiMap[trNo] ? `<span style="color:#00a;font-weight:bold;margin-right:4px;">${toeiMap[trNo]}</span>` : "";
        
        row.innerHTML = `
          <td>${skToLabel(p.sk) || "-"}</td>
          <td>${opLabel}${trNo}</td>
          <td>${ikLabel}</td>
          <td><span class="badge ${sy.cls}">${sy.name}</span></td>
          <td>${p.sr || ""}</td>
          <td>${posLabel(st.id)}</td>
          <td>${p.bs || ""}</td>
          <td>${dlNum === 0 ? "平常" : dlNum + "分遅れ"}</td>
          <td>${remarks.join("・")}</td>
        `;
        targetBody.appendChild(row);
      });
    });

    renderNotifs();
    Object.keys(bodies).forEach(id => bindSortable(document.getElementById(id)));

  } catch (err) {
    console.error(err);
  }
}

// 初期化イベント
document.addEventListener("DOMContentLoaded", () => {
  // タブ切り替え
  document.querySelectorAll(".tab-btn").forEach(btn => btn.addEventListener("click", () => {
    document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
    document.querySelectorAll(".line-block").forEach(lb => lb.style.display = "none");
    document.getElementById(btn.dataset.line).style.display = "block";
  }));
  
  // 上下切り替え
  document.querySelectorAll(".subtab").forEach(s => s.addEventListener("click", (e) => {
    const block = e.target.closest(".line-block");
    block.querySelectorAll(".subtab").forEach(x => x.classList.remove("active"));
    s.classList.add("active");
    block.querySelectorAll(".table-wrap").forEach(w => w.style.display = "none");
    block.querySelector(`#${block.id}-${s.dataset.dir}-wrap`).style.display = "block";
  }));

  // ダークモード
  const themeBtn = document.getElementById("themeBtn");
  themeBtn.addEventListener("click", () => {
    const isDark = document.documentElement.hasAttribute("data-theme");
    if(isDark) { document.documentElement.removeAttribute("data-theme"); themeBtn.textContent = "ダークモード：無効"; }
    else { document.documentElement.setAttribute("data-theme", "dark"); themeBtn.textContent = "ダークモード：有効"; }
  });

  fetchAndRender();
  setInterval(fetchAndRender, 30000);
  setInterval(() => {
    document.getElementById("localTime").textContent = "現在時刻: " + new Date().toLocaleTimeString("ja-JP");
  }, 1000);
});
</script>
</body>
</html>
